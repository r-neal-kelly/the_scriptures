var __awaiter=this&&this.__awaiter||function(i,t,r,s){return new(r||(r=Promise))((function(e,n){function u(i){try{h(s.next(i))}catch(i){n(i)}}function o(i){try{h(s.throw(i))}catch(i){n(i)}}function h(i){var t;i.done?e(i.value):(t=i.value,t instanceof r?t:new r((function(i){i(t)}))).then(u,o)}h((s=s.apply(i,t||[])).next())}))};import*as Utils from"./utils.js";import*as Execution from"./execution.js";import*as Unique_ID from"./unique_id.js";export{Type as Publication_Type}from"./execution.js";export class Publication_Info{constructor({type:i,data:t}){this.type=i,this.data=t,Object.freeze(this)}Type(){return this.type}Data(){return this.data}}export class Subscriber_Info{constructor({handler:i,priority:t}){this.handler=i,this.priority=t,Object.freeze(this)}Handler(){return this.handler}Priority(){return this.priority}}class Publisher{constructor(){this.subscribers={},this.priorities={},this.execution_frame=new Execution.Frame}Subscribe(i){const t=new Subscriber(i),r=Unique_ID.New(),s=t.Priority();return this.subscribers[r]=t,null==this.priorities[s]&&(this.priorities[s]=[]),this.priorities[s].push(t),r}Unsubscribe(i){0;const t=this.subscribers[i],r=t.Priority(),s=this.priorities[r];s[s.indexOf(t)]=s[s.length-1],s.pop(),0===s.length&&delete this.priorities[r],delete this.subscribers[i]}Publish(i){return __awaiter(this,void 0,void 0,(function*(){yield this.execution_frame.Execute(i.Type(),function(){return __awaiter(this,void 0,void 0,(function*(){const t=Object.keys(this.priorities).map((function(i){return"Infinity"===i?1/0:"-Infinity"===i?-1/0:parseInt(i)})).sort((function(i,t){return i-t}));for(const r of t)yield Promise.all(this.priorities[r].map((function(t){return __awaiter(this,void 0,void 0,(function*(){yield t.Handler()(i.Data())}))})))}))}.bind(this))}))}}class Subscriber{constructor(i){this.info=i,Object.freeze(this)}Handler(){return this.info.Handler()}Priority(){return this.info.Priority()}}export class Subscription{constructor(i,t){this.publisher_name=i,this.subscriber_id=t,Object.freeze(this)}Publisher_Name(){return this.publisher_name}Subscriber_ID(){return this.subscriber_id}}export class Instance{constructor(){this.publishers={}}Has_Publisher(i){return null!=this.publishers[i]}Publisher(i){return 0,this.publishers[i]}Maybe_Publisher(i){return this.publishers[i]}Some_Publisher(i){return this.Has_Publisher(i)||(this.publishers[i]=new Publisher),this.publishers[i]}Subscribe(i,t){return new Subscription(i,this.Some_Publisher(i).Subscribe(t))}Unsubscribe(i){this.Publisher(i.Publisher_Name()).Unsubscribe(i.Subscriber_ID())}Publish(i,t){return __awaiter(this,void 0,void 0,(function*(){const r=this.Maybe_Publisher(i);null!=r&&(yield r.Publish(t))}))}}