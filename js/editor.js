var Part_Class,Line_Event_Key,Direction,__awaiter=this&&this.__awaiter||function(t,e,n,i){return new(n||(n=Promise))((function(s,o){function r(t){try{d(i.next(t))}catch(t){o(t)}}function l(t){try{d(i.throw(t))}catch(t){o(t)}}function d(t){var e;t.done?s(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,l)}d((i=i.apply(t,e||[])).next())}))};import*as Utils from"./utils.js";import*as Unicode from"./unicode.js";import*as Model from"./model/text.js";function Escape_Text(t){return t.replaceAll(/./g,(function(t){if(" "===t)return`&#${" ".charCodeAt(0)};`;{const e=t.charCodeAt(0);return e<55296||e>57343?`&#${e};`:t}}))}function Text_Offset_To_Node(t,e){if(t===e)return 0;{let n=0;for(const i of t.childNodes){if(i===e)return n;if(i.contains(e))return n+Text_Offset_To_Node(i,e);i.textContent?n+=i.textContent.length:n+=0}return n}}function Text_Offset(t){const e=document.getSelection();return e?e.isCollapsed?e.anchorNode&&(e.anchorNode===t||t.contains(e.anchorNode))?Text_Offset_To_Node(t,e.anchorNode)+e.anchorOffset:null:e.anchorNode&&e.focusNode&&(e.anchorNode===t||t.contains(e.anchorNode))&&(e.focusNode===t||t.contains(e.focusNode))?e.anchorOffset<e.focusOffset?e.focusNode instanceof Text?Text_Offset_To_Node(t,e.focusNode)+e.focusOffset:e.focusNode.textContent?Text_Offset_To_Node(t,e.focusNode)+e.focusNode.textContent.length:Text_Offset_To_Node(t,e.focusNode):e.anchorNode instanceof Text?Text_Offset_To_Node(t,e.anchorNode)+e.anchorOffset:e.anchorNode.textContent?Text_Offset_To_Node(t,e.anchorNode)+e.anchorNode.textContent.length:Text_Offset_To_Node(t,e.anchorNode):null:null}function Set_Text_Offset(t,e){class n{constructor({node:t,offset:e}){this.node=t,this.offset=e}}t.focus();const i=document.getSelection();if(i){const s=function t(e,i,s=0){for(const o of e.childNodes)if(o instanceof Text){const t=o.textContent?o.textContent.length:0;if((s+=t)>=i)return new n({node:o,offset:i-(s-t)})}else{const e=t(o,i,s);if(e instanceof n)return e;s=e}return s}(t,e);s instanceof n?i.collapse(s.node,s.offset):i.collapse(t,s)}}function First_Part_Index(t){for(let e=0,n=t.children.length;e<n;){if(!t.children[e].classList.contains("COMMAND"))return e;e+=1}return null}function Last_Part_Index(t){for(let e=t.children.length,n=0;e>n;)if(e-=1,!t.children[e].classList.contains("COMMAND"))return e;return null}function Selected_Part(){const t=document.getSelection();if(t&&!t.isCollapsed&&null!=t.anchorNode&&null!=t.focusNode&&t.anchorNode===t.focusNode&&0===t.getRangeAt(0).startOffset&&1===t.getRangeAt(0).endOffset){if(t.anchorNode instanceof HTMLSpanElement){const e=t.anchorNode;if(null!=e.parentElement&&null!=e.textContent){const t=e.textContent.replaceAll(/ /g," ");if(""!==t){let n=Part_Class._NONE_;if(e.classList.contains("UNKNOWN_POINT")?n=Part_Class.UNKNOWN_POINT:e.classList.contains("KNOWN_LETTER")?n=Part_Class.KNOWN_LETTER:e.classList.contains("KNOWN_MARKER")?n=Part_Class.KNOWN_MARKER:e.classList.contains("UNKNOWN_WORD")?n=Part_Class.UNKNOWN_WORD:e.classList.contains("KNOWN_WORD")?n=Part_Class.KNOWN_WORD:e.classList.contains("UNKNOWN_BREAK")?n=Part_Class.UNKNOWN_BREAK:e.classList.contains("KNOWN_BREAK")?n=Part_Class.KNOWN_BREAK:e.classList.contains("KNOWN_WORD_ERROR")?n=Part_Class.KNOWN_WORD_ERROR:e.classList.contains("KNOWN_BREAK_ERROR")&&(n=Part_Class.KNOWN_BREAK_ERROR),n!==Part_Class._NONE_){const i=Array.from(e.parentElement.children).indexOf(e);let s=Model.Dictionary.Boundary.MIDDLE;return i===First_Part_Index(e.parentElement)?s=Model.Dictionary.Boundary.START:i===Last_Part_Index(e.parentElement)&&(s=Model.Dictionary.Boundary.END),{text:t,class:n,boundary:s}}return null}return null}return null}return null}return null}!function(t){t[t._NONE_=-1]="_NONE_",t[t.UNKNOWN_POINT=0]="UNKNOWN_POINT",t[t.KNOWN_LETTER=1]="KNOWN_LETTER",t[t.KNOWN_MARKER=2]="KNOWN_MARKER",t[t.UNKNOWN_WORD=3]="UNKNOWN_WORD",t[t.KNOWN_WORD=4]="KNOWN_WORD",t[t.UNKNOWN_BREAK=5]="UNKNOWN_BREAK",t[t.KNOWN_BREAK=6]="KNOWN_BREAK",t[t.KNOWN_WORD_ERROR=7]="KNOWN_WORD_ERROR",t[t.KNOWN_BREAK_ERROR=8]="KNOWN_BREAK_ERROR"}(Part_Class||(Part_Class={})),function(t){t.LETTER="Home",t.MARKER="PageUp",t.WORD="PageDown",t.BREAK="End",t.ERROR="Delete",t.WORD_ERROR="Pause",t.BREAK_ERROR="Insert"}(Line_Event_Key||(Line_Event_Key={}));class Line{constructor({editor:t,parent:e}){this.editor=t,this.parent=e,this.element=document.createElement("div"),this.children={},this.element.setAttribute("contentEditable","true"),this.element.setAttribute("spellcheck","false"),this.element.setAttribute("style",`\n                display: flex;\n                flex-wrap: wrap;\n                justify-content: center;\n\n                width: 100%;\n                padding: 2px;\n\n                border-width: 0 0 1px 0;\n                border-style: solid;\n                border-color: #3B3A32;\n\n                direction: ${t.Direction()===Direction.LEFT_TO_RIGHT?"ltr":"rtl"};\n            `),this.element.addEventListener("keydown",function(t){if("Enter"===t.key){t.preventDefault();const e=document.getSelection();if(e){const t=this.Text();let n,i;if(e.isCollapsed){Utils.Assert(null!==e.anchorNode);const s=Text_Offset_To_Node(this.Element(),e.anchorNode)+e.anchorOffset;n=t.slice(0,s),i=t.slice(s,t.length)}else{let s,o,r,l;Utils.Assert(null!==e.anchorNode),Utils.Assert(null!==e.focusNode),e.anchorOffset<e.focusOffset?(s=e.anchorNode,o=e.anchorOffset,r=e.focusNode,l=e.focusOffset):(s=e.focusNode,o=e.focusOffset,r=e.anchorNode,l=e.anchorOffset);const d=this.Element(),a=Text_Offset_To_Node(d,s)+o,c=Text_Offset_To_Node(d,r)+l;n=t.slice(0,a),i=t.slice(c,t.length)}const s=this.Index();this.Set_Text(n),this.Editor().Insert_Line(s+1,i),this.Editor().Line(s+1).Element().focus()}}else if("Backspace"===t.key){const e=document.getSelection();if(e){const n=this.Index(),i=Text_Offset(this.element);if(n>0&&e.isCollapsed&&0===i){t.preventDefault();const e=this.Editor().Line(n-1),i=e.Text();e.Set_Text(`${i}${this.Text()}`),this.Editor().Remove_Line(n),Set_Text_Offset(e.Element(),i.length)}}}else if("ArrowUp"===t.key){if(t.preventDefault(),!this.Editor().Is_Meta_Key_Active()){if(document.getSelection()){const t=this.Index();if(t>0){const e=Text_Offset(this.element),n=this.Editor().Line(t-1),i=n.Text();Set_Text_Offset(n.Element(),i.length<e?i.length:e)}}}}else if("ArrowDown"===t.key){if(t.preventDefault(),!this.Editor().Is_Meta_Key_Active()){if(document.getSelection()){const t=this.Index();if(t<this.Editor().Line_Count()-1){const e=Text_Offset(this.element),n=this.Editor().Line(t+1),i=n.Text();Set_Text_Offset(n.Element(),i.length<e?i.length:e)}}}}else if("ArrowLeft"===t.key){const e=document.getSelection();if(e&&!e.isCollapsed&&e.anchorNode&&e.focusNode&&e.anchorNode===e.focusNode){t.preventDefault();const n=this.Element(),i=Array.from(n.children).indexOf(e.anchorNode);i>0&&(e.getRangeAt(0).setStart(n.children[i-1],0),e.getRangeAt(0).setEnd(n.children[i-1],1))}else{const e=Text_Offset(this.Element());if(null!=e&&(t.preventDefault(),e>0)){const t=this.Text()[e-1].charCodeAt(0);Set_Text_Offset(this.Element(),t>=56320&&t<=57343?Math.max(0,e-2):e-1)}}}else if("ArrowRight"===t.key){const e=document.getSelection();if(e&&!e.isCollapsed&&e.anchorNode&&e.focusNode&&e.anchorNode===e.focusNode){t.preventDefault();const n=this.Element(),i=Array.from(n.children).indexOf(e.anchorNode);i>=0&&i<n.children.length-1&&(e.getRangeAt(0).setStart(n.children[i+1],0),e.getRangeAt(0).setEnd(n.children[i+1],1))}else{const e=Text_Offset(this.Element());if(null!=e){t.preventDefault();const n=this.Text();if(e+2<=n.length){const t=n[e+1].charCodeAt(0);Set_Text_Offset(this.Element(),t>=56320&&t<=57343?e+2:e+1)}else e<n.length&&Set_Text_Offset(this.Element(),e+1)}}}else if(t.key===Line_Event_Key.LETTER){if(t.preventDefault(),this.Editor().Is_Meta_Key_Active()){const t=Selected_Part();t&&(t.class===Part_Class.UNKNOWN_POINT?(this.Editor().Dictionary().Add_Letter(t.text),this.Editor().Touch()):t.class===Part_Class.KNOWN_LETTER?(this.Editor().Dictionary().Remove_Letter(t.text),this.Editor().Touch()):t.class!==Part_Class.UNKNOWN_WORD&&t.class!==Part_Class.KNOWN_WORD||Unicode.Is_Point(t.text)&&(this.Editor().Dictionary().Remove_Letter(t.text),this.Editor().Touch()))}}else if(t.key===Line_Event_Key.MARKER){if(t.preventDefault(),this.Editor().Is_Meta_Key_Active()){const t=Selected_Part();t&&(t.class===Part_Class.UNKNOWN_POINT?(this.Editor().Dictionary().Add_Marker(t.text),this.Editor().Touch()):t.class===Part_Class.KNOWN_MARKER?(this.Editor().Dictionary().Remove_Marker(t.text),this.Editor().Touch()):t.class!==Part_Class.UNKNOWN_BREAK&&t.class!==Part_Class.KNOWN_BREAK||Unicode.Is_Point(t.text)&&(this.Editor().Dictionary().Remove_Marker(t.text),this.Editor().Touch()))}}else if(t.key===Line_Event_Key.WORD){if(t.preventDefault(),this.Editor().Is_Meta_Key_Active()){const t=Selected_Part();t&&(t.class===Part_Class.UNKNOWN_WORD?(this.Editor().Dictionary().Add_Word(t.text),this.Editor().Touch()):t.class===Part_Class.KNOWN_WORD?(this.Editor().Dictionary().Remove_Word(t.text),this.Editor().Touch()):t.class===Part_Class.KNOWN_WORD_ERROR&&(this.Editor().Dictionary().Remove_Word_Error(t.text),this.Editor().Dictionary().Add_Word(t.text),this.Editor().Touch()))}}else if(t.key===Line_Event_Key.BREAK){if(t.preventDefault(),this.Editor().Is_Meta_Key_Active()){const t=Selected_Part();t&&(t.class===Part_Class.UNKNOWN_BREAK?(this.Editor().Dictionary().Add_Break(t.text,t.boundary),this.Editor().Touch()):t.class===Part_Class.KNOWN_BREAK?(this.Editor().Dictionary().Remove_Break(t.text,t.boundary),this.Editor().Touch()):t.class===Part_Class.KNOWN_BREAK_ERROR&&(this.Editor().Dictionary().Remove_Break_Error(t.text,t.boundary),this.Editor().Dictionary().Add_Break(t.text,t.boundary),this.Editor().Touch()))}}else if(t.key===Line_Event_Key.ERROR){if(this.Editor().Is_Meta_Key_Active()){t.preventDefault();const e=Selected_Part();e&&(e.class===Part_Class.UNKNOWN_WORD?(this.Editor().Dictionary().Add_Word_Error(e.text),this.Editor().Touch()):e.class===Part_Class.KNOWN_WORD?(this.Editor().Dictionary().Remove_Word(e.text),this.Editor().Dictionary().Add_Word_Error(e.text),this.Editor().Touch()):e.class===Part_Class.UNKNOWN_BREAK?(this.Editor().Dictionary().Add_Break_Error(e.text,e.boundary),this.Editor().Touch()):e.class===Part_Class.KNOWN_BREAK?(this.Editor().Dictionary().Remove_Break(e.text,e.boundary),this.Editor().Dictionary().Add_Break_Error(e.text,e.boundary),this.Editor().Touch()):e.class===Part_Class.KNOWN_WORD_ERROR?(this.Editor().Dictionary().Remove_Word_Error(e.text),this.Editor().Touch()):e.class===Part_Class.KNOWN_BREAK_ERROR&&(this.Editor().Dictionary().Remove_Break_Error(e.text,e.boundary),this.Editor().Touch()))}}else if(t.key===Line_Event_Key.WORD_ERROR){if(this.Editor().Is_Meta_Key_Active()){t.preventDefault();const e=Selected_Part();e&&(e.class===Part_Class.UNKNOWN_POINT||e.class===Part_Class.UNKNOWN_WORD?(this.Editor().Dictionary().Add_Word_Error(e.text),this.Editor().Touch()):e.class===Part_Class.KNOWN_WORD?(this.Editor().Dictionary().Remove_Word(e.text),this.Editor().Dictionary().Add_Word_Error(e.text),this.Editor().Touch()):e.class===Part_Class.KNOWN_WORD_ERROR&&(this.Editor().Dictionary().Remove_Word_Error(e.text),this.Editor().Touch()))}}else if(t.key===Line_Event_Key.BREAK_ERROR&&this.Editor().Is_Meta_Key_Active()){t.preventDefault();const e=Selected_Part();e&&(e.class===Part_Class.UNKNOWN_POINT||e.class===Part_Class.UNKNOWN_BREAK?(this.Editor().Dictionary().Add_Break_Error(e.text,e.boundary),this.Editor().Touch()):e.class===Part_Class.KNOWN_BREAK?(this.Editor().Dictionary().Remove_Break(e.text,e.boundary),this.Editor().Dictionary().Add_Break_Error(e.text,e.boundary),this.Editor().Touch()):e.class===Part_Class.KNOWN_BREAK_ERROR&&(this.Editor().Dictionary().Remove_Break_Error(e.text,e.boundary),this.Editor().Touch()))}}.bind(this)),this.element.addEventListener("input",function(t){const e=t;if("insertText"===e.inputType||"deleteContentBackward"===e.inputType||"insertFromPaste"===e.inputType){const t=Text_Offset(this.element);this.Touch(),Set_Text_Offset(this.element,t)}}.bind(this)),this.element.addEventListener("dblclick",function(t){const e=document.getSelection();if(e){e.rangeCount<1&&e.addRange(document.createRange());let n=this.Element();for(const e of this.Element().children){const i=e.getBoundingClientRect();if(t.clientX>=i.left&&t.clientX<=i.right&&t.clientY>=i.top&&t.clientY<=i.bottom){n=e;break}}n===this.Element()?(e.getRangeAt(0).setStart(n,0),e.getRangeAt(0).setEnd(n,n.children.length)):(e.getRangeAt(0).setStart(n,0),e.getRangeAt(0).setEnd(n,1))}}.bind(this)),this.parent.appendChild(this.element)}Destruct(){this.parent.removeChild(this.element)}Editor(){return this.editor}Parent(){return this.parent}Element(){return this.element}Index(){const t=this.Editor().Lines().indexOf(this);return Utils.Assert(t>-1),t}Text(){return this.element.textContent?this.element.textContent.replaceAll(/ /g," "):""}Set_Text(t){if(this.Editor().Is_In_Point_Mode())this.element.innerHTML=this.Treat_As_Points(t),this.element.style.display="block";else{const e=this.Treat(t);this.element.innerHTML=e.html,e.is_centered?this.element.style.display="flex":this.element.style.display="block"}}Touch(){const t=Text_Offset(this.Element());this.Set_Text(this.Text()),this.Editor().Direction()===Direction.LEFT_TO_RIGHT?this.Element().style.direction="ltr":this.Element().style.direction="rtl",t&&Set_Text_Offset(this.Element(),t)}Treat(t){const e=new Model.Instance({dictionary:this.Editor().Dictionary(),value:t});Utils.Assert(1===e.Line_Count(),"model's line count should be 1.");const n=e.Line(0);let i="";for(let t=0,e=n.Macro_Part_Count();t<e;t+=1){const e=n.Macro_Part(t);if(e.Is_Command()){const t=e;let n="";t.Is_Indent()&&(n+=" INDENT"),t.Is_Good()?i+=`<span class="COMMAND${n}">${Escape_Text(t.Value())}</span>`:i+=`<span class="BAD_COMMAND${n}">${Escape_Text(t.Value())}</span>`}else{let t="";e.Has_Italic_Style()&&(t+=" ITALIC"),e.Has_Bold_Style()&&(t+=" BOLD"),e.Has_Underline_Style()&&(t+=" UNDERLINE"),e.Has_Small_Caps_Style()&&(t+=" SMALL_CAPS"),e.Has_Error_Style()&&(t+=" ERROR"),e.Is_Point()?i+=`<span class="UNKNOWN_POINT${t}">${Escape_Text(e.Value())}</span>`:e.Is_Word()?e.Is_Good()?i+=`<span class="KNOWN_WORD${t}">${Escape_Text(e.Value())}</span>`:e.Is_Error()?i+=`<span class="KNOWN_WORD_ERROR${t}">${Escape_Text(e.Value())}</span>`:e.Is_Unknown()?i+=`<span class="UNKNOWN_WORD${t}">${Escape_Text(e.Value())}</span>`:Utils.Assert(!1,"unknown part state."):e.Is_Break()?e.Is_Good()?i+=`<span class="KNOWN_BREAK${t}">${Escape_Text(e.Value())}</span>`:e.Is_Error()?i+=`<span class="KNOWN_BREAK_ERROR${t}">${Escape_Text(e.Value())}</span>`:e.Is_Unknown()?i+=`<span class="UNKNOWN_BREAK${t}">${Escape_Text(e.Value())}</span>`:Utils.Assert(!1,"unknown part state."):Utils.Assert(!1,"invalid macro part.")}}return{html:i,is_centered:n.Is_Centered()}}Treat_As_Points(t){const e=new Model.Instance({dictionary:this.Editor().Dictionary(),value:t});Utils.Assert(1===e.Line_Count(),"model's line count should be 1.");const n=e.Line(0);let i="";for(let t=0,e=n.Micro_Part_Count();t<e;t+=1){const e=n.Micro_Part(t);if(e.Is_Command()){let t=new Unicode.Iterator({text:e.Value(),index:0});for(;!t.Is_At_End();t=t.Next())i+=`<span class="COMMAND SEPARATE_POINT">${Escape_Text(t.Point())}</span>`}else e.Is_Letter()?i+=`<span class="KNOWN_LETTER SEPARATE_POINT">${Escape_Text(e.Value())}</span>`:e.Is_Marker()?i+=`<span class="KNOWN_MARKER SEPARATE_POINT">${Escape_Text(e.Value())}</span>`:e.Is_Point()?i+=`<span class="UNKNOWN_POINT SEPARATE_POINT">${Escape_Text(e.Value())}</span>`:Utils.Assert(!1,"invalid micro part.")}return i}}!function(t){t[t.LEFT_TO_RIGHT=0]="LEFT_TO_RIGHT",t[t.RIGHT_TO_LEFT=1]="RIGHT_TO_LEFT"}(Direction||(Direction={}));class Editor{constructor({parent:t}){const e="\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            justify-self: center;\n\n            width: 100%;\n            padding: 2px;\n\n            border-width: 2px;\n            border-style: solid;\n            border-color: #3B3A32;\n\n            cursor: pointer;\n            user-select: none;\n        ";this.is_meta_key_active=!1,this.is_in_point_mode=!1,this.direction=Direction.LEFT_TO_RIGHT,this.parent=t,this.element=document.createElement("div"),this.children={controls:document.createElement("div"),dictionary_label:document.createElement("div"),dictionary_new_button:document.createElement("div"),dictionary_load_input:document.createElement("input"),dictionary_load_button:document.createElement("div"),dictionary_save_button:document.createElement("div"),dictionary_name:document.createElement("div"),file_label:document.createElement("div"),file_new_button:document.createElement("div"),file_load_input:document.createElement("input"),file_load_button:document.createElement("div"),file_save_button:document.createElement("div"),file_name:document.createElement("div"),lines:document.createElement("div")},this.element.setAttribute("style","\n                display: flex;\n                flex-direction: column;\n                justify-content: center;\n                align-items: center;\n\n                position: relative;\n\n                height: 100%;\n                width: 100%;\n                padding: 7px 7px 0 7px;\n\n                border-width: 0;\n\n                background-color: #0f1318;\n                color: #E0ECFF;\n\n                overflow-y: auto;\n            "),this.element.addEventListener("keydown",function(t){const e=t;"Escape"===e.key?(t.preventDefault(),this.is_meta_key_active=!0):"ArrowLeft"===e.key?this.Is_Meta_Key_Active()&&this.Set_Direction(Direction.RIGHT_TO_LEFT):"ArrowRight"===e.key?this.Is_Meta_Key_Active()&&this.Set_Direction(Direction.LEFT_TO_RIGHT):"ArrowDown"===e.key?this.Is_Meta_Key_Active()&&(this.is_in_point_mode=!0,this.Touch()):"ArrowUp"===e.key?this.Is_Meta_Key_Active()&&(this.is_in_point_mode=!1,this.Touch()):"`"===e.key?this.Is_Meta_Key_Active()&&(e.preventDefault(),this.Highlight_Next_Class(["UNKNOWN_POINT","UNKNOWN_WORD","UNKNOWN_BREAK"])):"1"===e.key?this.Is_Meta_Key_Active()&&(e.preventDefault(),this.Highlight_Next_Class(["KNOWN_WORD_ERROR","KNOWN_BREAK_ERROR","BAD_COMMAND"])):"~"===e.key?this.Is_Meta_Key_Active()&&(e.preventDefault(),this.Highlight_Next(["⸨err⸩","⸨/err⸩"])):"!"===e.key?this.Is_Meta_Key_Active()&&(e.preventDefault(),this.Highlight_Next(["⸨b⸩","⸨/b⸩"])):")"===e.key?this.Is_Meta_Key_Active()&&(e.preventDefault(),document.body.style.fontFamily="sans-serif",document.body.style.fontSize="24px"):"("===e.key?this.Is_Meta_Key_Active()&&(e.preventDefault(),document.body.style.fontFamily="Ezra SIL SR",document.body.style.fontSize="30px"):"*"===e.key?this.Is_Meta_Key_Active()&&(e.preventDefault(),document.body.style.fontFamily="Gentium Plus",document.body.style.fontSize="32px"):"&"===e.key&&this.Is_Meta_Key_Active()&&(e.preventDefault(),document.body.style.fontFamily="Gentium Plus",document.body.style.fontSize="26px")}.bind(this)),this.element.addEventListener("keyup",function(t){"Escape"===t.key&&(t.preventDefault(),this.is_meta_key_active=!1)}.bind(this)),this.children.controls.setAttribute("style","\n                display: grid;\n                grid-template-columns: 1fr 1fr 1fr 1fr 1fr;\n                grid-template-rows: 1fr 1fr;\n                grid-gap: 3px;\n\n                width: 100%;\n                padding: 2px 0;\n\n                font-size: 16px;\n            "),this.children.dictionary_label.setAttribute("style","\n                font-size: 24px;\n\n                user-select: none;\n            "),this.children.dictionary_label.textContent="Dictionary:",this.children.dictionary_name.setAttribute("contentEditable","true"),this.children.dictionary_name.setAttribute("spellcheck","true"),this.children.dictionary_name.setAttribute("style","\n                padding: 2px;\n\n                font-size: 22px;\n                direction: ltr;\n            "),this.children.dictionary_name.addEventListener("keydown",function(t){"Enter"===t.key&&t.preventDefault()}.bind(this)),this.children.dictionary_name.addEventListener("input",function(t){const e=t;if("insertText"===e.inputType||"deleteContentBackward"===e.inputType||"insertFromPaste"===e.inputType){const t=Text_Offset(this.children.dictionary_name);this.Set_Dictionary_Name(this.Dictionary_Name()),Set_Text_Offset(this.children.dictionary_name,t)}}.bind(this)),this.children.dictionary_new_button.setAttribute("style",e),this.children.dictionary_new_button.innerHTML="<div>New</div>",this.children.dictionary_new_button.addEventListener("click",function(t){return __awaiter(this,void 0,void 0,(function*(){((null===this.saved_dictionary?this.Dictionary().To_JSON()===new Model.Dictionary.Instance({}).To_JSON():this.saved_dictionary===this.Dictionary().To_JSON())||(yield this.Try_To_Save_Dictionary()))&&(this.Set_Dictionary_Name("New Dictionary"),this.dictionary=new Model.Dictionary.Instance({}),this.Touch(),this.saved_dictionary=null)}))}.bind(this)),this.children.dictionary_load_input.setAttribute("type","file"),this.children.dictionary_load_input.setAttribute("accept",".json"),this.children.dictionary_load_input.setAttribute("style","\n                display: none;\n            "),this.children.dictionary_load_input.addEventListener("input",function(t){return __awaiter(this,void 0,void 0,(function*(){if(this.children.dictionary_load_input.files&&this.children.dictionary_load_input.files[0]){const t=this.children.dictionary_load_input.files[0],e=yield t.text();this.Set_Dictionary_Name(t.name.replace(/\.[^.]+$/,"")),this.Set_Dictionary_JSON(e),this.children.dictionary_load_input.value="",this.saved_dictionary=this.Dictionary().To_JSON()}}))}.bind(this)),this.children.dictionary_load_button.setAttribute("style",e),this.children.dictionary_load_button.innerHTML="<div>Load</div>",this.children.dictionary_load_button.addEventListener("click",function(t){return __awaiter(this,void 0,void 0,(function*(){((null===this.saved_dictionary?this.Dictionary().To_JSON()===new Model.Dictionary.Instance({}).To_JSON():this.saved_dictionary===this.Dictionary().To_JSON())||(yield this.Try_To_Save_Dictionary()))&&this.children.dictionary_load_input.click()}))}.bind(this)),this.children.dictionary_save_button.setAttribute("style",e),this.children.dictionary_save_button.innerHTML="<div>Save</div>",this.children.dictionary_save_button.addEventListener("click",function(t){this.Save_Dictionary()}.bind(this)),this.children.file_label.setAttribute("style","\n                font-size: 24px;\n\n                user-select: none;\n            "),this.children.file_label.textContent="File:",this.children.file_name.setAttribute("contentEditable","true"),this.children.file_name.setAttribute("spellcheck","true"),this.children.file_name.setAttribute("style","\n                padding: 2px;\n\n                font-size: 22px;\n                direction: ltr;\n            "),this.children.file_name.addEventListener("keydown",function(t){"Enter"===t.key&&t.preventDefault()}.bind(this)),this.children.file_name.addEventListener("input",function(t){const e=t;if("insertText"===e.inputType||"deleteContentBackward"===e.inputType||"insertFromPaste"===e.inputType){const t=Text_Offset(this.children.file_name);this.Set_File_Name(this.File_Name()),Set_Text_Offset(this.children.file_name,t)}}.bind(this)),this.children.file_new_button.setAttribute("style",e),this.children.file_new_button.innerHTML="<div>New</div>",this.children.file_new_button.addEventListener("click",function(t){return __awaiter(this,void 0,void 0,(function*(){((null===this.saved_file?""===this.Text():this.saved_file===this.Text())||(yield this.Try_To_Save_File()))&&(this.Set_File_Name("New File"),this.Clear_Text(),this.Touch(),this.saved_file=null)}))}.bind(this)),this.children.file_load_input.setAttribute("type","file"),this.children.file_load_input.setAttribute("accept",".txt"),this.children.file_load_input.setAttribute("style","\n                display: none;\n            "),this.children.file_load_input.addEventListener("input",function(t){return __awaiter(this,void 0,void 0,(function*(){if(this.children.file_load_input.files&&this.children.file_load_input.files[0]){const t=this.children.file_load_input.files[0],e=yield t.text();this.Set_File_Name(t.name.replace(/\.[^.]+$/,"")),this.Set_Text(e),this.children.file_load_input.value="",this.saved_file=this.Text(),Utils.Assert(this.Text()===e.replaceAll(/\r/g,""))}}))}.bind(this)),this.children.file_load_button.setAttribute("style",e),this.children.file_load_button.innerHTML="<div>Load</div>",this.children.file_load_button.addEventListener("click",function(t){return __awaiter(this,void 0,void 0,(function*(){((null===this.saved_file?""===this.Text():this.saved_file===this.Text())||(yield this.Try_To_Save_File()))&&this.children.file_load_input.click()}))}.bind(this)),this.children.file_save_button.setAttribute("style",e),this.children.file_save_button.innerHTML="<div>Save</div>",this.children.file_save_button.addEventListener("click",function(t){this.Save_Text()}.bind(this)),this.children.lines.setAttribute("style","\n                display: flex;\n                flex-direction: column;\n                justify-content: start;\n                align-items: start;\n                \n                width: 100%;\n                height: 90%;\n                padding: 2px;\n\n                border-width: 2px;\n                border-style: none;\n                border-color: #3B3A32;\n\n                overflow-y: auto;\n            "),this.dictionary=new Model.Dictionary.Instance({}),this.lines=[],this.children.controls.appendChild(this.children.dictionary_label),this.children.controls.appendChild(this.children.dictionary_name),this.children.controls.appendChild(this.children.dictionary_new_button),this.children.controls.appendChild(this.children.dictionary_load_button),this.children.controls.appendChild(this.children.dictionary_save_button),this.children.controls.appendChild(this.children.file_label),this.children.controls.appendChild(this.children.file_name),this.children.controls.appendChild(this.children.file_new_button),this.children.controls.appendChild(this.children.file_load_button),this.children.controls.appendChild(this.children.file_save_button),this.element.appendChild(this.children.controls),this.element.appendChild(this.children.lines),this.parent.appendChild(this.element),this.Set_Dictionary_Name("New Dictionary"),this.Set_File_Name("New File"),this.Add_Line(""),this.saved_dictionary=null,this.saved_file=null}Parent(){return this.parent}Element(){return this.element}Dictionary(){return this.dictionary}Dictionary_Name(){return this.children.dictionary_name.textContent?this.children.dictionary_name.textContent.replaceAll(/ /g," "):""}Set_Dictionary_Name(t){this.children.dictionary_name.innerHTML=Escape_Text(t)}Dictionary_JSON(){return this.Dictionary().To_JSON()}Set_Dictionary_JSON(t){this.dictionary=new Model.Dictionary.Instance({json:t}),this.Touch()}Save_Dictionary(){const t=this.Dictionary_JSON(),e=this.Dictionary_Name(),n=new File([t],`${e}.json`),i=URL.createObjectURL(n),s=document.createElement("a");s.href=i,s.download=`${e}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),this.saved_dictionary=t}Try_To_Save_Dictionary(){return __awaiter(this,void 0,void 0,(function*(){return yield new Promise(function(t,e){const n=document.createElement("div");n.setAttribute("style","\n                        display: flex;\n                        flex-direction: column;\n                        justify-content: center;\n                        align-items: center;\n\n                        position: absolute;\n                        left: 0;\n                        top: 0;\n                        z-index: 1;\n\n                        width: 100%;\n                        height: 100%;\n\n                        background-color: rgba(0, 0, 0, 0.7);\n\n                        font-size: 18px;\n                    ");const i=document.createElement("div");i.setAttribute("style","\n                        width: 67%;\n                        margin: 2px;\n                        padding: 7px;\n\n                        background-color: #0f1318;\n\n                        color: #E0ECFF;\n                        text-align: center;\n                    "),i.innerHTML="<div>\n                    There are unsaved changes to the current dictionary.\n                </div>";const s=document.createElement("div");s.setAttribute("style","\n                        display: grid;\n                        grid-template-columns: 1fr;\n                        grid-template-rows: 1fr 1fr 1fr;\n                        grid-gap: 12px;\n\n                        width: 67%;\n                        padding: 7px;\n\n                        background-color: #0f1318;\n\n                        color: #E0ECFF;\n                    ");const o="\n                    display: flex;\n                    justify-content: center;\n                    align-items: center;\n\n                    border-width: 2px;\n                    border-style: solid;\n                    border-color: #3B3A32;\n\n                    cursor: pointer;\n                    user-select: none;\n                ",r=document.createElement("div");r.setAttribute("style",o),r.innerHTML="<div>Save Changes</div>",r.addEventListener("click",function(e){this.Save_Dictionary(),document.body.removeChild(n),t(!0)}.bind(this));const l=document.createElement("div");l.setAttribute("style",o),l.innerHTML="<div>Discard Changes</div>",l.addEventListener("click",function(e){document.body.removeChild(n),t(!0)}.bind(this));const d=document.createElement("div");d.setAttribute("style",o),d.innerHTML="<div>Cancel</div>",d.addEventListener("click",function(e){document.body.removeChild(n),t(!1)}.bind(this)),s.appendChild(r),s.appendChild(l),s.appendChild(d),n.appendChild(i),n.appendChild(s),document.body.appendChild(n)}.bind(this))}))}File_Name(){return this.children.file_name.textContent?this.children.file_name.textContent.replaceAll(/ /g," "):""}Set_File_Name(t){this.children.file_name.innerHTML=Escape_Text(t)}Text(){return this.lines.map((function(t){return t.Text()})).join("\n")}Set_Text(t){this.Clear_Text();const e=t.split(/\r?\n/);for(const t of e)this.Add_Line(t);this.Remove_Line(0)}Save_Text(){const t=this.Text(),e=this.File_Name(),n=new File([t],`${e}.txt`),i=URL.createObjectURL(n),s=document.createElement("a");s.href=i,s.download=`${e}.txt`,document.body.appendChild(s),s.click(),document.body.removeChild(s),this.saved_file=t}Try_To_Save_File(){return __awaiter(this,void 0,void 0,(function*(){return yield new Promise(function(t,e){const n=document.createElement("div");n.setAttribute("style","\n                        display: flex;\n                        flex-direction: column;\n                        justify-content: center;\n                        align-items: center;\n\n                        position: absolute;\n                        left: 0;\n                        top: 0;\n                        z-index: 1;\n\n                        width: 100%;\n                        height: 100%;\n\n                        background-color: rgba(0, 0, 0, 0.7);\n\n                        font-size: 18px;\n                    ");const i=document.createElement("div");i.setAttribute("style","\n                        width: 67%;\n                        margin: 2px;\n                        padding: 7px;\n\n                        background-color: #0f1318;\n\n                        color: #E0ECFF;\n                        text-align: center;\n                    "),i.innerHTML="<div>\n                    There are unsaved changes to the current file.\n                </div>";const s=document.createElement("div");s.setAttribute("style","\n                        display: grid;\n                        grid-template-columns: 1fr;\n                        grid-template-rows: 1fr 1fr 1fr;\n                        grid-gap: 12px;\n\n                        width: 67%;\n                        padding: 7px;\n\n                        background-color: #0f1318;\n\n                        color: #E0ECFF;\n                    ");const o="\n                    display: flex;\n                    justify-content: center;\n                    align-items: center;\n\n                    border-width: 2px;\n                    border-style: solid;\n                    border-color: #3B3A32;\n\n                    cursor: pointer;\n                    user-select: none;\n                ",r=document.createElement("div");r.setAttribute("style",o),r.innerHTML="<div>Save Changes</div>",r.addEventListener("click",function(e){this.Save_Text(),document.body.removeChild(n),t(!0)}.bind(this));const l=document.createElement("div");l.setAttribute("style",o),l.innerHTML="<div>Discard Changes</div>",l.addEventListener("click",function(e){document.body.removeChild(n),t(!0)}.bind(this));const d=document.createElement("div");d.setAttribute("style",o),d.innerHTML="<div>Cancel</div>",d.addEventListener("click",function(e){document.body.removeChild(n),t(!1)}.bind(this)),s.appendChild(r),s.appendChild(l),s.appendChild(d),n.appendChild(i),n.appendChild(s),document.body.appendChild(n)}.bind(this))}))}Clear_Text(){for(const t of this.lines)t.Destruct();this.lines=[],this.Add_Line("")}Line_Count(){return this.lines.length}Lines(){return Array.from(this.lines)}Line(t){return Utils.Assert(t>=0),Utils.Assert(t<this.lines.length),this.lines[t]}Add_Line(t){const e=new Line({editor:this,parent:this.children.lines});this.lines.push(e),e.Set_Text(t)}Remove_Line(t){Utils.Assert(t>0||this.lines.length>1),Utils.Assert(t<this.lines.length),this.lines.splice(t,1)[0].Destruct()}Insert_Line(t,e){Utils.Assert(t>=0),Utils.Assert(t<=this.lines.length);for(let e=t,n=this.lines.length;e<n;e+=1){const t=this.lines[e];t.Parent().removeChild(t.Element())}const n=new Line({editor:this,parent:this.children.lines});this.lines.splice(t,0,n),n.Set_Text(e);for(let e=t+1,n=this.lines.length;e<n;e+=1){const t=this.lines[e];t.Parent().appendChild(t.Element())}}Touch(){this.Set_Dictionary_Name(this.Dictionary_Name()),this.Set_File_Name(this.File_Name()),this.Direction()===Direction.LEFT_TO_RIGHT?(this.children.dictionary_name.style.direction="ltr",this.children.file_name.style.direction="ltr"):(this.children.dictionary_name.style.direction="rtl",this.children.file_name.style.direction="rtl");for(const t of this.lines)t.Touch()}Is_Meta_Key_Active(){return this.is_meta_key_active}Is_In_Point_Mode(){return this.is_in_point_mode}Direction(){return this.direction}Set_Direction(t){this.direction=t,this.Touch()}Highlight_Next(t){const e=this.Focused_Line_Index(),n=document.getSelection();if(null!=e&&null!=n&&!n.isCollapsed&&null!=n.anchorNode&&n.anchorNode===n.focusNode&&(0===n.anchorOffset&&1===n.focusOffset||1===n.anchorOffset&&0===n.focusOffset)){const i=this.lines[e].Element(),s=Array.from(i.children).indexOf(n.anchorNode);Utils.Assert(s>-1);const o=i.children[s],r=function(){let n=e,i=s+1;for(;;){const e=this.lines[n].Element();for(let n=e.children.length;i<n;i+=1){const n=e.children[i];if(t.includes((n.textContent||"").replaceAll(/ /g," ")))return n;if(n===o)return null}n===this.lines.length-1?n=0:n+=1,i=0}}.bind(this)();r?(r.parentElement.focus(),n.getRangeAt(0).setStart(r,0),n.getRangeAt(0).setEnd(r,1)):(this.lines[0].Element().focus(),n.getRangeAt(0).setStart(this.lines[0].Element(),0),n.getRangeAt(0).setEnd(this.lines[0].Element(),0))}else{for(let e of this.lines)for(let n of e.Element().children)if(t.includes((n.textContent||"").replaceAll(/ /g," "))){e.Element().focus();const t=document.getSelection();return t.getRangeAt(0).setStart(n,0),void t.getRangeAt(0).setEnd(n,1)}this.lines[0].Element().focus(),document.getSelection().getRangeAt(0).setStart(this.lines[0].Element(),0),document.getSelection().getRangeAt(0).setEnd(this.lines[0].Element(),0)}}Highlight_Next_Class(t){const e=this.Focused_Line_Index(),n=document.getSelection();if(null!=e&&null!=n&&!n.isCollapsed&&null!=n.anchorNode&&n.anchorNode===n.focusNode&&(0===n.anchorOffset&&1===n.focusOffset||1===n.anchorOffset&&0===n.focusOffset)){const i=this.lines[e].Element(),s=Array.from(i.children).indexOf(n.anchorNode);Utils.Assert(s>-1);const o=i.children[s],r=function(){let n=e,i=s+1;for(;;){const e=this.lines[n].Element();for(let n=e.children.length;i<n;i+=1){const n=e.children[i];for(const e of n.classList.values()){if(t.includes(e))return n;if(n===o)return null}}n===this.lines.length-1?n=0:n+=1,i=0}}.bind(this)();r?(r.parentElement.focus(),n.getRangeAt(0).setStart(r,0),n.getRangeAt(0).setEnd(r,1)):(this.lines[0].Element().focus(),n.getRangeAt(0).setStart(this.lines[0].Element(),0),n.getRangeAt(0).setEnd(this.lines[0].Element(),0))}else{for(let e of this.lines)for(let n of e.Element().children)for(const i of n.classList.values())if(t.includes(i)){e.Element().focus();const t=document.getSelection();return t.getRangeAt(0).setStart(n,0),void t.getRangeAt(0).setEnd(n,1)}this.lines[0].Element().focus(),document.getSelection().getRangeAt(0).setStart(this.lines[0].Element(),0),document.getSelection().getRangeAt(0).setEnd(this.lines[0].Element(),0)}}Focused_Line_Index(){const t=document.getSelection();if(t&&(t.anchorNode||t.focusNode)){for(let e=0,n=this.lines.length;e<n;e+=1)if(this.lines[e].Element().contains(t.anchorNode)||this.lines[e].Element().contains(t.focusNode))return e;return null}return null}Display_Stats(){const t=document.createElement("div");t.setAttribute("style","\n                display: flex;\n                flex-direction: column;\n                justify-content: center;\n                align-items: center;\n\n                position: absolute;\n                left: 0;\n                top: 0;\n                z-index: 1;\n\n                width: 100%;\n                height: 100%;\n\n                background-color: rgba(0, 0, 0, 0.7);\n\n                font-size: 18px;\n                color: #E0ECFF;\n            ");const e=document.createElement("div");e.setAttribute("style","\n                width: 67%;\n                margin: 2px;\n                padding: 7px;\n\n                background-color: #0f1318;\n\n                text-align: center;\n            ");const n=document.createElement("div");n.setAttribute("style","\n            display: flex;\n            justify-content: center;\n            align-items: center;\n\n            border-width: 2px;\n            border-style: solid;\n            border-color: #3B3A32;\n\n            cursor: pointer;\n            user-select: none;\n        "),n.innerHTML="<div>Okay</div>",n.addEventListener("click",function(e){document.body.removeChild(t),this.Line(0).Element().focus()}.bind(this)),e.appendChild(n),t.appendChild(e),document.body.appendChild(t)}}Utils.Create_Style_Element(`\n        @font-face {\n            font-family: "Ezra SIL SR";\n            src: url("${Utils.Resolve_Path("fonts/Hebrew/Ezra/SILEOTSR.ttf")}");\n        }\n        @font-face {\n            font-family: "Cardo";\n            src: url("${Utils.Resolve_Path("fonts/Greek/Cardo/Cardo-Regular.ttf")}");\n        }\n        @font-face {\n            font-family: "Gentium Plus";\n            src: url("${Utils.Resolve_Path("fonts/Latin/Gentium/GentiumPlus-R.ttf")}");\n        }\n        \n        * {\n            box-sizing: border-box;\n            margin: 0;\n            padding: 0;\n        }\n\n        *:focus {\n            outline: 0;\n        }\n        \n        html, body {\n            width: 100%;\n            height: 100%;\n\n            background-color: black;\n\n            font-family: sans-serif;\n            font-size: 24px;\n        }\n\n        body {\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            align-items: center;\n        }\n\n        span {\n            display: inline-block;\n        }\n\n        .ITALIC {\n            font-style: italic;\n        }\n\n        .BOLD {\n            font-weight: bold;\n        }\n\n        .UNDERLINE {\n            text-decoration: underline;\n        }\n        \n        .SMALL_CAPS {\n            font-variant: small-caps;\n        }\n\n        .ERROR {\n            color: #ffcbcb;\n        }\n\n        .INDENT {\n            width: 6em;\n        }\n\n        .SEPARATE_POINT {\n            display: inline-block;\n\n            min-width: 7px;\n\n            text-align: center;\n        }\n\n        .UNKNOWN_POINT {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: #ffff00;\n\n            overflow-wrap: normal;\n        }\n\n        .KNOWN_LETTER {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: transparent;\n\n            overflow-wrap: normal;\n        }\n\n        .KNOWN_MARKER {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: transparent;\n\n            overflow-wrap: normal;\n        }\n\n        .UNKNOWN_WORD {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: #ff5858;\n\n            overflow-wrap: normal;\n        }\n\n        .KNOWN_WORD {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: transparent;\n\n            overflow-wrap: normal;\n        }\n\n        .UNKNOWN_BREAK {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: #00da6f;\n\n            overflow-wrap: normal;\n        }\n\n        .KNOWN_BREAK {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: transparent;\n\n            overflow-wrap: normal;\n        }\n\n        .KNOWN_WORD_ERROR {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: #e767c3;\n\n            overflow-wrap: normal;\n        }\n\n        .KNOWN_BREAK_ERROR {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: #e767c3;\n\n            overflow-wrap: normal;\n        }\n\n        .COMMAND {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: transparent;\n            \n            overflow-wrap: normal;\n        }\n\n        .BAD_COMMAND {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: orange;\n            \n            overflow-wrap: normal;\n        }\n    `),new Editor({parent:document.body});