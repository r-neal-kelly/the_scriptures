var __awaiter=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(s,o){function r(e){try{l(i.next(e))}catch(e){o(e)}}function a(e){try{l(i.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?s(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}l((i=i.apply(e,t||[])).next())}))};import*as Utils from"./utils.js";import*as Unicode from"./unicode.js";import*as Keyboard from"./keyboard.js";import*as Language from"./model/language.js";import*as Fonts from"./model/fonts.js";import*as Model from"./model/text.js";const INDENT_AMOUNT=6;function Escape_Text(e){return e.replaceAll(/./g,(function(e){if(" "===e)return`&#${" ".charCodeAt(0)};`;{const t=e.charCodeAt(0);return t<55296||t>57343?`&#${t};`:e}}))}function Text_Offset_To_Node(e,t){if(e===t)return 0;{let n=0;for(const i of e.childNodes){if(i===t)return n;if(i.contains(t))return n+Text_Offset_To_Node(i,t);i.textContent?n+=i.textContent.length:n+=0}return n}}function Text_Offset(e){const t=document.getSelection();return t?t.isCollapsed?t.anchorNode&&(t.anchorNode===e||e.contains(t.anchorNode))?Text_Offset_To_Node(e,t.anchorNode)+t.anchorOffset:null:t.anchorNode&&t.focusNode&&(t.anchorNode===e||e.contains(t.anchorNode))&&(t.focusNode===e||e.contains(t.focusNode))?t.anchorOffset<t.focusOffset?t.focusNode instanceof Text?Text_Offset_To_Node(e,t.focusNode)+t.focusOffset:t.focusNode.textContent?Text_Offset_To_Node(e,t.focusNode)+t.focusNode.textContent.length:Text_Offset_To_Node(e,t.focusNode):t.anchorNode instanceof Text?Text_Offset_To_Node(e,t.anchorNode)+t.anchorOffset:t.anchorNode.textContent?Text_Offset_To_Node(e,t.anchorNode)+t.anchorNode.textContent.length:Text_Offset_To_Node(e,t.anchorNode):null:null}function Set_Text_Offset(e,t){class n{constructor({node:e,offset:t}){this.node=e,this.offset=t}}e.focus();const i=document.getSelection();if(i){const s=function e(t,i,s=0){for(const o of t.childNodes)if(o instanceof Text){const e=o.textContent?o.textContent.length:0;if((s+=e)>=i)return new n({node:o,offset:i-(s-e)})}else{const t=e(o,i,s);if(t instanceof n)return t;s=t}return s}(e,t);s instanceof n?i.collapse(s.node,s.offset):i.collapse(e,s)}}function Put_Child_At_Parent_Top_Y(e,t){const n=e.getBoundingClientRect(),i=t.getBoundingClientRect().y-n.y;e.scrollTop+=i}var Part_Class;function Selected_Part(){const e=document.getSelection();if(e&&!e.isCollapsed&&null!=e.anchorNode&&null!=e.focusNode&&e.anchorNode===e.focusNode&&0===e.getRangeAt(0).startOffset&&1===e.getRangeAt(0).endOffset){if(e.anchorNode instanceof HTMLSpanElement){const t=e.anchorNode;if(null!=t.parentElement&&null!=t.textContent){const e=t.textContent.replaceAll(/ /g," ");if(""!==e){let n=Part_Class._NONE_;t.classList.contains("UNKNOWN_POINT")?n=Part_Class.UNKNOWN_POINT:t.classList.contains("KNOWN_LETTER")?n=Part_Class.KNOWN_LETTER:t.classList.contains("KNOWN_MARKER")?n=Part_Class.KNOWN_MARKER:t.classList.contains("UNKNOWN_WORD")?n=Part_Class.UNKNOWN_WORD:t.classList.contains("KNOWN_WORD")?n=Part_Class.KNOWN_WORD:t.classList.contains("UNKNOWN_BREAK")?n=Part_Class.UNKNOWN_BREAK:t.classList.contains("KNOWN_BREAK")?n=Part_Class.KNOWN_BREAK:t.classList.contains("KNOWN_WORD_ERROR")?n=Part_Class.KNOWN_WORD_ERROR:t.classList.contains("KNOWN_BREAK_ERROR")&&(n=Part_Class.KNOWN_BREAK_ERROR);const i=null!=t.dataset.language&&""!=t.dataset.language?t.dataset.language:null;if(n!==Part_Class._NONE_){let s=Model.Dictionary.Boundary.MIDDLE;return t.classList.contains(Model.Dictionary.Boundary.START)?s=Model.Dictionary.Boundary.START:t.classList.contains(Model.Dictionary.Boundary.END)&&(s=Model.Dictionary.Boundary.END),{text:e,class:n,language:i,boundary:s}}return null}return null}return null}return null}return null}!function(e){e[e._NONE_=-1]="_NONE_",e[e.UNKNOWN_POINT=0]="UNKNOWN_POINT",e[e.KNOWN_LETTER=1]="KNOWN_LETTER",e[e.KNOWN_MARKER=2]="KNOWN_MARKER",e[e.UNKNOWN_WORD=3]="UNKNOWN_WORD",e[e.KNOWN_WORD=4]="KNOWN_WORD",e[e.UNKNOWN_BREAK=5]="UNKNOWN_BREAK",e[e.KNOWN_BREAK=6]="KNOWN_BREAK",e[e.KNOWN_WORD_ERROR=7]="KNOWN_WORD_ERROR",e[e.KNOWN_BREAK_ERROR=8]="KNOWN_BREAK_ERROR"}(Part_Class||(Part_Class={}));const LETTER_KEY=Keyboard.Key.HOME,MARKER_KEY=Keyboard.Key.PAGE_UP,WORD_KEY=Keyboard.Key.PAGE_DOWN,BREAK_KEY=Keyboard.Key.END,ERROR_KEY=Keyboard.Key.DELETE,WORD_ERROR_KEY=Keyboard.Key.PAUSE,BREAK_ERROR_KEY=Keyboard.Key.INSERT;class Line_Keyboard_Hook extends Keyboard.Hook.Instance{constructor(e){super(),this.line=e}On_Key_Down(e){return __awaiter(this,void 0,void 0,(function*(){yield this.On_Key_Down_Impl.bind(this.line)(e)}))}After_Insert_Or_Paste_Or_Delete(){return __awaiter(this,void 0,void 0,(function*(){yield this.After_Insert_Or_Paste_Or_Delete_Impl.bind(this.line)()}))}On_Key_Down_Impl(e){return __awaiter(this,void 0,void 0,(function*(){if(e.key===Keyboard.Key.ENTER){e.preventDefault();const t=document.getSelection();if(t){const e=this.Text();let n,i;if(t.isCollapsed){0;const s=Text_Offset_To_Node(this.Element(),t.anchorNode)+t.anchorOffset;n=e.slice(0,s),i=e.slice(s,e.length)}else{let s,o,r,a;0,0,t.anchorOffset<t.focusOffset?(s=t.anchorNode,o=t.anchorOffset,r=t.focusNode,a=t.focusOffset):(s=t.focusNode,o=t.focusOffset,r=t.anchorNode,a=t.anchorOffset);const l=this.Element(),d=Text_Offset_To_Node(l,s)+o,c=Text_Offset_To_Node(l,r)+a;n=e.slice(0,d),i=e.slice(c,e.length)}const s=this.Index();this.Set_Text(n),this.Editor().Insert_Line(s+1,i),this.Editor().Line(s+1).Element().focus()}}else if(e.key===Keyboard.Key.BACKSPACE){const t=document.getSelection();if(t){const n=this.Index(),i=Text_Offset(this.Element());if(n>0&&t.isCollapsed&&0===i){e.preventDefault();const t=this.Editor().Line(n-1),i=t.Text();t.Set_Text(`${i}${this.Text()}`),this.Editor().Remove_Line(n),Set_Text_Offset(t.Element(),i.length)}}}else if(e.key===Keyboard.Key.ARROW_UP){if(e.preventDefault(),!this.Editor().Is_Meta_Key_Active()){if(document.getSelection()){const e=this.Index();if(e>0){const t=Text_Offset(this.Element()),n=this.Editor().Line(e-1),i=n.Text();Set_Text_Offset(n.Element(),i.length<t?i.length:t)}}}}else if(e.key===Keyboard.Key.ARROW_DOWN){if(e.preventDefault(),!this.Editor().Is_Meta_Key_Active()){if(document.getSelection()){const e=this.Index();if(e<this.Editor().Line_Count()-1){const t=Text_Offset(this.Element()),n=this.Editor().Line(e+1),i=n.Text();Set_Text_Offset(n.Element(),i.length<t?i.length:t)}}}}else if(e.key===Keyboard.Key.ARROW_LEFT){const t=document.getSelection();if(t&&!t.isCollapsed&&t.anchorNode&&t.focusNode&&t.anchorNode===t.focusNode){e.preventDefault();const n=this.Element(),i=Array.from(n.children).indexOf(t.anchorNode);i>0&&(t.getRangeAt(0).setStart(n.children[i-1],0),t.getRangeAt(0).setEnd(n.children[i-1],1))}else{const t=Text_Offset(this.Element());if(null!=t&&(e.preventDefault(),t>0)){const e=this.Text()[t-1].charCodeAt(0);Set_Text_Offset(this.Element(),e>=56320&&e<=57343?Math.max(0,t-2):t-1)}}}else if(e.key===Keyboard.Key.ARROW_RIGHT){const t=document.getSelection();if(t&&!t.isCollapsed&&t.anchorNode&&t.focusNode&&t.anchorNode===t.focusNode){e.preventDefault();const n=this.Element(),i=Array.from(n.children).indexOf(t.anchorNode);i>=0&&i<n.children.length-1&&(t.getRangeAt(0).setStart(n.children[i+1],0),t.getRangeAt(0).setEnd(n.children[i+1],1))}else{const t=Text_Offset(this.Element());if(null!=t){e.preventDefault();const n=this.Text();if(t+2<=n.length){const e=n[t+1].charCodeAt(0);Set_Text_Offset(this.Element(),e>=56320&&e<=57343?t+2:t+1)}else t<n.length&&Set_Text_Offset(this.Element(),t+1)}}}else if(e.key===LETTER_KEY){if(e.preventDefault(),this.Editor().Is_Meta_Key_Active()){const e=Selected_Part();e&&(e.class===Part_Class.UNKNOWN_POINT?(this.Editor().Dictionary().Add_Letter(e.text,e.language),this.Editor().Touch()):e.class===Part_Class.KNOWN_LETTER?(this.Editor().Dictionary().Remove_Letter(e.text,e.language),this.Editor().Touch()):e.class!==Part_Class.UNKNOWN_WORD&&e.class!==Part_Class.KNOWN_WORD||Unicode.Is_Point(e.text)&&(this.Editor().Dictionary().Remove_Letter(e.text,e.language),this.Editor().Touch()))}}else if(e.key===MARKER_KEY){if(e.preventDefault(),this.Editor().Is_Meta_Key_Active()){const e=Selected_Part();e&&(e.class===Part_Class.UNKNOWN_POINT?(this.Editor().Dictionary().Add_Marker(e.text,e.language),this.Editor().Touch()):e.class===Part_Class.KNOWN_MARKER?(this.Editor().Dictionary().Remove_Marker(e.text,e.language),this.Editor().Touch()):e.class!==Part_Class.UNKNOWN_BREAK&&e.class!==Part_Class.KNOWN_BREAK||Unicode.Is_Point(e.text)&&(this.Editor().Dictionary().Remove_Marker(e.text,e.language),this.Editor().Touch()))}}else if(e.key===WORD_KEY){if(e.preventDefault(),this.Editor().Is_Meta_Key_Active()){const e=Selected_Part();e&&(e.class===Part_Class.UNKNOWN_WORD?(this.Editor().Dictionary().Add_Word(e.text,e.language),this.Editor().Touch()):e.class===Part_Class.KNOWN_WORD?(this.Editor().Dictionary().Remove_Word(e.text,e.language),this.Editor().Touch()):e.class===Part_Class.KNOWN_WORD_ERROR&&(this.Editor().Dictionary().Remove_Word_Error(e.text,e.language),this.Editor().Dictionary().Add_Word(e.text,e.language),this.Editor().Touch()))}}else if(e.key===BREAK_KEY){if(e.preventDefault(),this.Editor().Is_Meta_Key_Active()){const e=Selected_Part();e&&(e.class===Part_Class.UNKNOWN_BREAK?(this.Editor().Dictionary().Add_Break(e.text,e.boundary,e.language),this.Editor().Touch()):e.class===Part_Class.KNOWN_BREAK?(this.Editor().Dictionary().Remove_Break(e.text,e.boundary,e.language),this.Editor().Touch()):e.class===Part_Class.KNOWN_BREAK_ERROR&&(this.Editor().Dictionary().Remove_Break_Error(e.text,e.boundary,e.language),this.Editor().Dictionary().Add_Break(e.text,e.boundary,e.language),this.Editor().Touch()))}}else if(e.key===ERROR_KEY){if(this.Editor().Is_Meta_Key_Active()){e.preventDefault();const t=Selected_Part();t&&(t.class===Part_Class.UNKNOWN_WORD?(this.Editor().Dictionary().Add_Word_Error(t.text,t.language),this.Editor().Touch()):t.class===Part_Class.KNOWN_WORD?(this.Editor().Dictionary().Remove_Word(t.text,t.language),this.Editor().Dictionary().Add_Word_Error(t.text,t.language),this.Editor().Touch()):t.class===Part_Class.UNKNOWN_BREAK?(this.Editor().Dictionary().Add_Break_Error(t.text,t.boundary,t.language),this.Editor().Touch()):t.class===Part_Class.KNOWN_BREAK?(this.Editor().Dictionary().Remove_Break(t.text,t.boundary,t.language),this.Editor().Dictionary().Add_Break_Error(t.text,t.boundary,t.language),this.Editor().Touch()):t.class===Part_Class.KNOWN_WORD_ERROR?(this.Editor().Dictionary().Remove_Word_Error(t.text,t.language),this.Editor().Touch()):t.class===Part_Class.KNOWN_BREAK_ERROR&&(this.Editor().Dictionary().Remove_Break_Error(t.text,t.boundary,t.language),this.Editor().Touch()))}}else if(e.key===WORD_ERROR_KEY){if(this.Editor().Is_Meta_Key_Active()){e.preventDefault();const t=Selected_Part();t&&(t.class===Part_Class.UNKNOWN_POINT||t.class===Part_Class.UNKNOWN_WORD?(this.Editor().Dictionary().Add_Word_Error(t.text,t.language),this.Editor().Touch()):t.class===Part_Class.KNOWN_WORD?(this.Editor().Dictionary().Remove_Word(t.text,t.language),this.Editor().Dictionary().Add_Word_Error(t.text,t.language),this.Editor().Touch()):t.class===Part_Class.KNOWN_WORD_ERROR&&(this.Editor().Dictionary().Remove_Word_Error(t.text,t.language),this.Editor().Touch()))}}else if(e.key===BREAK_ERROR_KEY&&this.Editor().Is_Meta_Key_Active()){e.preventDefault();const t=Selected_Part();t&&(t.class===Part_Class.UNKNOWN_POINT||t.class===Part_Class.UNKNOWN_BREAK?(this.Editor().Dictionary().Add_Break_Error(t.text,t.boundary,t.language),this.Editor().Touch()):t.class===Part_Class.KNOWN_BREAK?(this.Editor().Dictionary().Remove_Break(t.text,t.boundary,t.language),this.Editor().Dictionary().Add_Break_Error(t.text,t.boundary,t.language),this.Editor().Touch()):t.class===Part_Class.KNOWN_BREAK_ERROR&&(this.Editor().Dictionary().Remove_Break_Error(t.text,t.boundary,t.language),this.Editor().Touch()))}}))}After_Insert_Or_Paste_Or_Delete_Impl(){return __awaiter(this,void 0,void 0,(function*(){const e=Text_Offset(this.Element());this.Touch(),Set_Text_Offset(this.Element(),e)}))}}class Line{constructor({editor:e,parent:t}){this.editor=e,this.parent=t,this.element=document.createElement("div"),this.children={},this.element.setAttribute("contentEditable","true"),this.element.setAttribute("spellcheck","false"),this.element.setAttribute("style",`\n                display: flex;\n                flex-wrap: wrap;\n                justify-content: center;\n\n                width: 100%;\n                padding: 2px;\n\n                border-width: 0 0 1px 0;\n                border-style: solid;\n                border-color: #3B3A32;\n\n                direction: ${e.Direction()===Language.Direction.LEFT_TO_RIGHT?"ltr":"rtl"};\n            `),this.parent.appendChild(this.element),this.keyboard_hook=new Line_Keyboard_Hook(this),Keyboard.Singleton().Add_Div(this.element,this.keyboard_hook),this.element.addEventListener("dblclick",function(e){const t=document.getSelection();if(t){t.rangeCount<1&&t.addRange(document.createRange());let n=this.Element();for(const t of this.Element().children){const i=t.getBoundingClientRect();if(e.clientX>=i.left&&e.clientX<=i.right&&e.clientY>=i.top&&e.clientY<=i.bottom){n=t;break}}n===this.Element()?(t.getRangeAt(0).setStart(n,0),t.getRangeAt(0).setEnd(n,n.children.length)):(t.getRangeAt(0).setStart(n,0),t.getRangeAt(0).setEnd(n,1))}}.bind(this))}Destruct(){Keyboard.Singleton().Remove_Div(this.element),this.parent.removeChild(this.element)}Editor(){return this.editor}Parent(){return this.parent}Element(){return this.element}Index(){const e=this.Editor().Lines().indexOf(this);return 0,e}Text(){return this.element.textContent?this.element.textContent.replaceAll(/ /g," "):""}Set_Text(e){if(this.Editor().Is_In_Point_Mode())this.element.innerHTML=this.Treat_As_Points(e),this.element.style.display="block";else{const t=this.Treat(e);if(this.element.innerHTML=t.html,t.is_centered?this.element.style.display="flex":this.element.style.display="block",t.padding_count>0){this.Editor().Direction()===Language.Direction.RIGHT_TO_LEFT?this.element.style.paddingRight=6*t.padding_count+"em":this.element.style.paddingLeft=6*t.padding_count+"em"}}}Touch(){const e=Text_Offset(this.Element());this.Set_Text(this.Text()),this.Editor().Direction()===Language.Direction.LEFT_TO_RIGHT?this.Element().style.direction="ltr":this.Element().style.direction="rtl",e&&Set_Text_Offset(this.Element(),e)}Treat(e){const t=new Model.Instance({dictionary:this.Editor().Dictionary(),value:e});0;let n="",i=null,s=null;const o=t.Line(0);for(let e=0,t=o.Column_Count();e<t;e+=1){const t=o.Column(e);for(let e=0,o=t.Row_Count();e<o;e+=1){const o=t.Row(e);null==i&&(i=o.Is_Centered()),null==s&&(s=o.Padding_Count());for(let e=0,t=o.Macro_Part_Count();e<t;e+=1){const t=o.Macro_Part(e);if(t.Is_Command()){const e=t;let i="";e.Is_Indent()?i+=" INDENT":e.Is_Column()?i+=" COLUMN":e.Is_Row()?this.editor.Are_Rows_Expanded()?i+=" EXPANDED_ROW":i+=" COLLAPSED_ROW":e.Is_Margin()?i+=" MARGIN":e.Is_Interlinear()&&(i+=" INTERLINEAR"),e.Is_Good()?n+=`<span class="COMMAND${i}" data-language="${t.Language()||""}">${Escape_Text(e.Value())}</span>`:n+=`<span class="BAD_COMMAND${i}" data-language="${t.Language()||""}">${Escape_Text(e.Value())}</span>`}else{let e="";if(t.Has_Italic_Style()&&(e+=" ITALIC"),t.Has_Bold_Style()&&(e+=" BOLD"),t.Has_Underline_Style()&&(e+=" UNDERLINE"),t.Has_Small_Caps_Style()&&(e+=" SMALL_CAPS"),t.Has_Error_Style()&&(e+=" ERROR"),t.Has_Argument_Style()&&(e+=" ARGUMENT"),t.Is_Point())n+=`<span class="UNKNOWN_POINT${e}" data-language="${t.Language()||""}">${Escape_Text(t.Value())}</span>`;else if(t.Is_Word())t.Is_Good()?n+=`<span class="KNOWN_WORD${e}" data-language="${t.Language()||""}">${Escape_Text(t.Value())}</span>`:t.Is_Error()?n+=`<span class="KNOWN_WORD_ERROR${e}" data-language="${t.Language()||""}">${Escape_Text(t.Value())}</span>`:t.Is_Unknown()?n+=`<span class="UNKNOWN_WORD${e}" data-language="${t.Language()||""}">${Escape_Text(t.Value())}</span>`:0;else if(t.Is_Break()){let i=" "+t.Boundary();t.Is_Good()?n+=`<span class="KNOWN_BREAK${i}${e}" data-language="${t.Language()||""}">${Escape_Text(t.Value())}</span>`:t.Is_Error()?n+=`<span class="KNOWN_BREAK_ERROR${i}${e}" data-language="${t.Language()||""}">${Escape_Text(t.Value())}</span>`:t.Is_Unknown()?n+=`<span class="UNKNOWN_BREAK${i}${e}" data-language="${t.Language()||""}">${Escape_Text(t.Value())}</span>`:0}else 0}}}}return{html:n,is_centered:null!=i&&i,padding_count:null!=s?s:0}}Treat_As_Points(e){const t=new Model.Instance({dictionary:this.Editor().Dictionary(),value:e});0;let n="";const i=t.Line(0);for(let e=0,t=i.Column_Count();e<t;e+=1){const t=i.Column(e);for(let e=0,i=t.Row_Count();e<i;e+=1){const i=t.Row(e);for(let e=0,t=i.Micro_Part_Count();e<t;e+=1){const t=i.Micro_Part(e);if(t.Is_Command()){let e=new Unicode.Iterator({text:t.Value(),index:0});for(;!e.Is_At_End();e=e.Next())n+=`<span class="COMMAND SEPARATE_POINT" data-language="${t.Language()||""}">${Escape_Text(e.Point())}</span>`}else t.Is_Letter()?n+=`<span class="KNOWN_LETTER SEPARATE_POINT" data-language="${t.Language()||""}">${Escape_Text(t.Value())}</span>`:t.Is_Marker()?n+=`<span class="KNOWN_MARKER SEPARATE_POINT" data-language="${t.Language()||""}">${Escape_Text(t.Value())}</span>`:t.Is_Point()?n+=`<span class="UNKNOWN_POINT SEPARATE_POINT" data-language="${t.Language()||""}">${Escape_Text(t.Value())}</span>`:0}}}return n}}class Editor{constructor({parent:e}){const t="\n            display: flex;\n            justify-content: center;\n            align-items: center;\n            justify-self: center;\n\n            width: 100%;\n            padding: 2px;\n\n            border-width: 2px;\n            border-style: solid;\n            border-color: #3B3A32;\n\n            cursor: pointer;\n            user-select: none;\n        ";this.is_meta_key_active=!1,this.is_in_point_mode=!1,this.are_rows_expanded=!0,this.direction=Language.Direction.LEFT_TO_RIGHT,this.parent=e,this.element=document.createElement("div"),this.children={controls:document.createElement("div"),dictionary_label:document.createElement("div"),dictionary_new_button:document.createElement("div"),dictionary_load_input:document.createElement("input"),dictionary_load_button:document.createElement("div"),dictionary_save_button:document.createElement("div"),dictionary_name:document.createElement("div"),file_label:document.createElement("div"),file_new_button:document.createElement("div"),file_load_input:document.createElement("input"),file_load_button:document.createElement("div"),file_save_button:document.createElement("div"),file_name:document.createElement("div"),lines:document.createElement("div")},this.element.setAttribute("style","\n                display: flex;\n                flex-direction: column;\n                justify-content: center;\n                align-items: center;\n\n                position: relative;\n\n                height: 100%;\n                width: 100%;\n                padding: 7px 7px 0 7px;\n\n                border-width: 0;\n\n                background-color: #0f1318;\n                color: #E0ECFF;\n\n                overflow-y: auto;\n            "),this.element.addEventListener("keydown",this.On_Key_Down.bind(this),{capture:!0}),this.element.addEventListener("keyup",this.On_Key_Up.bind(this),{capture:!0}),this.children.controls.setAttribute("style","\n                display: grid;\n                grid-template-columns: 1fr 1fr 1fr 1fr 1fr;\n                grid-template-rows: 1fr 1fr;\n                grid-gap: 3px;\n\n                width: 100%;\n                padding: 2px 0;\n\n                font-size: 16px;\n            "),this.children.dictionary_label.setAttribute("style","\n                font-size: 24px;\n\n                user-select: none;\n            "),this.children.dictionary_label.textContent="Dictionary:",this.children.dictionary_name.setAttribute("contentEditable","true"),this.children.dictionary_name.setAttribute("spellcheck","true"),this.children.dictionary_name.setAttribute("style","\n                padding: 2px;\n\n                font-size: 22px;\n                direction: ltr;\n            "),this.children.dictionary_name.addEventListener("keydown",function(e){"Enter"===e.key&&e.preventDefault()}.bind(this)),this.children.dictionary_name.addEventListener("input",function(e){const t=e;if("insertText"===t.inputType||"deleteContentBackward"===t.inputType||"insertFromPaste"===t.inputType){const e=Text_Offset(this.children.dictionary_name);this.Set_Dictionary_Name(this.Dictionary_Name()),Set_Text_Offset(this.children.dictionary_name,e)}}.bind(this)),this.children.dictionary_new_button.setAttribute("style",t),this.children.dictionary_new_button.innerHTML="<div>New</div>",this.children.dictionary_new_button.addEventListener("click",function(e){return __awaiter(this,void 0,void 0,(function*(){((null===this.saved_dictionary?this.Dictionary().To_JSON()===new Model.Dictionary.Instance({}).To_JSON():this.saved_dictionary===this.Dictionary().To_JSON())||(yield this.Try_To_Save_Dictionary()))&&(this.Set_Dictionary_Name("New Dictionary"),this.dictionary=new Model.Dictionary.Instance({}),this.Touch(),this.saved_dictionary=null)}))}.bind(this)),this.children.dictionary_load_input.setAttribute("type","file"),this.children.dictionary_load_input.setAttribute("accept",".json"),this.children.dictionary_load_input.setAttribute("style","\n                display: none;\n            "),this.children.dictionary_load_input.addEventListener("input",function(e){return __awaiter(this,void 0,void 0,(function*(){if(this.children.dictionary_load_input.files&&this.children.dictionary_load_input.files[0]){const e=this.children.dictionary_load_input.files[0],t=yield e.text();this.Set_Dictionary_Name(e.name.replace(/\.[^.]+$/,"")),yield this.Set_Dictionary_JSON(t),this.children.dictionary_load_input.value="",this.saved_dictionary=this.Dictionary().To_JSON()}}))}.bind(this)),this.children.dictionary_load_button.setAttribute("style",t),this.children.dictionary_load_button.innerHTML="<div>Load</div>",this.children.dictionary_load_button.addEventListener("click",function(e){return __awaiter(this,void 0,void 0,(function*(){((null==this.saved_dictionary?this.Dictionary().To_JSON()===new Model.Dictionary.Instance({}).To_JSON():this.saved_dictionary===this.Dictionary().To_JSON())||(yield this.Try_To_Save_Dictionary()))&&this.children.dictionary_load_input.click()}))}.bind(this)),this.children.dictionary_save_button.setAttribute("style",t),this.children.dictionary_save_button.innerHTML="<div>Save</div>",this.children.dictionary_save_button.addEventListener("click",function(e){this.Save_Dictionary()}.bind(this)),this.children.file_label.setAttribute("style","\n                font-size: 24px;\n\n                user-select: none;\n            "),this.children.file_label.textContent="File:",this.children.file_name.setAttribute("contentEditable","true"),this.children.file_name.setAttribute("spellcheck","true"),this.children.file_name.setAttribute("style","\n                padding: 2px;\n\n                font-size: 22px;\n                direction: ltr;\n            "),this.children.file_name.addEventListener("keydown",function(e){"Enter"===e.key&&e.preventDefault()}.bind(this)),this.children.file_name.addEventListener("input",function(e){const t=e;if("insertText"===t.inputType||"deleteContentBackward"===t.inputType||"insertFromPaste"===t.inputType){const e=Text_Offset(this.children.file_name);this.Set_File_Name(this.File_Name()),Set_Text_Offset(this.children.file_name,e)}}.bind(this)),this.children.file_new_button.setAttribute("style",t),this.children.file_new_button.innerHTML="<div>New</div>",this.children.file_new_button.addEventListener("click",function(e){return __awaiter(this,void 0,void 0,(function*(){((null===this.saved_file?""===this.Text():this.saved_file===this.Text())||(yield this.Try_To_Save_File()))&&(this.Set_File_Name("New File"),this.Clear_Text(),this.Touch(),this.saved_file=null)}))}.bind(this)),this.children.file_load_input.setAttribute("type","file"),this.children.file_load_input.setAttribute("accept",".txt"),this.children.file_load_input.setAttribute("style","\n                display: none;\n            "),this.children.file_load_input.addEventListener("input",function(e){return __awaiter(this,void 0,void 0,(function*(){if(this.children.file_load_input.files&&this.children.file_load_input.files[0]){const e=this.children.file_load_input.files[0],t=yield e.text();this.Set_File_Name(e.name.replace(/\.[^.]+$/,"")),this.Set_Text(t),this.children.file_load_input.value="",this.saved_file=this.Text(),0}}))}.bind(this)),this.children.file_load_button.setAttribute("style",t),this.children.file_load_button.innerHTML="<div>Load</div>",this.children.file_load_button.addEventListener("click",function(e){return __awaiter(this,void 0,void 0,(function*(){((null===this.saved_file?""===this.Text():this.saved_file===this.Text())||(yield this.Try_To_Save_File()))&&this.children.file_load_input.click()}))}.bind(this)),this.children.file_save_button.setAttribute("style",t),this.children.file_save_button.innerHTML="<div>Save</div>",this.children.file_save_button.addEventListener("click",function(e){this.Save_Text()}.bind(this)),this.children.lines.setAttribute("style","\n                display: flex;\n                flex-direction: column;\n                justify-content: start;\n                align-items: start;\n                \n                width: 100%;\n                height: 90%;\n                padding: 2px;\n\n                border-width: 2px;\n                border-style: none;\n                border-color: #3B3A32;\n\n                overflow-y: auto;\n            "),this.dictionary=new Model.Dictionary.Instance({}),this.lines=[],this.children.controls.appendChild(this.children.dictionary_label),this.children.controls.appendChild(this.children.dictionary_name),this.children.controls.appendChild(this.children.dictionary_new_button),this.children.controls.appendChild(this.children.dictionary_load_button),this.children.controls.appendChild(this.children.dictionary_save_button),this.children.controls.appendChild(this.children.file_label),this.children.controls.appendChild(this.children.file_name),this.children.controls.appendChild(this.children.file_new_button),this.children.controls.appendChild(this.children.file_load_button),this.children.controls.appendChild(this.children.file_save_button),this.element.appendChild(this.children.controls),this.element.appendChild(this.children.lines),this.parent.appendChild(this.element),this.Set_Dictionary_Name("New Dictionary"),this.Set_File_Name("New File"),this.Add_Line(""),this.saved_dictionary=null,this.saved_file=null}Parent(){return this.parent}Element(){return this.element}Dictionary(){return this.dictionary}Dictionary_Name(){return this.children.dictionary_name.textContent?this.children.dictionary_name.textContent.replaceAll(/ /g," "):""}Set_Dictionary_Name(e){this.children.dictionary_name.innerHTML=Escape_Text(e)}Dictionary_JSON(){return this.Dictionary().To_JSON()}Set_Dictionary_JSON(e){return __awaiter(this,void 0,void 0,(function*(){this.dictionary=new Model.Dictionary.Instance({json:e}),null!=this.dictionary.Maybe_Validation_Error()&&(this.dictionary=new Model.Dictionary.Instance,yield this.Message_Invalid_Dictionary_JSON()),this.Touch()}))}Message_Invalid_Dictionary_JSON(){return __awaiter(this,void 0,void 0,(function*(){return yield new Promise(function(e,t){const n=document.createElement("div");n.classList.add("Modal");const i=document.createElement("div");i.classList.add("Modal_Message"),i.innerHTML="<div>\n                    The loaded dictionary is invalid, and probably not a dictionary.\n                    You are instead working with a new dictionary.\n                </div>";const s=document.createElement("div");s.classList.add("Modal_Options","Modal_Options_1");const o=document.createElement("div");o.classList.add("Modal_Button"),o.innerHTML="<div>Okay</div>",o.addEventListener("click",function(t){document.body.removeChild(n),e(!0)}.bind(this)),s.appendChild(o),n.appendChild(i),n.appendChild(s),document.body.appendChild(n)}.bind(this))}))}Save_Dictionary(){const e=this.Dictionary_JSON(),t=this.Dictionary_Name(),n=new File([e],`${t}.json`),i=URL.createObjectURL(n),s=document.createElement("a");s.href=i,s.download=`${t}.json`,document.body.appendChild(s),s.click(),document.body.removeChild(s),this.saved_dictionary=e}Try_To_Save_Dictionary(){return __awaiter(this,void 0,void 0,(function*(){return yield new Promise(function(e,t){const n=document.createElement("div");n.classList.add("Modal");const i=document.createElement("div");i.classList.add("Modal_Message"),i.innerHTML="<div>\n                    There are unsaved changes to the current dictionary.\n                </div>";const s=document.createElement("div");s.classList.add("Modal_Options","Modal_Options_3");const o=document.createElement("div");o.classList.add("Modal_Button"),o.innerHTML="<div>Save Changes</div>",o.addEventListener("click",function(t){this.Save_Dictionary(),document.body.removeChild(n),e(!0)}.bind(this));const r=document.createElement("div");r.classList.add("Modal_Button"),r.innerHTML="<div>Discard Changes</div>",r.addEventListener("click",function(t){document.body.removeChild(n),e(!0)}.bind(this));const a=document.createElement("div");a.classList.add("Modal_Button"),a.innerHTML="<div>Cancel</div>",a.addEventListener("click",function(t){document.body.removeChild(n),e(!1)}.bind(this)),s.appendChild(o),s.appendChild(r),s.appendChild(a),n.appendChild(i),n.appendChild(s),document.body.appendChild(n)}.bind(this))}))}File_Name(){return this.children.file_name.textContent?this.children.file_name.textContent.replaceAll(/ /g," "):""}Set_File_Name(e){this.children.file_name.innerHTML=Escape_Text(e)}Text(){return this.lines.map((function(e){return e.Text()})).join("\n")}Set_Text(e){this.Clear_Text();const t=e.split(/\r?\n/);for(const e of t)this.Add_Line(e);this.Remove_Line(0)}Save_Text(){const e=this.Text(),t=this.File_Name(),n=new File([e],`${t}.txt`),i=URL.createObjectURL(n),s=document.createElement("a");s.href=i,s.download=`${t}.txt`,document.body.appendChild(s),s.click(),document.body.removeChild(s),this.saved_file=e}Try_To_Save_File(){return __awaiter(this,void 0,void 0,(function*(){return yield new Promise(function(e,t){const n=document.createElement("div");n.classList.add("Modal");const i=document.createElement("div");i.classList.add("Modal_Message"),i.innerHTML="<div>\n                    There are unsaved changes to the current file.\n                </div>";const s=document.createElement("div");s.classList.add("Modal_Options","Modal_Options_3");const o=document.createElement("div");o.classList.add("Modal_Button"),o.innerHTML="<div>Save Changes</div>",o.addEventListener("click",function(t){this.Save_Text(),document.body.removeChild(n),e(!0)}.bind(this));const r=document.createElement("div");r.classList.add("Modal_Button"),r.innerHTML="<div>Discard Changes</div>",r.addEventListener("click",function(t){document.body.removeChild(n),e(!0)}.bind(this));const a=document.createElement("div");a.classList.add("Modal_Button"),a.innerHTML="<div>Cancel</div>",a.addEventListener("click",function(t){document.body.removeChild(n),e(!1)}.bind(this)),s.appendChild(o),s.appendChild(r),s.appendChild(a),n.appendChild(i),n.appendChild(s),document.body.appendChild(n)}.bind(this))}))}Clear_Text(){for(const e of this.lines)e.Destruct();this.lines=[],this.Add_Line("")}Line_Count(){return this.lines.length}Lines(){return Array.from(this.lines)}Line(e){return 0,0,this.lines[e]}Add_Line(e){const t=new Line({editor:this,parent:this.children.lines});this.lines.push(t),t.Set_Text(e)}Remove_Line(e){0,0,this.lines.splice(e,1)[0].Destruct()}Insert_Line(e,t){0,0;for(let t=e,n=this.lines.length;t<n;t+=1){const e=this.lines[t];e.Parent().removeChild(e.Element())}const n=new Line({editor:this,parent:this.children.lines});this.lines.splice(e,0,n),n.Set_Text(t);for(let t=e+1,n=this.lines.length;t<n;t+=1){const e=this.lines[t];e.Parent().appendChild(e.Element())}}Touch(){this.Set_Dictionary_Name(this.Dictionary_Name()),this.Set_File_Name(this.File_Name()),this.Direction()===Language.Direction.LEFT_TO_RIGHT?(this.children.dictionary_name.style.direction="ltr",this.children.file_name.style.direction="ltr"):(this.children.dictionary_name.style.direction="rtl",this.children.file_name.style.direction="rtl");for(const e of this.lines)e.Touch()}Is_Meta_Key_Active(){return this.is_meta_key_active}Is_In_Point_Mode(){return this.is_in_point_mode}Are_Rows_Expanded(){return this.are_rows_expanded}Direction(){return this.direction}Set_Direction(e){this.direction=e,this.Touch()}Highlight_Next(e){const t=this.Focused_Line_Index(),n=document.getSelection();if(null!=t&&null!=n&&!n.isCollapsed&&null!=n.anchorNode&&n.anchorNode===n.focusNode&&(0===n.anchorOffset&&1===n.focusOffset||1===n.anchorOffset&&0===n.focusOffset)){const i=this.lines[t].Element(),s=Array.from(i.children).indexOf(n.anchorNode);0;const o=i.children[s],r=function(){let n=t,i=s+1;for(;;){const t=this.lines[n].Element();for(let n=t.children.length;i<n;i+=1){const n=t.children[i];if(e.includes((n.textContent||"").replaceAll(/ /g," ")))return n;if(n===o)return null}n===this.lines.length-1?n=0:n+=1,i=0}}.bind(this)();r?(Put_Child_At_Parent_Top_Y(this.children.lines,r),n.getRangeAt(0).setStart(r,0),n.getRangeAt(0).setEnd(r,1)):(this.lines[0].Element().focus(),n.getRangeAt(0).setStart(this.lines[0].Element(),0),n.getRangeAt(0).setEnd(this.lines[0].Element(),0))}else{for(let t of this.lines)for(let n of t.Element().children)if(e.includes((n.textContent||"").replaceAll(/ /g," "))){t.Element().focus();const e=document.getSelection();return Put_Child_At_Parent_Top_Y(this.children.lines,n),e.getRangeAt(0).setStart(n,0),void e.getRangeAt(0).setEnd(n,1)}this.lines[0].Element().focus(),document.getSelection().getRangeAt(0).setStart(this.lines[0].Element(),0),document.getSelection().getRangeAt(0).setEnd(this.lines[0].Element(),0)}}Highlight_Next_Class(e){const t=this.Focused_Line_Index(),n=document.getSelection();if(null!=t&&null!=n&&!n.isCollapsed&&null!=n.anchorNode&&n.anchorNode===n.focusNode&&(0===n.anchorOffset&&1===n.focusOffset||1===n.anchorOffset&&0===n.focusOffset)){const i=this.lines[t].Element(),s=Array.from(i.children).indexOf(n.anchorNode);0;const o=i.children[s],r=function(){let n=t,i=s+1;for(;;){const t=this.lines[n].Element();for(let n=t.children.length;i<n;i+=1){const n=t.children[i];for(const t of n.classList.values()){if(e.includes(t))return n;if(n===o)return null}}n===this.lines.length-1?n=0:n+=1,i=0}}.bind(this)();r?(Put_Child_At_Parent_Top_Y(this.children.lines,r),n.getRangeAt(0).setStart(r,0),n.getRangeAt(0).setEnd(r,1)):(this.lines[0].Element().focus(),n.getRangeAt(0).setStart(this.lines[0].Element(),0),n.getRangeAt(0).setEnd(this.lines[0].Element(),0))}else{for(let t of this.lines)for(let n of t.Element().children)for(const i of n.classList.values())if(e.includes(i)){t.Element().focus();const e=document.getSelection();return Put_Child_At_Parent_Top_Y(this.children.lines,n),e.getRangeAt(0).setStart(n,0),void e.getRangeAt(0).setEnd(n,1)}this.lines[0].Element().focus(),document.getSelection().getRangeAt(0).setStart(this.lines[0].Element(),0),document.getSelection().getRangeAt(0).setEnd(this.lines[0].Element(),0)}}Focused_Line_Index(){const e=document.getSelection();if(e&&(e.anchorNode||e.focusNode)){for(let t=0,n=this.lines.length;t<n;t+=1)if(this.lines[t].Element().contains(e.anchorNode)||this.lines[t].Element().contains(e.focusNode))return t;return null}return null}On_Key_Down(e){this.Is_Meta_Key_Active()?"ArrowLeft"===e.key?(e.preventDefault(),this.Set_Direction(Language.Direction.RIGHT_TO_LEFT)):"ArrowRight"===e.key?(e.preventDefault(),this.Set_Direction(Language.Direction.LEFT_TO_RIGHT)):"ArrowDown"===e.key?(e.preventDefault(),this.is_in_point_mode=!0,this.Touch()):"ArrowUp"===e.key?(e.preventDefault(),this.is_in_point_mode=!1,this.Touch()):"|"===e.key?(e.preventDefault(),this.are_rows_expanded=!this.are_rows_expanded,this.Touch()):"`"===e.key?(e.preventDefault(),this.Highlight_Next_Class(["UNKNOWN_POINT","UNKNOWN_WORD","UNKNOWN_BREAK"])):"1"===e.key?(e.preventDefault(),this.Highlight_Next_Class(["KNOWN_WORD_ERROR","KNOWN_BREAK_ERROR","BAD_COMMAND"])):"~"===e.key?(e.preventDefault(),this.Highlight_Next(["⸨fix⸩","⸨/fix⸩"])):"!"===e.key&&(e.preventDefault(),this.Highlight_Next(["⸨b⸩","⸨/b⸩"])):"Escape"===e.key&&(e.preventDefault(),this.is_meta_key_active=!0)}On_Key_Up(e){"Escape"===e.key&&(e.preventDefault(),this.is_meta_key_active=!1)}}Utils.Create_Style_Element(`\n        ${Fonts.Singleton().CSS_Definitions()}\n        \n        * {\n            box-sizing: border-box;\n            margin: 0;\n            padding: 0;\n        }\n\n        *:focus {\n            outline: 0;\n        }\n        \n        html, body {\n            width: 100%;\n            height: 100%;\n\n            background-color: black;\n\n            font-family: sans-serif;\n            font-size: 24px;\n        }\n\n        body {\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            align-items: center;\n        }\n\n        span {\n            display: inline-block;\n        }\n\n        .ITALIC {\n            font-style: italic;\n        }\n\n        .BOLD {\n            font-weight: bold;\n        }\n\n        .UNDERLINE {\n            text-decoration: underline;\n        }\n        \n        .SMALL_CAPS {\n            font-variant: small-caps;\n        }\n\n        .ERROR {\n            color: #ffcbcb;\n        }\n\n        .Argument {\n\n        }\n\n        .INDENT {\n            width: 6em;\n        }\n\n        .SEPARATE_POINT {\n            display: inline-block;\n\n            min-width: 7px;\n\n            text-align: center;\n        }\n\n        .UNKNOWN_POINT {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: #ffff00;\n\n            overflow-wrap: normal;\n        }\n\n        .KNOWN_LETTER {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: transparent;\n\n            overflow-wrap: normal;\n        }\n\n        .KNOWN_MARKER {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: transparent;\n\n            overflow-wrap: normal;\n        }\n\n        .UNKNOWN_WORD {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: #ff5858;\n\n            overflow-wrap: normal;\n        }\n\n        .KNOWN_WORD {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: transparent;\n\n            overflow-wrap: normal;\n        }\n\n        .UNKNOWN_BREAK {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: #00da6f;\n\n            overflow-wrap: normal;\n        }\n\n        .KNOWN_BREAK {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: transparent;\n\n            overflow-wrap: normal;\n        }\n\n        .KNOWN_WORD_ERROR {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: #e767c3;\n\n            overflow-wrap: normal;\n        }\n\n        .KNOWN_BREAK_ERROR {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: #e767c3;\n\n            overflow-wrap: normal;\n        }\n\n        .COMMAND {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: transparent;\n            \n            overflow-wrap: normal;\n        }\n\n        .BAD_COMMAND {\n            border-width: 0 0 2px 0;\n            border-style: solid;\n            border-color: orange;\n            \n            overflow-wrap: normal;\n        }\n\n        .COLUMN {\n            width: 100%;\n\n            text-align: center;\n        }\n\n        .COLLAPSED_ROW {\n\n        }\n\n        .EXPANDED_ROW {\n            width: 100%;\n\n            text-align: right;\n        }\n\n        .MARGIN {\n            width: 100%;\n\n            text-align: center;\n        }\n\n        .INTERLINEAR {\n            width: 100%;\n\n            text-align: center;\n        }\n\n        .Modal {\n            display: flex;\n            flex-direction: column;\n            justify-content: center;\n            align-items: center;\n\n            position: absolute;\n            left: 0;\n            top: 0;\n            z-index: 1;\n\n            width: 100%;\n            height: 100%;\n\n            background-color: rgba(0, 0, 0, 0.7);\n\n            font-size: 18px;\n        }\n\n        .Modal_Message {\n            width: 67%;\n            margin: 2px;\n            padding: 7px;\n\n            background-color: #0f1318;\n\n            color: #E0ECFF;\n            text-align: center;\n        }\n\n        .Modal_Options {\n            display: grid;\n            grid-template-columns: 1fr;\n\n            grid-gap: 12px;\n\n            width: 67%;\n            padding: 7px;\n\n            background-color: #0f1318;\n\n            color: #E0ECFF;\n        }\n\n        .Modal_Options_1 {\n            grid-template-rows: 1fr;\n        }\n\n        .Modal_Options_3 {\n            grid-template-rows: 1fr 1fr 1fr;\n        }\n\n        .Modal_Button {\n            display: flex;\n            justify-content: center;\n            align-items: center;\n\n            border-width: 2px;\n            border-style: solid;\n            border-color: #3B3A32;\n\n            cursor: pointer;\n            user-select: none;\n        }\n    `),new Editor({parent:document.body});