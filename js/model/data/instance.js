var __awaiter=this&&this.__awaiter||function(e,a,n,s){return new(n||(n=Promise))((function(o,t){function r(e){try{y(s.next(e))}catch(e){t(e)}}function i(e){try{y(s.throw(e))}catch(e){t(e)}}function y(e){var a;e.done?o(e.value):(a=e.value,a instanceof n?a:new n((function(e){e(a)}))).then(r,i)}y((s=s.apply(e,a||[])).next())}))};import*as Utils from"../../utils.js";import*as Entity from"../entity.js";import*as Name_Sorter from"../name_sorter.js";import{Type}from"./type.js";import*as Consts from"./consts.js";import*as Info from"./info.js";import*as Cache from"./cache.js";import*as Book from"./book.js";export class Instance extends Entity.Instance{constructor(){super(),this.cache=new Cache.Instance,this.info=null,this.default_info=new Info.Instance({}),this.books=[],this.default_info.Finalize(),this.Add_Dependencies([this.cache])}Cache(){return this.cache}Info(){return null!=this.info?this.info:(this.Update_Info(),this.default_info)}Update_Info(){return __awaiter(this,void 0,void 0,(function*(){if(this.info=(yield this.Cache().Info(!0))||this.info,this.books=[],null!=this.info)for(const e of this.info.Tree().books)this.books.push(new Book.Instance({data:this,branch:e}))}))}Name(){return this.Path()}Path(){return Consts.PATH}Books_Path(){return Consts.BOOKS_PATH}Book(e){0;for(const a of this.books)if(a.Name()===e)return a;return 0,this.books[0]}Book_Count(){return 0,this.books.length}Book_At(e){return 0,0,0,this.books[e]}Books(){return 0,Array.from(this.books)}Names({of:e,language_names_must_have_files:a}){return 0,1===e.length?(0,e[0].Type()===Type.BOOKS||e[0].Type()===Type.BOOK?this.Book_Names():e[0].Type()===Type.LANGUAGES||e[0].Type()===Type.LANGUAGE?a?this.Language_Names_Having_Files():this.Language_Names():e[0].Type()===Type.VERSIONS||e[0].Type()===Type.VERSION?this.Version_Names():(0,[])):2===e.length?(0,0,e[0].Type()!==Type.BOOKS&&e[0].Type()!==Type.BOOK||e[1].Type()!==Type.LANGUAGES&&e[1].Type()!==Type.LANGUAGE?e[0].Type()!==Type.BOOKS&&e[0].Type()!==Type.BOOK||e[1].Type()!==Type.VERSIONS&&e[1].Type()!==Type.VERSION?e[0].Type()!==Type.LANGUAGES&&e[0].Type()!==Type.LANGUAGE||e[1].Type()!==Type.BOOKS&&e[1].Type()!==Type.BOOK?e[0].Type()!==Type.LANGUAGES&&e[0].Type()!==Type.LANGUAGE||e[1].Type()!==Type.VERSIONS&&e[1].Type()!==Type.VERSION?e[0].Type()!==Type.VERSIONS&&e[0].Type()!==Type.VERSION||e[1].Type()!==Type.BOOKS&&e[1].Type()!==Type.BOOK?e[0].Type()!==Type.VERSIONS&&e[0].Type()!==Type.VERSION||e[1].Type()!==Type.LANGUAGES&&e[1].Type()!==Type.LANGUAGE?(0,[]):this.Version_Language_Names({version_name:e[0].Name()}):this.Version_Book_Names({version_name:e[0].Name()}):this.Language_Version_Names({language_name:e[0].Name()}):this.Language_Book_Names({language_name:e[0].Name()}):this.Book_Version_Names({book_name:e[0].Name()}):this.Book_Language_Names({book_name:e[0].Name()})):3===e.length?(0,0,e[0].Type()!==Type.BOOKS&&e[0].Type()!==Type.BOOK||e[1].Type()!==Type.LANGUAGES&&e[1].Type()!==Type.LANGUAGE||e[2].Type()!==Type.VERSIONS&&e[2].Type()!==Type.VERSION?e[0].Type()!==Type.BOOKS&&e[0].Type()!==Type.BOOK||e[1].Type()!==Type.VERSIONS&&e[1].Type()!==Type.VERSION||e[2].Type()!==Type.LANGUAGES&&e[2].Type()!==Type.LANGUAGE?e[0].Type()!==Type.LANGUAGES&&e[0].Type()!==Type.LANGUAGE||e[1].Type()!==Type.BOOKS&&e[1].Type()!==Type.BOOK||e[2].Type()!==Type.VERSIONS&&e[2].Type()!==Type.VERSION?e[0].Type()!==Type.LANGUAGES&&e[0].Type()!==Type.LANGUAGE||e[1].Type()!==Type.VERSIONS&&e[1].Type()!==Type.VERSION||e[2].Type()!==Type.BOOKS&&e[2].Type()!==Type.BOOK?e[0].Type()!==Type.VERSIONS&&e[0].Type()!==Type.VERSION||e[1].Type()!==Type.BOOKS&&e[1].Type()!==Type.BOOK||e[2].Type()!==Type.LANGUAGES&&e[2].Type()!==Type.LANGUAGE?e[0].Type()!==Type.VERSIONS&&e[0].Type()!==Type.VERSION||e[1].Type()!==Type.LANGUAGES&&e[1].Type()!==Type.LANGUAGE||e[2].Type()!==Type.BOOKS&&e[2].Type()!==Type.BOOK?(0,[]):this.Version_Language_Book_Names({version_name:e[0].Name(),language_name:e[1].Name()}):this.Version_Book_Language_Names({version_name:e[0].Name(),book_name:e[1].Name()}):this.Language_Version_Book_Names({language_name:e[0].Name(),version_name:e[1].Name()}):this.Language_Book_Version_Names({language_name:e[0].Name(),book_name:e[1].Name()}):this.Book_Version_Language_Names({book_name:e[0].Name(),version_name:e[1].Name()}):this.Book_Language_Version_Names({book_name:e[0].Name(),language_name:e[1].Name()})):4===e.length?(0,0,0,e[0].Type()!==Type.BOOKS&&e[0].Type()!==Type.BOOK||e[1].Type()!==Type.LANGUAGES&&e[1].Type()!==Type.LANGUAGE||e[2].Type()!==Type.VERSIONS&&e[2].Type()!==Type.VERSION?e[0].Type()!==Type.BOOKS&&e[0].Type()!==Type.BOOK||e[1].Type()!==Type.VERSIONS&&e[1].Type()!==Type.VERSION||e[2].Type()!==Type.LANGUAGES&&e[2].Type()!==Type.LANGUAGE?e[0].Type()!==Type.LANGUAGES&&e[0].Type()!==Type.LANGUAGE||e[1].Type()!==Type.BOOKS&&e[1].Type()!==Type.BOOK||e[2].Type()!==Type.VERSIONS&&e[2].Type()!==Type.VERSION?e[0].Type()!==Type.LANGUAGES&&e[0].Type()!==Type.LANGUAGE||e[1].Type()!==Type.VERSIONS&&e[1].Type()!==Type.VERSION||e[2].Type()!==Type.BOOKS&&e[2].Type()!==Type.BOOK?e[0].Type()!==Type.VERSIONS&&e[0].Type()!==Type.VERSION||e[1].Type()!==Type.BOOKS&&e[1].Type()!==Type.BOOK||e[2].Type()!==Type.LANGUAGES&&e[2].Type()!==Type.LANGUAGE?e[0].Type()!==Type.VERSIONS&&e[0].Type()!==Type.VERSION||e[1].Type()!==Type.LANGUAGES&&e[1].Type()!==Type.LANGUAGE||e[2].Type()!==Type.BOOKS&&e[2].Type()!==Type.BOOK?(0,[]):this.File_Names({book_name:e[2].Name(),language_name:e[1].Name(),version_name:e[0].Name()}):this.File_Names({book_name:e[1].Name(),language_name:e[2].Name(),version_name:e[0].Name()}):this.File_Names({book_name:e[2].Name(),language_name:e[0].Name(),version_name:e[1].Name()}):this.File_Names({book_name:e[1].Name(),language_name:e[0].Name(),version_name:e[2].Name()}):this.File_Names({book_name:e[0].Name(),language_name:e[2].Name(),version_name:e[1].Name()}):this.File_Names({book_name:e[0].Name(),language_name:e[1].Name(),version_name:e[2].Name()})):(0,[])}Book_Names(){return 0,this.Info().Unique_Book_Names()}Book_Language_Names({book_name:e}){0;const a=new Set;for(const n of this.Books())if(n.Name()===e){for(const e of n.Languages())a.add(e.Name());break}return Name_Sorter.Singleton().With_Set(Name_Sorter.Type.LANGUAGES,a)}Book_Version_Names({book_name:e}){0;const a=new Set;for(const n of this.Books())if(n.Name()===e){for(const e of n.Languages())for(const n of e.Versions())a.add(n.Name());break}return Name_Sorter.Singleton().With_Set(Name_Sorter.Type.VERSIONS,a)}Book_Language_Version_Names({book_name:e,language_name:a}){0;const n=new Set;for(const s of this.Books())if(s.Name()===e){for(const e of s.Languages())if(e.Name()===a){for(const a of e.Versions())n.add(a.Name());break}break}return Name_Sorter.Singleton().With_Set(Name_Sorter.Type.VERSIONS,n)}Book_Version_Language_Names({book_name:e,version_name:a}){0;const n=new Set;for(const s of this.Books())if(s.Name()===e){for(const e of s.Languages())for(const s of e.Versions())if(s.Name()===a){n.add(e.Name());break}break}return Name_Sorter.Singleton().With_Set(Name_Sorter.Type.LANGUAGES,n)}Language_Names(){return 0,this.Info().Unique_Language_Names()}Language_Names_Having_Files(){return 0,this.Info().Unique_Language_Names_Having_Files()}Language_Book_Names({language_name:e}){0;const a=new Set;for(const n of this.Books())for(const s of n.Languages())if(s.Name()===e){a.add(n.Name());break}return Name_Sorter.Singleton().With_Set(Name_Sorter.Type.BOOKS,a)}Language_Version_Names({language_name:e}){0;const a=new Set;for(const n of this.Books())for(const s of n.Languages())if(s.Name()===e){for(const e of s.Versions())a.add(e.Name());break}return Name_Sorter.Singleton().With_Set(Name_Sorter.Type.VERSIONS,a)}Language_Book_Version_Names({language_name:e,book_name:a}){0;const n=new Set;for(const s of this.Books())if(s.Name()===a){for(const a of s.Languages())if(a.Name()===e){for(const e of a.Versions())n.add(e.Name());break}break}return Name_Sorter.Singleton().With_Set(Name_Sorter.Type.VERSIONS,n)}Language_Version_Book_Names({language_name:e,version_name:a}){0;const n=new Set;for(const s of this.Books())for(const o of s.Languages())if(o.Name()===e){for(const e of o.Versions())if(e.Name()===a){n.add(s.Name());break}break}return Name_Sorter.Singleton().With_Set(Name_Sorter.Type.BOOKS,n)}Version_Names(){return 0,this.Info().Unique_Version_Names()}Version_Book_Names({version_name:e}){0;const a=new Set;for(const n of this.Books())for(const s of n.Languages())for(const o of s.Versions())if(o.Name()===e){a.add(n.Name());break}return Name_Sorter.Singleton().With_Set(Name_Sorter.Type.BOOKS,a)}Version_Language_Names({version_name:e}){0;const a=new Set;for(const n of this.Books())for(const s of n.Languages())for(const n of s.Versions())if(n.Name()===e){a.add(s.Name());break}return Name_Sorter.Singleton().With_Set(Name_Sorter.Type.LANGUAGES,a)}Version_Book_Language_Names({version_name:e,book_name:a}){0;const n=new Set;for(const s of this.Books())if(s.Name()===a){for(const a of s.Languages())for(const s of a.Versions())if(s.Name()===e){n.add(a.Name());break}break}return Name_Sorter.Singleton().With_Set(Name_Sorter.Type.LANGUAGES,n)}Version_Language_Book_Names({version_name:e,language_name:a}){0;const n=new Set;for(const s of this.Books())for(const o of s.Languages())if(o.Name()===a){for(const a of o.Versions())if(a.Name()===e){n.add(s.Name());break}break}return Name_Sorter.Singleton().With_Set(Name_Sorter.Type.BOOKS,n)}Versions({book_names:e=null,language_names:a=null,version_names:n=null}){0;const s=[];null==e&&(e=this.Book_Names()),null==a&&(a=this.Language_Names()),null==n&&(n=this.Version_Names());for(const o of this.Books())if(e.includes(o.Name()))for(const e of o.Languages())if(a.includes(e.Name()))for(const a of e.Versions())n.includes(a.Name())&&s.push(a);return s}Files({book_name:e,language_name:a,version_name:n}){return 0,this.Book(e).Language(a).Version(n).Files()}File({book_name:e,language_name:a,version_name:n,file_name:s}){return 0,this.Book(e).Language(a).Version(n).File(s)}File_Names({book_name:e,language_name:a,version_name:n}){return 0,this.Files({book_name:e,language_name:a,version_name:n}).map((function(e){return e.Title()}))}After_Dependencies_Are_Ready(){return __awaiter(this,void 0,void 0,(function*(){yield this.Update_Info()}))}}let singleton=null;export function Singleton(){return null==singleton&&(singleton=new Instance),singleton}