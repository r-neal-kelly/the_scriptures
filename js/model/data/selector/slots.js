var __awaiter=this&&this.__awaiter||function(e,t,s,o){return new(s||(s=Promise))((function(l,n){function i(e){try{S(o.next(e))}catch(e){n(e)}}function a(e){try{S(o.throw(e))}catch(e){n(e)}}function S(e){var t;e.done?l(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(i,a)}S((o=o.apply(e,t||[])).next())}))};import*as Utils from"../../../utils.js";import*as Data from"../../data.js";import*as Entity from"../../entity.js";import*as Selection from"../../data/selection.js";import*as Slot from"./slot.js";export class Instance extends Entity.Instance{static Max_Count(){return Instance.MAX_SLOT_COUNT}static Slot_To_Data_Type(e){return e===Slot.Type.BOOKS?Data.Type.BOOKS:e===Slot.Type.LANGUAGES?Data.Type.LANGUAGES:e===Slot.Type.VERSIONS?Data.Type.VERSIONS:e===Slot.Type.FILES?Data.Type.FILES:(Utils.Assert(!1,"Invalid slot_type."),Data.Type.BOOKS)}constructor({selector:e,order:t,selection:s=null}){super(),this.selector=e,this.order=t,this.first_selection=s,this.slots=[],this.selected_data_file=null,this.Add_Dependencies([Data.Singleton()])}Selector(){return this.selector}Order(){return this.order}Reorder(e){}Count(){return this.slots.length}Has(e){return this.slots.includes(e)}Has_Type(e){for(const t of this.slots)if(t.Type()===e)return!0;return!1}From_Type(e){for(const t of this.slots)if(t.Type()===e)return t;return Utils.Assert(!1,"Does not have slot with that type."),this.slots[0]}At(e){return Utils.Assert(e>-1,"slot_index must be greater than -1."),Utils.Assert(e<this.Count(),"slot_index must be less than slot_count."),this.slots[e]}Array(){return Array.from(this.slots)}Types(){const e=this.Order(),t=[];return e===Slot.Order.BOOKS_LANGUAGES_VERSIONS?(t.push(Slot.Type.BOOKS),t.push(Slot.Type.LANGUAGES),t.push(Slot.Type.VERSIONS)):e===Slot.Order.BOOKS_VERSIONS_LANGUAGES?(t.push(Slot.Type.BOOKS),t.push(Slot.Type.VERSIONS),t.push(Slot.Type.LANGUAGES)):e===Slot.Order.LANGUAGES_BOOKS_VERSIONS?(t.push(Slot.Type.LANGUAGES),t.push(Slot.Type.BOOKS),t.push(Slot.Type.VERSIONS)):e===Slot.Order.LANGUAGES_VERSIONS_BOOKS?(t.push(Slot.Type.LANGUAGES),t.push(Slot.Type.VERSIONS),t.push(Slot.Type.BOOKS)):e===Slot.Order.VERSIONS_BOOKS_LANGUAGES?(t.push(Slot.Type.VERSIONS),t.push(Slot.Type.BOOKS),t.push(Slot.Type.LANGUAGES)):e===Slot.Order.VERSIONS_LANGUAGES_BOOKS?(t.push(Slot.Type.VERSIONS),t.push(Slot.Type.LANGUAGES),t.push(Slot.Type.BOOKS)):Utils.Assert(!1,"Unknown slot_type."),t.push(Slot.Type.FILES),Utils.Assert(t.length===Instance.Max_Count(),"slot_types must have all types."),t}Push(){const e=Instance.Max_Count(),t=this.Count();Utils.Assert(t<e,"All slots have been pushed already.");const s=t,o=this.Types()[s],l=this.Array().map(function(e,s){let o;return 0===s&&0===t?o=null:(Utils.Assert(e.Items().Has_Selected(),"To push a new slot, each previous slot must have a selected item."),o=e.Items().Selected().Name()),new Data.Query.Type_And_Name({type:Instance.Slot_To_Data_Type(e.Type()),name:o})}.bind(this));l.push(new Data.Query.Type_And_Name({type:Instance.Slot_To_Data_Type(o),name:null}));const n=Data.Singleton().Names(l),i=o===Slot.Type.FILES?Data.Singleton().Files({book_name:this.Books().Items().Selected().Name(),language_name:this.Languages().Items().Selected().Name(),version_name:this.Versions().Items().Selected().Name()}):null;this.slots.push(new Slot.Instance({slots:this,index:s,type:o,item_names:n,item_files:i}))}Pop(){this.slots.pop()}Has_Books(){return this.Has_Type(Slot.Type.BOOKS)}Books(){return Utils.Assert(this.Has_Books(),"Doesn't have books."),this.From_Type(Slot.Type.BOOKS)}Has_Languages(){return this.Has_Type(Slot.Type.LANGUAGES)}Languages(){return Utils.Assert(this.Has_Languages(),"Doesn't have languages."),this.From_Type(Slot.Type.LANGUAGES)}Has_Versions(){return this.Has_Type(Slot.Type.VERSIONS)}Versions(){return Utils.Assert(this.Has_Versions(),"Doesn't have versions."),this.From_Type(Slot.Type.VERSIONS)}Has_Files(){return this.Has_Type(Slot.Type.FILES)}Files(){return Utils.Assert(this.Has_Files(),"Doesn't have files."),this.From_Type(Slot.Type.FILES)}Maybe_Selected_Data_File(){return this.selected_data_file}As_String(){const e=this.Count();if(e>0){let t="";for(let s=0,o=e;s<o;){const e=this.At(s);e.Items().Has_Selected()?t+=e.Items().Selected().Title():t+=e.Title().Value(),s+=1,s<o&&(t+=" â€” ")}return t}return null}As_Short_String(){if(this.Count()>0){const e=this.At(0);return e.Items().Has_Selected()?e.Items().Selected().Title():e.Title().Value()}return null}Select_Item_Internally({slot:e}){if(Utils.Assert(this.Has(e),"The slot does not belong to this selector."),e.Type()===Slot.Type.FILES)this.selected_data_file=Data.Singleton().File({book_name:this.Books().Items().Selected().Name(),language_name:this.Languages().Items().Selected().Name(),version_name:this.Versions().Items().Selected().Name(),file_name:this.Files().Items().Selected().Name()});else if(this.At(this.Count()-1)===e)this.Push();else{const t=this.Has_Books()&&this.Books().Items().Has_Selected()?this.Books().Items().Selected().Name():null,s=this.Has_Languages()&&this.Languages().Items().Has_Selected()?this.Languages().Items().Selected().Name():null,o=this.Has_Versions()&&this.Versions().Items().Has_Selected()?this.Versions().Items().Selected().Name():null,l=this.Has_Files()&&this.Files().Items().Has_Selected()?this.Files().Items().Selected().Name():null;for(;this.Count()>e.Index()+1;)this.Pop();for(this.Push();this.Count()<Instance.Max_Count();){const e=this.At(this.Count()-1);let l=null;if(e.Type()===Slot.Type.BOOKS&&null!=t?l=e.Items().Maybe_From(t):e.Type()===Slot.Type.LANGUAGES&&null!=s?l=e.Items().Maybe_From(s):e.Type()===Slot.Type.VERSIONS&&null!=o&&(l=e.Items().Maybe_From(o)),null==l)return;l.Select()}const n=this.At(this.Count()-1);if(n.Type()===Slot.Type.FILES&&null!=l){const e=n.Items().Maybe_From(l);if(null==e)return;e.Select()}}}Select(e){const t=this.Types();for(let s=0,o=Instance.Max_Count();s<o;s+=1){s===this.Count()&&this.Push();const o=t[s];o===Slot.Type.BOOKS?this.Books().Items().From(e.Book()).Select():o===Slot.Type.LANGUAGES?this.Languages().Items().From(e.Language()).Select():o===Slot.Type.VERSIONS?this.Versions().Items().From(e.Version()).Select():o===Slot.Type.FILES&&this.Files().Items().From(e.File()).Select()}}Select_At(e){const t=this.Types();for(let s=0,o=Instance.Max_Count();s<o;s+=1){s===this.Count()&&this.Push();const o=t[s];o===Slot.Type.BOOKS?this.Books().Items().At(e.Book()).Select():o===Slot.Type.LANGUAGES?this.Languages().Items().At(e.Language()).Select():o===Slot.Type.VERSIONS?this.Versions().Items().At(e.Version()).Select():o===Slot.Type.FILES&&this.Files().Items().At(e.File()).Select()}}After_Dependencies_Are_Ready(){return __awaiter(this,void 0,void 0,(function*(){this.first_selection instanceof Selection.Name?this.Select(this.first_selection):this.first_selection instanceof Selection.Index?this.Select_At(this.first_selection):this.Push()}))}}Instance.MAX_SLOT_COUNT=4;