var __awaiter=this&&this.__awaiter||function(e,i,s,t){return new(s||(s=Promise))((function(n,_){function r(e){try{c(t.next(e))}catch(e){_(e)}}function o(e){try{c(t.throw(e))}catch(e){_(e)}}function c(e){var i;e.done?n(e.value):(i=e.value,i instanceof s?i:new s((function(e){e(i)}))).then(r,o)}c((t=t.apply(e,i||[])).next())}))};import*as Utils from"../../utils.js";import*as Circle_Buffer from"../../circle_buffer.js";import*as Compressor from"../../compressor.js";import*as Text from"../text.js";import*as Consts from"./consts.js";import*as Info from"./info.js";import*as Version from"./version.js";import*as File from"./file.js";class Version_Cache{constructor({id:e,compressed_unique_parts_json:i,compressed_dictionary_json:s}){this.id=e,this.decompressor=new Version.Decompressor.Instance({unique_parts:JSON.parse(Compressor.LZSS_Decompress(i))}),this.dictionary=new Text.Dictionary.Instance({json:this.decompressor.Decompress_Dictionary({dictionary_value:s})}),this.reference_count=0}ID(){return this.id}Decompressor(){return this.decompressor}Dictionary(){return this.dictionary}Reference_Count(){return this.reference_count}Increment_Reference_Count(){0,this.reference_count+=1}Decrement_Reference_Count(){0,this.reference_count-=1}}class File_Cache{constructor({id:e,version_id:i,compressed_file_text:s}){this.id=e,this.version_id=i,this.compressed_file_text=s}ID(){return this.id}Version_ID(){return this.version_id}Compressed_File_Text(){return this.compressed_file_text}}export class Instance{constructor({version_cache_limit:e=Consts.DEFAULT_VERSION_CACHE_LIMIT,file_cache_limit:i=Consts.DEFAULT_FILE_CACHE_LIMIT}={}){this.info=null,this.version_buffer=new Circle_Buffer.Instance({capacity:e,initial_unit:""}),this.version_caches={},this.file_buffer=new Circle_Buffer.Instance({capacity:i,initial_unit:""}),this.file_caches={}}String(e,{fetch_attempt_count:i=0,fetch_attempt_limit:s=Consts.DEFAULT_FETCH_ATTEMPT_LIMIT}={}){return __awaiter(this,void 0,void 0,(function*(){if(!(i<s))return null;try{const t=yield fetch(Utils.Resolve_Path(e));return t.ok?yield t.text():this.String(e,{fetch_attempt_count:i+1,fetch_attempt_limit:s})}catch(t){return this.String(e,{fetch_attempt_count:i+1,fetch_attempt_limit:s})}}))}Info(e=!1){return __awaiter(this,void 0,void 0,(function*(){if(e&&(this.info=null),null!=this.info)return this.info;{const e=yield this.String(Consts.INFO_PATH);return null!=e&&(this.info=new Info.Instance({json:Compressor.LZSS_Decompress(e)})),this.info}}))}Has_Version_Cache(e){return null!=this.version_caches[e]}Version_Cache(e){return 0,this.version_caches[e]}Add_Version_Cache(e){0,this.version_buffer.Is_Full()&&this.Remove_Version_Cache_By_Index(0);const i=e.ID();this.version_buffer.Add_Back(i),this.version_caches[i]=e}Remove_Version_Cache_By_Index(e){0;const i=this.version_buffer.At(e),s=this.Version_Cache(i);if(s.Reference_Count()>0){for(let e=this.file_buffer.Count(),s=0;e>s;){e-=1;const s=this.file_buffer.At(e);this.File_Cache(s).Version_ID()===i&&this.Remove_File_Cache_By_Index(e)}0,0}else delete this.version_caches[i],this.version_buffer.Remove_At(e)}Remove_Version_Cache_By_ID(e){0;const i=this.version_buffer.Index_Of(e);0,this.Remove_Version_Cache_By_Index(i)}Remove_Version_Cache(e){this.Remove_Version_Cache_By_ID(e.ID())}Has_File_Cache(e){return null!=this.file_caches[e]}File_Cache(e){return 0,this.file_caches[e]}Add_File_Cache(e){0,0,this.file_buffer.Is_Full()&&this.Remove_File_Cache_By_Index(0);const i=e.ID();this.file_buffer.Add_Back(i),this.file_caches[i]=e,this.Version_Cache(e.Version_ID()).Increment_Reference_Count()}Remove_File_Cache_By_Index(e){0;const i=this.file_buffer.At(e),s=this.File_Cache(i),t=this.Version_Cache(s.Version_ID());delete this.file_caches[i],this.file_buffer.Remove_At(e),t.Decrement_Reference_Count(),t.Reference_Count()<1&&this.Remove_Version_Cache(t)}Remove_File_Cache_By_ID(e){0;const i=this.file_buffer.Index_Of(e);0,this.Remove_File_Cache_By_Index(i)}Remove_File_Cache(e){this.Remove_File_Cache_By_ID(e.ID())}Dictionary(e){return __awaiter(this,void 0,void 0,(function*(){if(this.Has_Version_Cache(e))return this.Version_Cache(e).Dictionary();{const[i,s]=yield Promise.all([this.String(`${e}/${Consts.UNIQUE_PARTS_NAME}`),this.String(`${e}/${Consts.DICTIONARY_NAME}`)]);return this.Has_Version_Cache(e)?this.Version_Cache(e).Dictionary():null!=i&&null!=s?(this.Add_Version_Cache(new Version_Cache({id:e,compressed_unique_parts_json:i,compressed_dictionary_json:s})),this.Version_Cache(e).Dictionary()):null}}))}Add_Missing_File_Caches(e,i){0;for(let s=0,t=i.length;s<t;s+=1){const[t,n]=i[s];this.Has_File_Cache(t)||null==n||this.Add_File_Cache(new File_Cache({id:t,version_id:e,compressed_file_text:n}))}}Add_Missing_File_Caches_With_Version_Text(e,i,s){const t=s.split(Consts.VERSION_TEXT_FILE_BREAK);0,this.Add_Missing_File_Caches(e,t.map((function(s,t){return[`${e}/${i[t]}`,s]})))}Add_Full_Version_Cache_With_Version_Test(e,i){return __awaiter(this,void 0,void 0,(function*(){const[s,t,n]=yield Promise.all([this.String(`${e}/${Consts.UNIQUE_PARTS_NAME}`),this.String(`${e}/${Consts.DICTIONARY_NAME}`),this.String(`${e}/${Consts.VERSION_TEXT_NAME}`)]);this.Has_Version_Cache(e)?null!=n&&this.Add_Missing_File_Caches_With_Version_Text(e,i,n):null!=s&&null!=t&&null!=n&&(this.Add_Version_Cache(new Version_Cache({id:e,compressed_unique_parts_json:s,compressed_dictionary_json:t})),this.Add_Missing_File_Caches_With_Version_Text(e,i,n))}))}Cache_Version_And_Files(e,i,{attempt_count:s=0,attempt_limit:t=Consts.DEFAULT_VERSION_CACHE_ATTEMPT_LIMIT}={}){return __awaiter(this,void 0,void 0,(function*(){const n=e;if(this.Has_Version_Cache(n)){const s=this.Version_Cache(n).Reference_Count();0;const t=i.length-s;if(t>0)if(t<=Consts.VERSION_FILE_FETCH_LIMIT){const s=yield Promise.all(i.filter(function(i){const s=`${e}/${i}`;return!this.Has_File_Cache(s)}.bind(this)).map(function(i){return __awaiter(this,void 0,void 0,(function*(){const s=`${e}/${i}`;return[s,yield this.String(s)]}))}.bind(this)));this.Has_Version_Cache(n)?this.Add_Missing_File_Caches(n,s):yield this.Add_Full_Version_Cache_With_Version_Test(e,i)}else{const s=yield this.String(`${e}/${Consts.VERSION_TEXT_NAME}`);if(null!=s)if(this.Has_Version_Cache(n))this.Add_Missing_File_Caches_With_Version_Text(e,i,s);else{const[t,_]=yield Promise.all([this.String(`${e}/${Consts.UNIQUE_PARTS_NAME}`),this.String(`${e}/${Consts.DICTIONARY_NAME}`)]);this.Has_Version_Cache(n)?this.Add_Missing_File_Caches_With_Version_Text(e,i,s):null!=t&&null!=_&&(this.Add_Version_Cache(new Version_Cache({id:e,compressed_unique_parts_json:t,compressed_dictionary_json:_})),this.Add_Missing_File_Caches_With_Version_Text(e,i,s))}}}else yield this.Add_Full_Version_Cache_With_Version_Test(e,i);if((!this.Has_Version_Cache(n)||this.Version_Cache(n).Reference_Count()<i.length)&&s<t)return this.Cache_Version_And_Files(e,i,{attempt_count:s+1,attempt_limit:t})}))}Version_And_File_Cache(e,i){return __awaiter(this,void 0,void 0,(function*(){if(!this.Has_File_Cache(i))if(this.Has_Version_Cache(e)){const s=yield this.String(i);if(this.Has_Version_Cache(e)){if(!this.Has_File_Cache(i)){if(null==s)return null;this.Add_File_Cache(new File_Cache({id:i,version_id:e,compressed_file_text:s}))}}else{if(null==s)return null;{const[t,n]=yield Promise.all([this.String(`${e}/${Consts.UNIQUE_PARTS_NAME}`),this.String(`${e}/${Consts.DICTIONARY_NAME}`)]);if(this.Has_Version_Cache(e))this.Has_File_Cache(i)||this.Add_File_Cache(new File_Cache({id:i,version_id:e,compressed_file_text:s}));else{if(null==t||null==n)return null;this.Add_Version_Cache(new Version_Cache({id:e,compressed_unique_parts_json:t,compressed_dictionary_json:n})),0,this.Add_File_Cache(new File_Cache({id:i,version_id:e,compressed_file_text:s}))}}}}else{const[s,t,n]=yield Promise.all([this.String(`${e}/${Consts.UNIQUE_PARTS_NAME}`),this.String(`${e}/${Consts.DICTIONARY_NAME}`),this.String(i)]);if(this.Has_Version_Cache(e)){if(!this.Has_File_Cache(i)){if(null==n)return null;this.Add_File_Cache(new File_Cache({id:i,version_id:e,compressed_file_text:n}))}}else{if(null==s||null==t||null==n)return null;this.Add_Version_Cache(new Version_Cache({id:e,compressed_unique_parts_json:s,compressed_dictionary_json:t})),0,this.Add_File_Cache(new File_Cache({id:i,version_id:e,compressed_file_text:n}))}}return[this.Version_Cache(e),this.File_Cache(i)]}))}File_Text(e,i,s){return __awaiter(this,void 0,void 0,(function*(){const t=yield this.Version_And_File_Cache(e,`${e}/${i}`);if(null!=t){const[e,i]=t;return new Text.Instance({dictionary:e.Dictionary(),value:e.Decompressor().Decompress_File({dictionary:e.Dictionary(),file_value:i.Compressed_File_Text()}),path_type:s})}return null}))}File_Transfer(e,i){return __awaiter(this,void 0,void 0,(function*(){const s=yield this.Version_And_File_Cache(e,`${e}/${i}`);if(null!=s){const[e,i]=s;return new File.Transfer.Instance({decompressor:e.Decompressor(),dictionary:e.Dictionary(),value:i.Compressed_File_Text()})}return null}))}}