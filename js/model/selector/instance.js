var __awaiter=this&&this.__awaiter||function(e,t,s,l){return new(s||(s=Promise))((function(o,n){function i(e){try{a(l.next(e))}catch(e){n(e)}}function _(e){try{a(l.throw(e))}catch(e){n(e)}}function a(e){var t;e.done?o(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(i,_)}a((l=l.apply(e,t||[])).next())}))};import*as Utils from"../../utils.js";import*as Entity from"../entity.js";import*as Data from"../data.js";import*as Settings from"./settings.js";import*as Slot from"./slot.js";export class Instance extends Entity.Instance{static Max_Slot_Count(){return Instance.MAX_SLOT_COUNT}static Slot_Type_To_Data_Type(e){return e===Slot.Type.BOOKS?Data.Type.BOOKS:e===Slot.Type.LANGUAGES?Data.Type.LANGUAGES:e===Slot.Type.VERSIONS?Data.Type.VERSIONS:e===Slot.Type.FILES?Data.Type.FILES:(0,Data.Type.BOOKS)}constructor({slot_order:e=Slot.Order.LANGUAGES_VERSIONS_BOOKS,does_smart_item_selection:t=!0,selection:s=null}){super(),this.settings=new Settings.Instance({selector:this,slot_order:e,does_smart_item_selection:t}),this.first_selection=s,this.slots=[],this.Add_Dependencies([Data.Singleton()])}Settings(){return this.settings}__Set_Slot_Order__(e){if(this.Settings().Current_Slot_Order_Index()!==e){const t=this.Selection_Name();for(;this.Slot_Count()>0;)this.Pop_Slot();this.Settings().__Set_Current_Slot_Order_Index__(e),this.Select_Item(t)}}Slot_Count(){return this.slots.length}Has_Slot(e){return this.slots.includes(e)}Has_Slot_Type(e){for(const t of this.slots)if(t.Type()===e)return!0;return!1}Slot_From_Type(e){for(const t of this.slots)if(t.Type()===e)return t;return 0,this.slots[0]}Has_Slot_At_Index(e){return 0,e<this.Slot_Count()}Slot_At_Index(e){return 0,0,this.slots[e]}Slots(){return Array.from(this.slots)}Slot_Types(){const e=this.Settings().Current_Slot_Order().Value(),t=[];return e===Slot.Order.BOOKS_LANGUAGES_VERSIONS?(t.push(Slot.Type.BOOKS),t.push(Slot.Type.LANGUAGES),t.push(Slot.Type.VERSIONS)):e===Slot.Order.BOOKS_VERSIONS_LANGUAGES?(t.push(Slot.Type.BOOKS),t.push(Slot.Type.VERSIONS),t.push(Slot.Type.LANGUAGES)):e===Slot.Order.LANGUAGES_BOOKS_VERSIONS?(t.push(Slot.Type.LANGUAGES),t.push(Slot.Type.BOOKS),t.push(Slot.Type.VERSIONS)):e===Slot.Order.LANGUAGES_VERSIONS_BOOKS?(t.push(Slot.Type.LANGUAGES),t.push(Slot.Type.VERSIONS),t.push(Slot.Type.BOOKS)):e===Slot.Order.VERSIONS_BOOKS_LANGUAGES?(t.push(Slot.Type.VERSIONS),t.push(Slot.Type.BOOKS),t.push(Slot.Type.LANGUAGES)):e===Slot.Order.VERSIONS_LANGUAGES_BOOKS?(t.push(Slot.Type.VERSIONS),t.push(Slot.Type.LANGUAGES),t.push(Slot.Type.BOOKS)):0,t.push(Slot.Type.FILES),0,t}Push_Slot(){const e=Instance.Max_Slot_Count(),t=this.Slot_Count();0;const s=t,l=this.Slot_Types()[s],o=this.Slots().map(function(e,s){let l;return 0===s&&0===t?l=null:(0,l=e.Selected_Item().Name()),new Data.Query.Type_And_Name({type:Instance.Slot_Type_To_Data_Type(e.Type()),name:l})}.bind(this));o.push(new Data.Query.Type_And_Name({type:Instance.Slot_Type_To_Data_Type(l),name:null})),this.slots.push(new Slot.Instance({selector:this,index:s,type:l,item_names:Data.Singleton().Names({of:o,language_names_must_have_files:!0})}))}Pop_Slot(){this.slots.pop()}Has_Books(){return this.Has_Slot_Type(Slot.Type.BOOKS)}Books(){return 0,this.Slot_From_Type(Slot.Type.BOOKS)}Has_Book(){return this.Has_Books()&&this.Books().Has_Selected_Item()}Has_Languages(){return this.Has_Slot_Type(Slot.Type.LANGUAGES)}Languages(){return 0,this.Slot_From_Type(Slot.Type.LANGUAGES)}Has_Language(){return this.Has_Languages()&&this.Languages().Has_Selected_Item()}Maybe_Selected_Language_Name(){if(this.Has_Languages()){const e=this.Languages();return e.Has_Selected_Item()?e.Selected_Item().Name():null}return null}Has_Versions(){return this.Has_Slot_Type(Slot.Type.VERSIONS)}Versions(){return 0,this.Slot_From_Type(Slot.Type.VERSIONS)}Has_Version(){return this.Has_Versions()&&this.Versions().Has_Selected_Item()}Has_Files(){return this.Has_Slot_Type(Slot.Type.FILES)}Files(){return 0,this.Slot_From_Type(Slot.Type.FILES)}Has_File(){return this.Has_Files()&&this.Files().Has_Selected_Item()}File(){return 0,Data.Singleton().File({book_name:this.Books().Selected_Item().Name(),language_name:this.Languages().Selected_Item().Name(),version_name:this.Versions().Selected_Item().Name(),file_name:this.Files().Selected_Item().Name()})}Maybe_File(){return this.Has_File()?this.File():null}Selection_Name(){return new Data.Selection.Name({book:this.Has_Book()?this.Books().Selected_Item().Name():null,language:this.Has_Language()?this.Languages().Selected_Item().Name():null,version:this.Has_Version()?this.Versions().Selected_Item().Name():null,file:this.Has_File()?this.Files().Selected_Item().Name():null})}Selection_Index(){return new Data.Selection.Index({book:this.Has_Book()?this.Books().Selected_Item().Index():null,language:this.Has_Language()?this.Languages().Selected_Item().Index():null,version:this.Has_Version()?this.Versions().Selected_Item().Index():null,file:this.Has_File()?this.Files().Selected_Item().Index():null})}File_Or_Versions(){if(this.Has_File())return this.File();{let e=null,t=null,s=null;if(this.Has_Books()){const t=this.Books();t.Has_Selected_Item()&&(e=[t.Selected_Item().Name()])}if(this.Has_Languages()){const e=this.Languages();e.Has_Selected_Item()&&(t=[e.Selected_Item().Name()])}if(this.Has_Versions()){const e=this.Versions();e.Has_Selected_Item()&&(s=[e.Selected_Item().Name()])}return Data.Singleton().Versions({book_names:e,language_names:t,version_names:s})}}As_String(){const e=this.Slot_Count();if(e>0){let t="";for(let s=0,l=e;s<l;){const e=this.Slot_At_Index(s);e.Has_Selected_Item()?t+=e.Selected_Item().Name():t+=e.Name(),s+=1,s<l&&(t+=" — ")}return t}return null}As_Short_String(){const e=this.Slot_Count();if(e>0){let t="";for(let s=0,l=e;s<l;s+=1){const e=this.Slot_At_Index(s);if(!e.Has_Selected_Item()){const s=e.Name();return s.length>4?t+=`${s.slice(0,4).replace(/ +$/,"")}⸼`:t+=`${s}`,t}{const s=e.Selected_Item().Name();e.Type()===Slot.Type.FILES?t+=`${s.replace(/chapter /i,"")} `:s.length>4?t+=`${s.slice(0,4).replace(/ +$/,"")}⸼ `:t+=`${s} `}}return t.slice(0,t.length-1)}return null}__Select_Item__({slot:e,slot_item:t}){if(0,e.__Select_Item__({item:t}),e.Type()!==Slot.Type.FILES)if(this.Slot_At_Index(this.Slot_Count()-1)===e)this.Push_Slot();else if(this.Settings().Does_Smart_Item_Selection()){const t=this.Has_Book()?this.Books().Selected_Item().Name():null,s=this.Has_Language()?this.Languages().Selected_Item().Name():null,l=this.Has_Version()?this.Versions().Selected_Item().Name():null,o=this.Has_File()?this.Files().Selected_Item().Name():null;for(;this.Slot_Count()>e.Index()+1;)this.Pop_Slot();for(this.Push_Slot();this.Slot_Count()<Instance.Max_Slot_Count();){const e=this.Slot_At_Index(this.Slot_Count()-1);let o=null;if(e.Type()===Slot.Type.BOOKS&&null!=t?o=e.Maybe_Item_From_Name(t):e.Type()===Slot.Type.LANGUAGES&&null!=s?o=e.Maybe_Item_From_Name(s):e.Type()===Slot.Type.VERSIONS&&null!=l&&(o=e.Maybe_Item_From_Name(l)),null==o)return;o.Select()}const n=this.Slot_At_Index(this.Slot_Count()-1);if(n.Type()===Slot.Type.FILES&&null!=o){const e=n.Maybe_Item_From_Name(o);if(null==e)return;e.Select()}}else{for(;this.Slot_Count()>e.Index()+1;)this.Pop_Slot();this.Push_Slot()}}Select_Item(e){const t=this.Slot_Types();for(let s=0,l=Instance.Max_Slot_Count();s<l;s+=1){s===this.Slot_Count()&&this.Push_Slot();const l=t[s];if(l===Slot.Type.BOOKS){if(!e.Has_Book())break;this.Books().Item_From_Name(e.Book()).Select()}else if(l===Slot.Type.LANGUAGES){if(!e.Has_Language())break;this.Languages().Item_From_Name(e.Language()).Select()}else if(l===Slot.Type.VERSIONS){if(!e.Has_Version())break;this.Versions().Item_From_Name(e.Version()).Select()}else if(l===Slot.Type.FILES){if(!e.Has_File())break;this.Files().Item_From_Name(e.File()).Select()}}}Select_Item_At(e){const t=this.Slot_Types();for(let s=0,l=Instance.Max_Slot_Count();s<l;s+=1){s===this.Slot_Count()&&this.Push_Slot();const l=t[s];if(l===Slot.Type.BOOKS){if(!e.Has_Book())break;this.Books().Item_At_Index(e.Book()).Select()}else if(l===Slot.Type.LANGUAGES){if(!e.Has_Language())break;this.Languages().Item_At_Index(e.Language()).Select()}else if(l===Slot.Type.VERSIONS){if(!e.Has_Version())break;this.Versions().Item_At_Index(e.Version()).Select()}else if(l===Slot.Type.FILES){if(!e.Has_File())break;this.Files().Item_At_Index(e.File()).Select()}}}After_Dependencies_Are_Ready(){return __awaiter(this,void 0,void 0,(function*(){this.first_selection instanceof Data.Selection.Name?this.Select_Item(this.first_selection):this.first_selection instanceof Data.Selection.Index?this.Select_Item_At(this.first_selection):this.Push_Slot()}))}}Instance.MAX_SLOT_COUNT=4;