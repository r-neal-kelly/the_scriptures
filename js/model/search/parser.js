import*as Unicode from"../../unicode.js";import*as Text from"../text.js";import{Operator}from"./operator.js";import{Boundary}from"./boundary.js";import*as Token from"./token.js";export class Help{constructor(e,r){this.message=e.replace(/\r?\n/g," ").replace(/\s+/g," "),this.expression_index=r}Message(){return this.message}Expression_Index(){return this.expression_index}}export class Instance{constructor(){}Parse(e,r){const n=[];let p=0,t=0,O=0,o=0,a=[];function T(){return n.length>0?n[n.length-1]:null}function E(){const e=T();null==e||e.Type()!==Token.Type.MAYBE_ONE&&e.Type()!==Token.Type.MAYBE_MANY&&e.Type()!==Token.Type.ONE_OR_MANY&&e.Type()!==Token.Type.CLOSE_GROUP&&e.Type()!==Token.Type.CLOSE_SEQUENCE&&e.Type()!==Token.Type.TEXT||(O>0&&(a[a.length-1]+=1),n.push(new Token.And))}function l(e){if(O<1){O+=1,a.push(0),n.push(new Token.Open_Sequence({is_complex:!1}));for(let r=0,p=e.Line(0).Macro_Part_Count();r<p;r+=1)n.push(new Token.Text({part:e.Line(0).Macro_Part(r)})),r<p-1&&(a[a.length-1]+=1,n.push(new Token.And));i(),O-=1,n.push(new Token.Close_Sequence({is_complex:!1}))}else{const r=e.Line(0).Macro_Part_Count();r>1&&(t+=1,o+=1,n.push(new Token.Open_Group));for(let p=0,t=r;p<t;p+=1)n.push(new Token.Text({part:e.Line(0).Macro_Part(p)})),p<t-1&&(a[a.length-1]+=1,n.push(new Token.And));r>1&&(t-=1,o-=1,n.push(new Token.Close_Group))}}function i(){let e=n.length;let r=0;for(;a.length>0;){let p=a.pop();if(p>0){const t=p>1;for(;e>0;)if(e-=1,n[e].Type()===Token.Type.CLOSE_GROUP)r+=1;else if(n[e].Type()===Token.Type.OPEN_GROUP)r-=1;else{if(n[e].Type()===Token.Type.AND){p-=1;break}n[e].Type()===Token.Type.TEXT&&n[e].Set_Boundary(Boundary.END)}if(t)for(;e>0;)if(e-=1,n[e].Type()===Token.Type.CLOSE_GROUP)r+=1;else if(n[e].Type()===Token.Type.OPEN_GROUP)r-=1;else if(n[e].Type()===Token.Type.AND){if(p-=1,0===p)break}else n[e].Type()===Token.Type.TEXT&&n[e].Set_Boundary(Boundary.MIDDLE);for(;e>0;)if(e-=1,n[e].Type()===Token.Type.CLOSE_GROUP)r+=1;else if(n[e].Type()===Token.Type.OPEN_GROUP)r-=1;else{if(n[e].Type()===Token.Type.OPEN_SEQUENCE||0===r&&(n[e].Type()===Token.Type.XOR||n[e].Type()===Token.Type.OR))break;n[e].Type()===Token.Type.TEXT&&n[e].Set_Boundary(Boundary.START)}}else for(;e>0;)if(e-=1,n[e].Type()===Token.Type.CLOSE_GROUP)r+=1;else if(n[e].Type()===Token.Type.OPEN_GROUP)r-=1;else{if(n[e].Type()===Token.Type.OPEN_SEQUENCE||0===r&&(n[e].Type()===Token.Type.XOR||n[e].Type()===Token.Type.OR))break;n[e].Type()===Token.Type.TEXT&&n[e].Set_Boundary(Boundary.ANY)}}}let y=new Unicode.Iterator({text:e});for(;!y.Is_At_End();y=y.Next()){const N=y.Point();if(!/\s/.test(N))if(N===Operator.VERBATIM){if(E(),y=y.Next(),y.Is_At_End())return new Help(`Unclosed ${Operator.VERBATIM}`,y.Previous().Index());{const n=y;for(;!y.Is_At_End()&&y.Point()!==Operator.VERBATIM;y=y.Next());if(y.Is_At_End())return new Help(`Unclosed ${Operator.VERBATIM}`,y.Previous().Index());{const t=new Text.Instance({dictionary:r,value:e.slice(n.Index(),y.Index())});if(t.Line_Count()>1)return new Help(`Newline inside ${Operator.VERBATIM}`,y.Index());if(0===t.Line(0).Macro_Part_Count())return new Help(`Empty ${Operator.VERBATIM}`,y.Index());p=y.Index(),l(t)}}}else if(N===Operator.MAYBE_ONE){if(O<1)return new Help(`Invalid ${Operator.MAYBE_ONE} outside sequence`,y.Index());{const e=T();if(null==e)return new Help(`Invalid ${Operator.MAYBE_ONE} at beginning`,y.Index());if(e.Type()===Token.Type.MAYBE_ONE)return new Help(`Invalid ${Operator.MAYBE_ONE} after ${Operator.MAYBE_ONE}`,p);if(e.Type()===Token.Type.MAYBE_MANY)return new Help(`Invalid ${Operator.MAYBE_ONE} after ${Operator.MAYBE_MANY}`,p);if(e.Type()===Token.Type.ONE_OR_MANY)return new Help(`Invalid ${Operator.MAYBE_ONE} after ${Operator.ONE_OR_MANY}`,p);if(e.Type()===Token.Type.OPEN_GROUP)return new Help(`Invalid ${Operator.MAYBE_ONE} after ${Operator.OPEN_GROUP}`,p);if(e.Type()===Token.Type.OPEN_SEQUENCE)return new Help(`Invalid ${Operator.MAYBE_ONE} after ${Operator.OPEN_SEQUENCE}`,p);if(e.Type()===Token.Type.NOT)return new Help(`Invalid ${Operator.MAYBE_ONE} after ${Operator.NOT}`,p);if(e.Type()===Token.Type.CASE)return new Help(`Invalid ${Operator.MAYBE_ONE} after ${Operator.CASE}`,p);if(e.Type()===Token.Type.ALIGN)return new Help(`Invalid ${Operator.MAYBE_ONE} after ${Operator.ALIGN}`,p);if(e.Type()===Token.Type.META)return new Help(`Invalid ${Operator.MAYBE_ONE} after ${Operator.META}`,p);if(e.Type()===Token.Type.AND)return new Help(`Invalid ${Operator.MAYBE_ONE} after ${Operator.AND}`,p);if(e.Type()===Token.Type.XOR)return new Help(`Invalid ${Operator.MAYBE_ONE} after ${Operator.XOR}`,p);if(e.Type()===Token.Type.OR)return new Help(`Invalid ${Operator.MAYBE_ONE} after ${Operator.OR}`,p);p=y.Index(),n.push(new Token.Maybe_One)}}else if(N===Operator.MAYBE_MANY){if(O<1)return new Help(`Invalid ${Operator.MAYBE_MANY} outside sequence`,y.Index());{const e=T();if(null==e)return new Help(`Invalid ${Operator.MAYBE_MANY} at beginning`,y.Index());if(e.Type()===Token.Type.MAYBE_ONE)return new Help(`Invalid ${Operator.MAYBE_MANY} after ${Operator.MAYBE_ONE}`,p);if(e.Type()===Token.Type.MAYBE_MANY)return new Help(`Invalid ${Operator.MAYBE_MANY} after ${Operator.MAYBE_MANY}`,p);if(e.Type()===Token.Type.ONE_OR_MANY)return new Help(`Invalid ${Operator.MAYBE_MANY} after ${Operator.ONE_OR_MANY}`,p);if(e.Type()===Token.Type.OPEN_GROUP)return new Help(`Invalid ${Operator.MAYBE_MANY} after ${Operator.OPEN_GROUP}`,p);if(e.Type()===Token.Type.OPEN_SEQUENCE)return new Help(`Invalid ${Operator.MAYBE_MANY} after ${Operator.OPEN_SEQUENCE}`,p);if(e.Type()===Token.Type.NOT)return new Help(`Invalid ${Operator.MAYBE_MANY} after ${Operator.NOT}`,p);if(e.Type()===Token.Type.CASE)return new Help(`Invalid ${Operator.MAYBE_MANY} after ${Operator.CASE}`,p);if(e.Type()===Token.Type.ALIGN)return new Help(`Invalid ${Operator.MAYBE_MANY} after ${Operator.ALIGN}`,p);if(e.Type()===Token.Type.META)return new Help(`Invalid ${Operator.MAYBE_MANY} after ${Operator.META}`,p);if(e.Type()===Token.Type.AND)return new Help(`Invalid ${Operator.MAYBE_MANY} after ${Operator.AND}`,p);if(e.Type()===Token.Type.XOR)return new Help(`Invalid ${Operator.MAYBE_MANY} after ${Operator.XOR}`,p);if(e.Type()===Token.Type.OR)return new Help(`Invalid ${Operator.MAYBE_MANY} after ${Operator.OR}`,p);p=y.Index(),n.push(new Token.Maybe_Many)}}else if(N===Operator.ONE_OR_MANY){if(O<1)return new Help(`Invalid ${Operator.ONE_OR_MANY} outside sequence`,y.Index());{const e=T();if(null==e)return new Help(`Invalid ${Operator.ONE_OR_MANY} at beginning`,y.Index());if(e.Type()===Token.Type.MAYBE_ONE)return new Help(`Invalid ${Operator.ONE_OR_MANY} after ${Operator.MAYBE_ONE}`,p);if(e.Type()===Token.Type.MAYBE_MANY)return new Help(`Invalid ${Operator.ONE_OR_MANY} after ${Operator.MAYBE_MANY}`,p);if(e.Type()===Token.Type.ONE_OR_MANY)return new Help(`Invalid ${Operator.ONE_OR_MANY} after ${Operator.ONE_OR_MANY}`,p);if(e.Type()===Token.Type.OPEN_GROUP)return new Help(`Invalid ${Operator.ONE_OR_MANY} after ${Operator.OPEN_GROUP}`,p);if(e.Type()===Token.Type.OPEN_SEQUENCE)return new Help(`Invalid ${Operator.ONE_OR_MANY} after ${Operator.OPEN_SEQUENCE}`,p);if(e.Type()===Token.Type.NOT)return new Help(`Invalid ${Operator.ONE_OR_MANY} after ${Operator.NOT}`,p);if(e.Type()===Token.Type.CASE)return new Help(`Invalid ${Operator.ONE_OR_MANY} after ${Operator.CASE}`,p);if(e.Type()===Token.Type.ALIGN)return new Help(`Invalid ${Operator.ONE_OR_MANY} after ${Operator.ALIGN}`,p);if(e.Type()===Token.Type.META)return new Help(`Invalid ${Operator.ONE_OR_MANY} after ${Operator.META}`,p);if(e.Type()===Token.Type.AND)return new Help(`Invalid ${Operator.ONE_OR_MANY} after ${Operator.AND}`,p);if(e.Type()===Token.Type.XOR)return new Help(`Invalid ${Operator.ONE_OR_MANY} after ${Operator.XOR}`,p);if(e.Type()===Token.Type.OR)return new Help(`Invalid ${Operator.ONE_OR_MANY} after ${Operator.OR}`,p);p=y.Index(),n.push(new Token.One_Or_Many)}}else if(N===Operator.OPEN_GROUP)E(),p=y.Index(),t+=1,O>0&&(o+=1),n.push(new Token.Open_Group);else if(N===Operator.CLOSE_GROUP){const e=T();if(null==e)return new Help(`Invalid ${Operator.CLOSE_GROUP} at beginning`,y.Index());if(e.Type()===Token.Type.OPEN_GROUP)return new Help(`Empty ${Operator.OPEN_GROUP}${Operator.CLOSE_GROUP}`,p);if(e.Type()===Token.Type.OPEN_SEQUENCE)return new Help(`Invalid ${Operator.OPEN_SEQUENCE} followed by ${Operator.CLOSE_GROUP}`,p);if(e.Type()===Token.Type.NOT)return new Help(`Invalid ${Operator.NOT} followed by ${Operator.CLOSE_GROUP}`,p);if(e.Type()===Token.Type.CASE)return new Help(`Invalid ${Operator.CASE} followed by ${Operator.CLOSE_GROUP}`,p);if(e.Type()===Token.Type.ALIGN)return new Help(`Invalid ${Operator.ALIGN} followed by ${Operator.CLOSE_GROUP}`,p);if(e.Type()===Token.Type.META)return new Help(`Invalid ${Operator.META} followed by ${Operator.CLOSE_GROUP}`,p);if(e.Type()===Token.Type.AND)return new Help(`Invalid ${Operator.AND} followed by ${Operator.CLOSE_GROUP}`,p);if(e.Type()===Token.Type.XOR)return new Help(`Invalid ${Operator.XOR} followed by ${Operator.CLOSE_GROUP}`,p);if(e.Type()===Token.Type.OR)return new Help(`Invalid ${Operator.OR} followed by ${Operator.CLOSE_GROUP}`,p);if(t<1)return new Help(`Extra ${Operator.CLOSE_GROUP}`,y.Index());p=y.Index(),t-=1,O>0&&(o-=1),n.push(new Token.Close_Group)}else if(N===Operator.OPEN_SEQUENCE){if(O>0)return new Help(`Interior ${Operator.OPEN_SEQUENCE} within sequence`,p);E(),p=y.Index(),O+=1,a.push(0),n.push(new Token.Open_Sequence({is_complex:!0}))}else if(N===Operator.CLOSE_SEQUENCE){const e=T();if(null===e)return new Help(`Invalid ${Operator.CLOSE_SEQUENCE} at beginning`,y.Index());if(e.Type()===Token.Type.OPEN_GROUP)return new Help(`Invalid ${Operator.OPEN_GROUP} followed by ${Operator.CLOSE_SEQUENCE}`,p);if(e.Type()===Token.Type.OPEN_SEQUENCE)return new Help(`Empty ${Operator.OPEN_SEQUENCE}${Operator.CLOSE_SEQUENCE}`,p);if(e.Type()===Token.Type.CLOSE_SEQUENCE)return new Help(`Invalid ${Operator.CLOSE_SEQUENCE} followed by ${Operator.CLOSE_SEQUENCE}`,p);if(e.Type()===Token.Type.NOT)return new Help(`Invalid ${Operator.NOT} followed by ${Operator.CLOSE_SEQUENCE}`,p);if(e.Type()===Token.Type.CASE)return new Help(`Invalid ${Operator.CASE} followed by ${Operator.CLOSE_SEQUENCE}`,p);if(e.Type()===Token.Type.ALIGN)return new Help(`Invalid ${Operator.ALIGN} followed by ${Operator.CLOSE_SEQUENCE}`,p);if(e.Type()===Token.Type.META)return new Help(`Invalid ${Operator.META} followed by ${Operator.CLOSE_SEQUENCE}`,p);if(e.Type()===Token.Type.AND)return new Help(`Invalid ${Operator.AND} followed by ${Operator.CLOSE_SEQUENCE}`,p);if(e.Type()===Token.Type.XOR)return new Help(`Invalid ${Operator.XOR} followed by ${Operator.CLOSE_SEQUENCE}`,p);if(e.Type()===Token.Type.OR)return new Help(`Invalid ${Operator.OR} followed by ${Operator.CLOSE_SEQUENCE}`,p);if(O<1)return new Help(`Extra ${Operator.CLOSE_SEQUENCE}`,y.Index());i(),p=y.Index(),O-=1,n.push(new Token.Close_Sequence({is_complex:!0}))}else if(N===Operator.NOT)E(),p=y.Index(),n.push(new Token.Not);else if(N===Operator.CASE)E(),p=y.Index(),n.push(new Token.Case);else if(N===Operator.ALIGN)E(),p=y.Index(),n.push(new Token.Align);else if(N===Operator.META)E(),p=y.Index(),n.push(new Token.Meta);else if(N===Operator.AND){const e=T();if(null===e)return new Help(`Invalid ${Operator.AND} at beginning`,y.Index());if(e.Type()===Token.Type.OPEN_GROUP)return new Help(`Invalid ${Operator.AND} after ${Operator.OPEN_GROUP}`,y.Index());if(e.Type()===Token.Type.OPEN_SEQUENCE)return new Help(`Invalid ${Operator.AND} after ${Operator.OPEN_SEQUENCE}`,y.Index());if(e.Type()===Token.Type.NOT)return new Help(`Invalid ${Operator.AND} after ${Operator.NOT}`,y.Index());if(e.Type()===Token.Type.CASE)return new Help(`Invalid ${Operator.AND} after ${Operator.CASE}`,y.Index());if(e.Type()===Token.Type.ALIGN)return new Help(`Invalid ${Operator.AND} after ${Operator.ALIGN}`,y.Index());if(e.Type()===Token.Type.META)return new Help(`Invalid ${Operator.AND} after ${Operator.META}`,y.Index());if(e.Type()===Token.Type.AND)return new Help(`Invalid ${Operator.AND} after ${Operator.AND}`,y.Index());if(e.Type()===Token.Type.XOR)return new Help(`Invalid ${Operator.AND} after ${Operator.XOR}`,y.Index());if(e.Type()===Token.Type.OR)return new Help(`Invalid ${Operator.AND} after ${Operator.OR}`,y.Index());p=y.Index(),O>0&&(a[a.length-1]+=1),n.push(new Token.And)}else if(N===Operator.XOR){const e=T();if(null===e)return new Help(`Invalid ${Operator.XOR} at beginning`,y.Index());if(e.Type()===Token.Type.OPEN_GROUP)return new Help(`Invalid ${Operator.XOR} after ${Operator.OPEN_GROUP}`,y.Index());if(e.Type()===Token.Type.OPEN_SEQUENCE)return new Help(`Invalid ${Operator.XOR} after ${Operator.OPEN_SEQUENCE}`,y.Index());if(e.Type()===Token.Type.NOT)return new Help(`Invalid ${Operator.XOR} after ${Operator.NOT}`,y.Index());if(e.Type()===Token.Type.CASE)return new Help(`Invalid ${Operator.XOR} after ${Operator.CASE}`,y.Index());if(e.Type()===Token.Type.ALIGN)return new Help(`Invalid ${Operator.XOR} after ${Operator.ALIGN}`,y.Index());if(e.Type()===Token.Type.META)return new Help(`Invalid ${Operator.XOR} after ${Operator.META}`,y.Index());if(e.Type()===Token.Type.AND)return new Help(`Invalid ${Operator.XOR} after ${Operator.AND}`,y.Index());if(e.Type()===Token.Type.XOR)return new Help(`Invalid ${Operator.XOR} after ${Operator.XOR}`,y.Index());if(e.Type()===Token.Type.OR)return new Help(`Invalid ${Operator.XOR} after ${Operator.OR}`,y.Index());p=y.Index(),O>0&&0===o&&a.push(0),n.push(new Token.Xor)}else if(N===Operator.OR){const e=T();if(null===e)return new Help(`Invalid ${Operator.OR} at beginning`,y.Index());if(e.Type()===Token.Type.OPEN_GROUP)return new Help(`Invalid ${Operator.OR} after ${Operator.OPEN_GROUP}`,y.Index());if(e.Type()===Token.Type.OPEN_SEQUENCE)return new Help(`Invalid ${Operator.OR} after ${Operator.OPEN_SEQUENCE}`,y.Index());if(e.Type()===Token.Type.NOT)return new Help(`Invalid ${Operator.OR} after ${Operator.NOT}`,y.Index());if(e.Type()===Token.Type.CASE)return new Help(`Invalid ${Operator.OR} after ${Operator.CASE}`,y.Index());if(e.Type()===Token.Type.ALIGN)return new Help(`Invalid ${Operator.OR} after ${Operator.ALIGN}`,y.Index());if(e.Type()===Token.Type.META)return new Help(`Invalid ${Operator.OR} after ${Operator.META}`,y.Index());if(e.Type()===Token.Type.AND)return new Help(`Invalid ${Operator.OR} after ${Operator.AND}`,y.Index());if(e.Type()===Token.Type.XOR)return new Help(`Invalid ${Operator.OR} after ${Operator.XOR}`,y.Index());if(e.Type()===Token.Type.OR)return new Help(`Invalid ${Operator.OR} after ${Operator.OR}`,y.Index());p=y.Index(),O>0&&0===o&&a.push(0),n.push(new Token.Or)}else{E();const n=y;for(y=y.Next();!y.Is_At_End();y=y.Next()){const e=y.Point();if(/\s/.test(e)||e===Operator.VERBATIM||e===Operator.MAYBE_ONE||e===Operator.MAYBE_MANY||e===Operator.ONE_OR_MANY||e===Operator.OPEN_GROUP||e===Operator.CLOSE_GROUP||e===Operator.OPEN_SEQUENCE||e===Operator.CLOSE_SEQUENCE||e===Operator.NOT||e===Operator.CASE||e===Operator.ALIGN||e===Operator.META||e===Operator.AND||e===Operator.XOR||e===Operator.OR)break}const t=new Text.Instance({dictionary:r,value:e.slice(n.Index(),y.Index())});y=y.Previous(),p=n.Index(),l(t)}}if(n.length<1)return new Help("Empty expression",0);if(t>0)return new Help(`Unclosed ${Operator.OPEN_GROUP}`,y.Previous().Index());if(O>0)return new Help(`Unclosed ${Operator.OPEN_SEQUENCE}`,y.Previous().Index());{const e=n[n.length-1];if(e.Type()===Token.Type.OPEN_GROUP)return new Help(`Invalid ${Operator.OPEN_GROUP} at end`,p);if(e.Type()===Token.Type.OPEN_SEQUENCE)return new Help(`Invalid ${Operator.OPEN_SEQUENCE} at end`,p);if(e.Type()===Token.Type.NOT)return new Help(`Invalid ${Operator.NOT} at end`,p);if(e.Type()===Token.Type.CASE)return new Help(`Invalid ${Operator.CASE} at end`,p);if(e.Type()===Token.Type.ALIGN)return new Help(`Invalid ${Operator.ALIGN} at end`,p);if(e.Type()===Token.Type.META)return new Help(`Invalid ${Operator.META} at end`,p);if(e.Type()===Token.Type.AND)return new Help(`Invalid ${Operator.AND} at end`,p);if(e.Type()===Token.Type.XOR)return new Help(`Invalid ${Operator.XOR} at end`,p);if(e.Type()===Token.Type.OR)return new Help(`Invalid ${Operator.OR} at end`,p)}return n}}