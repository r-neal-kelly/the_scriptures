import*as Utils from"../../utils.js";import{Sequence_Type}from"./sequence_type.js";import*as Parser from"./parser.js";import*as Compiler from"./compiler.js";import*as Node from"./node.js";import*as Result from"./result.js";export var Mode;!function(t){t[t.INITIAL=0]="INITIAL",t[t.NOT=1]="NOT",t[t.CASE=2]="CASE",t[t.ALIGN=4]="ALIGN",t[t.META=8]="META",t[t.COMPLEX_SEQUENCE=16]="COMPLEX_SEQUENCE"}(Mode||(Mode={}));export class Instance{constructor(){this.parser=new Parser.Instance,this.compiler=new Compiler.Instance}Execute(t,e){const n=this.parser.Parse(t,e.Dictionary());if(n instanceof Parser.Help)return n;{const t=this.compiler.Compile(n),_=[];for(let n=0,r=e.Line_Count();n<r;n+=1){const r=e.Line(n),a=this.Step(t,Mode.INITIAL,new Result.Instance(r));null!=a&&_.push(a)}return _}}Step(t,e,n){const _=t.Type();if(_===Node.Type.MAYBE_ONE||_===Node.Type.MAYBE_MANY||_===Node.Type.ONE_OR_MANY){const _=t,r=this.Step(_.Next(),e,n.Copy()),a=this.Step(_.Operand(),e,n.Copy());return null!=r?null!=a?r.Combine(a):r:null!=a?a:null}if(_===Node.Type.SEQUENCE){const _=t,r=_.Sequence_Type(),a=this.Step(_.Operand(),r===Sequence_Type.COMPLEX_SEQUENCE?e|Mode.COMPLEX_SEQUENCE:e,new Result.Instance(n.Line()));return null!=a?this.Step(_.Next(),e,n.Combine(a)):null}if(_===Node.Type.NOT){const _=t,r=this.Step(_.Operand(),e^Mode.NOT,n);return null!=r?this.Step(_.Next(),e,r):null}if(_===Node.Type.CASE){const _=t,r=this.Step(_.Operand(),e^Mode.CASE,n);return null!=r?this.Step(_.Next(),e,r):null}if(_===Node.Type.ALIGN){const _=t,r=this.Step(_.Operand(),e^Mode.ALIGN,n);return null!=r?this.Step(_.Next(),e,r):null}if(_===Node.Type.META){const _=t,r=this.Step(_.Operand(),e^Mode.META,n);return null!=r?this.Step(_.Next(),e,r):null}if(_===Node.Type.XOR){const _=t,r=this.Step(_.Left_Operand(),e,n.Copy()),a=this.Step(_.Right_Operand(),e,n.Copy());return null!=r?null!=a?null:r:null!=a?a:null}if(_===Node.Type.OR){const _=t,r=this.Step(_.Left_Operand(),e,n.Copy()),a=this.Step(_.Right_Operand(),e,n.Copy());return null!=r?null!=a?r.Combine(a):r:null!=a?a:null}return _===Node.Type.CLASS?this.Class(t,e,n):_===Node.Type.TEXT?e&Mode.COMPLEX_SEQUENCE?this.Complex_Text(t,e,n):this.Text(t,e,n):_===Node.Type.END?n:(Utils.Assert(!1,`Unknown node_type: ${_}`),null)}Text(t,e,n){const _=[];for(;!(t instanceof Node.End);)_.push(t),t=t.Next();let r;if(1===_.length)r=this.Text_Any(_[0],e,n);else{r=this.Text_Start(_[0],e,n);for(let t=1,n=_.length-1;t<n&&null!=r;t+=1)r=this.Text_Middle(_[t],e,r);null!=r&&(r=this.Text_End(_[_.length-1],e,r))}return null!=r?this.Step(t,e,r):null}Text_Any(t,e,n){Utils.Assert(0===n.Match_Count(),"Should not have any matches at any.");const _=n.Line(),r=t.Part(),a=e&Mode.CASE?r.Value():r.Value().toLowerCase(),i=new Result.Instance(n.Line());for(let t=0,n=_.Macro_Part_Count();t<n;t+=1)if(e&Mode.META||!_.Macro_Part(t).Is_Command()){const n=_.Macro_Part(t),r=e&Mode.CASE?n.Value():n.Value().toLowerCase();if(e&Mode.ALIGN)r===a&&i.Try_Add_Match(new Result.Match({first_part_index:t,end_part_index:t+1,first_part_first_unit_index:0,last_part_end_unit_index:r.length}));else for(let e=0,n=r.length-(a.length-1);e<n;e+=1)r.slice(e,e+a.length)===a&&i.Try_Add_Match(new Result.Match({first_part_index:t,end_part_index:t+1,first_part_first_unit_index:e,last_part_end_unit_index:e+a.length}))}return e&Mode.NOT?i.Match_Count()>0?null:i:i.Match_Count()>0?i:null}Text_Start(t,e,n){Utils.Assert(0===n.Match_Count(),"Should not have any matches at start.");const _=n.Line(),r=t.Part(),a=e&Mode.CASE?r.Value():r.Value().toLowerCase(),i=new Result.Instance(n.Line());for(let t=0,n=_.Macro_Part_Count();t<n;t+=1)if(e&Mode.META||!_.Macro_Part(t).Is_Command()){const n=_.Macro_Part(t),r=e&Mode.CASE?n.Value():n.Value().toLowerCase();e&Mode.ALIGN?r===a&&i.Try_Add_Match(new Result.Match({first_part_index:t,end_part_index:t+1,first_part_first_unit_index:0,last_part_end_unit_index:r.length})):r.length>=a.length&&r.slice(r.length-a.length,r.length)===a&&i.Try_Add_Match(new Result.Match({first_part_index:t,end_part_index:t+1,first_part_first_unit_index:r.length-a.length,last_part_end_unit_index:r.length}))}return e&Mode.NOT||i.Match_Count()>0?i:null}Text_Middle(t,e,n){const _=n.Line(),r=t.Part(),a=e&Mode.CASE?r.Value():r.Value().toLowerCase(),i=new Result.Instance(n.Line());for(let t=0,r=n.Match_Count();t<r;t+=1){const r=n.Match(t);let s=r.End_Part_Index();const l=_.Macro_Part(s-1),d=e&Mode.CASE?l.Value():l.Value().toLowerCase();if(r.Last_Part_End_Unit_Index()===d.length){const t=_.Macro_Part_Count();let n=0;if(!(e&Mode.META))for(;s+n<t&&_.Macro_Part(s+n).Is_Command();)n+=1;if(s+n<t){const t=_.Macro_Part(s+n),l=e&Mode.CASE?t.Value():t.Value().toLowerCase();l===a&&i.Try_Add_Match(new Result.Match({first_part_index:r.First_Part_Index(),end_part_index:s+n+1,first_part_first_unit_index:r.First_Part_First_Unit_Index(),last_part_end_unit_index:l.length}))}}}return e&Mode.NOT||i.Match_Count()>0?i:null}Text_End(t,e,n){const _=n.Line(),r=t.Part(),a=e&Mode.CASE?r.Value():r.Value().toLowerCase(),i=new Result.Instance(n.Line());for(let t=0,r=n.Match_Count();t<r;t+=1){const r=n.Match(t);let s=r.End_Part_Index();const l=_.Macro_Part(s-1),d=e&Mode.CASE?l.Value():l.Value().toLowerCase();if(r.Last_Part_End_Unit_Index()===d.length){const t=_.Macro_Part_Count();let n=0;if(!(e&Mode.META))for(;s+n<t&&_.Macro_Part(s+n).Is_Command();)n+=1;if(s+n<t){const t=_.Macro_Part(s+n),l=e&Mode.CASE?t.Value():t.Value().toLowerCase();e&Mode.ALIGN?l===a&&i.Try_Add_Match(new Result.Match({first_part_index:r.First_Part_Index(),end_part_index:s+n+1,first_part_first_unit_index:r.First_Part_First_Unit_Index(),last_part_end_unit_index:l.length})):l.length>=a.length&&l.slice(0,a.length)===a&&i.Try_Add_Match(new Result.Match({first_part_index:r.First_Part_Index(),end_part_index:s+n+1,first_part_first_unit_index:r.First_Part_First_Unit_Index(),last_part_end_unit_index:a.length}))}}}return e&Mode.NOT?i.Match_Count()>0?null:i:i.Match_Count()>0?i:null}Complex_Text(t,e,n){const _=t;if(0===n.Match_Count()){let t=this.Complex_Text_Any(_,e,n);if(null!=t){if(t=this.Step(_.Next(),e,t),null!=t)return t;{const t=this.Complex_Text_Start(_,e,n);return null!=t?this.Step(_.Next(),e,t):null}}{const t=this.Complex_Text_Start(_,e,n);return null!=t?this.Step(_.Next(),e,t):null}}{let t=this.Complex_Text_Middle(_,e,n);if(null!=t){if(t=this.Step(_.Next(),e,t),null!=t)return t;{const t=this.Complex_Text_End(_,e,n);return null!=t?this.Step(_.Next(),e,t):null}}{const t=this.Complex_Text_End(_,e,n);return null!=t?this.Step(_.Next(),e,t):null}}}Complex_Text_Any(t,e,n){Utils.Assert(0===n.Match_Count(),"Should not have any matches at any.");const _=n.Line(),r=t.Part(),a=e&Mode.CASE?r.Value():r.Value().toLowerCase(),i=new Result.Instance(n.Line());for(let t=0,n=_.Macro_Part_Count();t<n;t+=1)if(e&Mode.META||!_.Macro_Part(t).Is_Command()){const n=_.Macro_Part(t),r=e&Mode.CASE?n.Value():n.Value().toLowerCase();if(e&Mode.ALIGN)e&Mode.NOT?r!==a&&i.Try_Add_Match(new Result.Match({first_part_index:t,end_part_index:t+1,first_part_first_unit_index:0,last_part_end_unit_index:r.length})):r===a&&i.Try_Add_Match(new Result.Match({first_part_index:t,end_part_index:t+1,first_part_first_unit_index:0,last_part_end_unit_index:r.length}));else{let n=!1,_=0,s=0;for(let t=0,e=r.length;t<e-(a.length-1);)if(n){if(r.slice(t,t+a.length)!==a)break;t+=a.length,s=t}else r.slice(t,t+a.length)===a?(n=!0,_=t,t+=a.length,s=t):t+=1;e&Mode.NOT?n||i.Try_Add_Match(new Result.Match({first_part_index:t,end_part_index:t+1,first_part_first_unit_index:0,last_part_end_unit_index:r.length})):n&&i.Try_Add_Match(new Result.Match({first_part_index:t,end_part_index:t+1,first_part_first_unit_index:_,last_part_end_unit_index:s}))}}return i.Match_Count()>0?i:null}Complex_Text_Start(t,e,n){Utils.Assert(0===n.Match_Count(),"Should not have any matches at start.");const _=n.Line(),r=t.Part(),a=e&Mode.CASE?r.Value():r.Value().toLowerCase(),i=new Result.Instance(n.Line());for(let t=0,n=_.Macro_Part_Count();t<n;t+=1)if(e&Mode.META||!_.Macro_Part(t).Is_Command()){const n=_.Macro_Part(t),r=e&Mode.CASE?n.Value():n.Value().toLowerCase();if(e&Mode.ALIGN)e&Mode.NOT?r!==a&&i.Try_Add_Match(new Result.Match({first_part_index:t,end_part_index:t+1,first_part_first_unit_index:0,last_part_end_unit_index:r.length})):r===a&&i.Try_Add_Match(new Result.Match({first_part_index:t,end_part_index:t+1,first_part_first_unit_index:0,last_part_end_unit_index:r.length}));else if(e&Mode.NOT)(r.length<a.length||r.slice(r.length-a.length,r.length)!==a)&&i.Try_Add_Match(new Result.Match({first_part_index:t,end_part_index:t+1,first_part_first_unit_index:0,last_part_end_unit_index:r.length}));else if(r.length>=a.length&&r.slice(r.length-a.length,r.length)===a){let e=r.length-a.length;for(let t=e,n=0;t>n+(a.length-1)&&r.slice(t-a.length,t)===a;)t-=a.length,e=t;i.Try_Add_Match(new Result.Match({first_part_index:t,end_part_index:t+1,first_part_first_unit_index:e,last_part_end_unit_index:r.length}))}}return i.Match_Count()>0?i:null}Complex_Text_Middle(t,e,n){const _=n.Line(),r=t.Part(),a=e&Mode.CASE?r.Value():r.Value().toLowerCase(),i=new Result.Instance(n.Line());for(let t=0,r=n.Match_Count();t<r;t+=1){const r=n.Match(t);let s=r.End_Part_Index();const l=_.Macro_Part(s-1),d=e&Mode.CASE?l.Value():l.Value().toLowerCase();if(r.Last_Part_End_Unit_Index()===d.length){const t=_.Macro_Part_Count();let n=0;if(!(e&Mode.META))for(;s+n<t&&_.Macro_Part(s+n).Is_Command();)n+=1;if(s+n<t){const t=_.Macro_Part(s+n),l=e&Mode.CASE?t.Value():t.Value().toLowerCase();e&Mode.NOT?l!==a&&i.Try_Add_Match(new Result.Match({first_part_index:r.First_Part_Index(),end_part_index:s+n+1,first_part_first_unit_index:r.First_Part_First_Unit_Index(),last_part_end_unit_index:l.length})):l===a&&i.Try_Add_Match(new Result.Match({first_part_index:r.First_Part_Index(),end_part_index:s+n+1,first_part_first_unit_index:r.First_Part_First_Unit_Index(),last_part_end_unit_index:l.length}))}}}return i.Match_Count()>0?i:null}Complex_Text_End(t,e,n){const _=n.Line(),r=t.Part(),a=e&Mode.CASE?r.Value():r.Value().toLowerCase(),i=new Result.Instance(n.Line());for(let t=0,r=n.Match_Count();t<r;t+=1){const r=n.Match(t);let s=r.End_Part_Index();const l=_.Macro_Part(s-1),d=e&Mode.CASE?l.Value():l.Value().toLowerCase();if(r.Last_Part_End_Unit_Index()===d.length){const t=_.Macro_Part_Count();let n=0;if(!(e&Mode.META))for(;s+n<t&&_.Macro_Part(s+n).Is_Command();)n+=1;if(s+n<t){const t=_.Macro_Part(s+n),l=e&Mode.CASE?t.Value():t.Value().toLowerCase();if(e&Mode.ALIGN)e&Mode.NOT?l!==a&&i.Try_Add_Match(new Result.Match({first_part_index:r.First_Part_Index(),end_part_index:s+n+1,first_part_first_unit_index:r.First_Part_First_Unit_Index(),last_part_end_unit_index:l.length})):l===a&&i.Try_Add_Match(new Result.Match({first_part_index:r.First_Part_Index(),end_part_index:s+n+1,first_part_first_unit_index:r.First_Part_First_Unit_Index(),last_part_end_unit_index:l.length}));else if(e&Mode.NOT)(l.length<a.length||l.slice(0,a.length)!==a)&&i.Try_Add_Match(new Result.Match({first_part_index:r.First_Part_Index(),end_part_index:s+n+1,first_part_first_unit_index:r.First_Part_First_Unit_Index(),last_part_end_unit_index:l.length}));else if(l.length>=a.length&&l.slice(0,a.length)===a){let t=a.length;for(let e=t,n=l.length;e<n-(a.length-1)&&l.slice(e,e+a.length)===a;)e+=a.length,t=e;i.Try_Add_Match(new Result.Match({first_part_index:r.First_Part_Index(),end_part_index:s+n+1,first_part_first_unit_index:r.First_Part_First_Unit_Index(),last_part_end_unit_index:t}))}}}}return i.Match_Count()>0?i:null}Class(t,e,n){const _=t;if(0===n.Match_Count()){let t;return t=e&Mode.COMPLEX_SEQUENCE?this.Complex_Class_Any_Or_Start(_,e,n):this.Class_Any_Or_Start(_,e,n),null!=t?this.Step(_.Next(),e,t):null}{let t;return t=e&Mode.COMPLEX_SEQUENCE?this.Complex_Class_Middle_Or_End(_,e,n):this.Class_Middle_Or_End(_,e,n),null!=t?this.Step(_.Next(),e,t):null}}Class_Any_Or_Start(t,e,n){Utils.Assert(0===n.Match_Count(),"Should not have any matches at any or start.");const _=n.Line(),r=new Result.Instance(n.Line());for(let n=0,a=_.Macro_Part_Count();n<a;n+=1)if(e&Mode.META||!_.Macro_Part(n).Is_Command()){const a=_.Macro_Part(n),i=e&Mode.CASE?a.Value():a.Value().toLowerCase();t.Recognizes(a)&&r.Try_Add_Match(new Result.Match({first_part_index:n,end_part_index:n+1,first_part_first_unit_index:0,last_part_end_unit_index:i.length}))}return e&Mode.NOT?r.Match_Count()>0?null:r:r.Match_Count()>0?r:null}Class_Middle_Or_End(t,e,n){const _=n.Line(),r=new Result.Instance(n.Line());for(let a=0,i=n.Match_Count();a<i;a+=1){const i=n.Match(a);let s=i.End_Part_Index();const l=_.Macro_Part_Count();let d=0;if(!(e&Mode.META))for(;s+d<l&&_.Macro_Part(s+d).Is_Command();)d+=1;if(s+d<l){const n=_.Macro_Part(s+d),a=e&Mode.CASE?n.Value():n.Value().toLowerCase();t.Recognizes(n)&&r.Try_Add_Match(new Result.Match({first_part_index:i.First_Part_Index(),end_part_index:s+d+1,first_part_first_unit_index:i.First_Part_First_Unit_Index(),last_part_end_unit_index:a.length}))}}return e&Mode.NOT?r.Match_Count()>0?null:r:r.Match_Count()>0?r:null}Complex_Class_Any_Or_Start(t,e,n){Utils.Assert(0===n.Match_Count(),"Should not have any matches at any or start.");const _=n.Line(),r=new Result.Instance(n.Line());for(let n=0,a=_.Macro_Part_Count();n<a;n+=1)if(e&Mode.META||!_.Macro_Part(n).Is_Command()){const a=_.Macro_Part(n),i=e&Mode.CASE?a.Value():a.Value().toLowerCase();e&Mode.NOT?t.Recognizes(a)||r.Try_Add_Match(new Result.Match({first_part_index:n,end_part_index:n+1,first_part_first_unit_index:0,last_part_end_unit_index:i.length})):t.Recognizes(a)&&r.Try_Add_Match(new Result.Match({first_part_index:n,end_part_index:n+1,first_part_first_unit_index:0,last_part_end_unit_index:i.length}))}return r.Match_Count()>0?r:null}Complex_Class_Middle_Or_End(t,e,n){const _=n.Line(),r=new Result.Instance(n.Line());for(let a=0,i=n.Match_Count();a<i;a+=1){const i=n.Match(a);let s=i.End_Part_Index();const l=_.Macro_Part_Count();let d=0;if(!(e&Mode.META))for(;s+d<l&&_.Macro_Part(s+d).Is_Command();)d+=1;if(s+d<l){const n=_.Macro_Part(s+d),a=e&Mode.CASE?n.Value():n.Value().toLowerCase();e&Mode.NOT?t.Recognizes(n)||r.Try_Add_Match(new Result.Match({first_part_index:i.First_Part_Index(),end_part_index:s+d+1,first_part_first_unit_index:i.First_Part_First_Unit_Index(),last_part_end_unit_index:a.length})):t.Recognizes(n)&&r.Try_Add_Match(new Result.Match({first_part_index:i.First_Part_Index(),end_part_index:s+d+1,first_part_first_unit_index:i.First_Part_First_Unit_Index(),last_part_end_unit_index:a.length}))}}return r.Match_Count()>0?r:null}}