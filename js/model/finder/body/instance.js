var __awaiter=this&&this.__awaiter||function(i,e,s,t){return new(s||(s=Promise))((function(n,a){function r(i){try{o(t.next(i))}catch(i){a(i)}}function _(i){try{o(t.throw(i))}catch(i){a(i)}}function o(i){var e;i.done?n(i.value):(e=i.value,e instanceof s?e:new s((function(i){i(e)}))).then(r,_)}o((t=t.apply(i,e||[])).next())}))};import*as Utils from"../../../utils.js";import*as Entity from"../../entity.js";import*as Language from"../../language.js";import*as Data from"../../data.js";import*as Search from"../../search.js";import*as Selector from"../../selector.js";import*as Expression from"./expression.js";import*as Results from"./results.js";export class Instance extends Entity.Instance{constructor({finder:i}){super(),this.finder=i,this.filter=new Selector.Instance({slot_order:Selector.Slot.Order.LANGUAGES_VERSIONS_BOOKS,does_smart_item_selection:!1,selection:new Data.Selection.Name({language:Language.Name.ENGLISH})}),this.expression=new Expression.Instance({body:this}),this.results=new Results.Instance({body:this,filter_slot_order:this.filter.Settings().Current_Slot_Order().Value(),versions_results:new Map,is_showing_commands:!1}),this.is_waiting=!1,this.waiting_milliseconds_interval=100,this.waiting_percent_done=null,this.waiting_message_index=null,this.waiting_message_count=null,this.waiting_message_is_moving_forward=null,0,this.Add_Dependencies([Data.Singleton(),Search.Singleton(),this.filter,this.expression,this.results])}Finder(){return this.finder}Filter(){return this.filter}Expression(){return this.expression}Results(){return this.results}Has_Empty_Results(){return this.Results().Tree().Root().Is_Empty()}Is_Waiting(){return this.is_waiting}Set_Is_Waiting(i){this.is_waiting=i,this.is_waiting?(this.waiting_percent_done=new Search.Percent_Done.Instance,this.waiting_message_index=0,this.waiting_message_count=8,this.waiting_message_is_moving_forward=!0):(this.waiting_percent_done=null,this.waiting_message_index=null,this.waiting_message_count=null,this.waiting_message_is_moving_forward=null)}Waiting_Milliseconds_Interval(){return this.waiting_milliseconds_interval}Waiting_Percent_Done(){return 0,0,this.waiting_percent_done}Waiting_Message(){0,0,0,0;const i=new Array(this.waiting_message_count);return i.fill(".",0,i.length),i[this.waiting_message_index]="📝",this.waiting_message_is_moving_forward?(this.waiting_message_index+=1,this.waiting_message_index>=this.waiting_message_count&&(this.waiting_message_index=this.waiting_message_count-2,this.waiting_message_is_moving_forward=!1)):(this.waiting_message_index-=1,this.waiting_message_index<0&&(this.waiting_message_index=1,this.waiting_message_is_moving_forward=!0)),`Searching ${i.join("")} ${this.Waiting_Percent_Done().Value()}%`}Search(){return __awaiter(this,void 0,void 0,(function*(){this.Set_Is_Waiting(!0);const i=this.Filter().File_Or_Versions(),e=this.Expression().Value();let s;if(i instanceof Data.File.Instance){const t=i,n=yield Search.Singleton().Data_File(t,e);if(n instanceof Search.Parser.Help)s=n;else if(s=new Map,n.length>0){const i=new Map;i.set(t,n),s.set(t.Version(),i)}}else s=yield Search.Singleton().Data_Versions(i,e,this.Waiting_Milliseconds_Interval(),this.Waiting_Percent_Done());if(s instanceof Search.Parser.Help)this.expression.Set_Help(s),this.results=new Results.Instance({body:this,filter_slot_order:this.filter.Settings().Current_Slot_Order().Value(),versions_results:new Map,is_showing_commands:!1});else{const i=e.includes(Search.Operator.META);this.expression.Set_Help(null),this.results=new Results.Instance({body:this,filter_slot_order:this.filter.Settings().Current_Slot_Order().Value(),versions_results:s,is_showing_commands:i})}this.Set_Is_Waiting(!1)}))}}