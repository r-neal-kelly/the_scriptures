var __awaiter=this&&this.__awaiter||function(e,t,s,o){return new(s||(s=Promise))((function(i,l){function n(e){try{a(o.next(e))}catch(e){l(e)}}function r(e){try{a(o.throw(e))}catch(e){l(e)}}function a(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(n,r)}a((o=o.apply(e,t||[])).next())}))};import*as Utils from"../../../../utils.js";import*as Data from"../../../data.js";import*as Entity from"../../../entity.js";import*as Selection from"../../../data/selection.js";import*as Slot from"./slot.js";export class Instance extends Entity.Instance{static Max_Count(){return Instance.MAX_SLOT_COUNT}static Slot_To_Data_Type(e){return e===Slot.Type.BOOKS?Data.Type.BOOKS:e===Slot.Type.LANGUAGES?Data.Type.LANGUAGES:e===Slot.Type.VERSIONS?Data.Type.VERSIONS:e===Slot.Type.FILES?Data.Type.FILES:(Utils.Assert(!1,"Invalid slot_type."),Data.Type.BOOKS)}constructor({selector:e,order:t,selection:s=null}){super(),this.selector=e,this.order=t,this.first_selection=s,this.slots=[],this.Add_Dependencies([Data.Singleton()])}Selector(){return this.selector}Order(){return this.order}Reorder(e){return __awaiter(this,void 0,void 0,(function*(){}))}Count(){return this.slots.length}Has(e){return this.slots.includes(e)}Has_Type(e){for(const t of this.slots)if(t.Type()===e)return!0;return!1}From_Type(e){for(const t of this.slots)if(t.Type()===e)return t;return Utils.Assert(!1,"Does not have slot with that type."),this.slots[0]}At(e){return Utils.Assert(e>-1,"slot_index must be greater than -1."),Utils.Assert(e<this.Count(),"slot_index must be less than slot_count."),this.slots[e]}Array(){return Array.from(this.slots)}Types(){const e=this.Order(),t=[];return e===Slot.Order.BOOKS_LANGUAGES_VERSIONS?(t.push(Slot.Type.BOOKS),t.push(Slot.Type.LANGUAGES),t.push(Slot.Type.VERSIONS)):e===Slot.Order.BOOKS_VERSIONS_LANGUAGES?(t.push(Slot.Type.BOOKS),t.push(Slot.Type.VERSIONS),t.push(Slot.Type.LANGUAGES)):e===Slot.Order.LANGUAGES_BOOKS_VERSIONS?(t.push(Slot.Type.LANGUAGES),t.push(Slot.Type.BOOKS),t.push(Slot.Type.VERSIONS)):e===Slot.Order.LANGUAGES_VERSIONS_BOOKS?(t.push(Slot.Type.LANGUAGES),t.push(Slot.Type.VERSIONS),t.push(Slot.Type.BOOKS)):e===Slot.Order.VERSIONS_BOOKS_LANGUAGES?(t.push(Slot.Type.VERSIONS),t.push(Slot.Type.BOOKS),t.push(Slot.Type.LANGUAGES)):e===Slot.Order.VERSIONS_LANGUAGES_BOOKS?(t.push(Slot.Type.VERSIONS),t.push(Slot.Type.LANGUAGES),t.push(Slot.Type.BOOKS)):Utils.Assert(!1,"Unknown slot_type."),t.push(Slot.Type.FILES),Utils.Assert(t.length===Instance.Max_Count(),"slot_types must have all types."),t}Push(){return __awaiter(this,void 0,void 0,(function*(){const e=Instance.Max_Count(),t=this.Count();Utils.Assert(t<e,"All slots have been pushed already.");const s=t,o=this.Types()[s],i=this.Array().map(function(e,s){let o;return 0===s&&0===t?o=null:(Utils.Assert(e.Items().Has_Selected(),"To push a new slot, each previous slot must have a selected item."),o=e.Items().Selected().Name()),new Data.Query.Type_And_Name({type:Instance.Slot_To_Data_Type(e.Type()),name:o})}.bind(this));i.push(new Data.Query.Type_And_Name({type:Instance.Slot_To_Data_Type(o),name:null}));const l=Data.Singleton().Names(i),n=o===Slot.Type.FILES?Data.Singleton().Files({book_name:this.Books().Items().Selected().Name(),language_name:this.Languages().Items().Selected().Name(),version_name:this.Versions().Items().Selected().Name()}):null;this.slots.push(new Slot.Instance({slots:this,index:s,type:o,item_names:l,item_files:n}))}))}Pop(){this.slots.pop()}Has_Books(){return this.Has_Type(Slot.Type.BOOKS)}Books(){return Utils.Assert(this.Has_Books(),"Doesn't have books."),this.From_Type(Slot.Type.BOOKS)}Has_Languages(){return this.Has_Type(Slot.Type.LANGUAGES)}Languages(){return Utils.Assert(this.Has_Languages(),"Doesn't have languages."),this.From_Type(Slot.Type.LANGUAGES)}Has_Versions(){return this.Has_Type(Slot.Type.VERSIONS)}Versions(){return Utils.Assert(this.Has_Versions(),"Doesn't have versions."),this.From_Type(Slot.Type.VERSIONS)}Has_Files(){return this.Has_Type(Slot.Type.FILES)}Files(){return Utils.Assert(this.Has_Files(),"Doesn't have files."),this.From_Type(Slot.Type.FILES)}As_String(){const e=this.Count();if(e>0){let t="";for(let s=0,o=e;s<o;){const e=this.At(s);e.Items().Has_Selected()?t+=e.Items().Selected().Title():t+=e.Title().Value(),s+=1,s<o&&(t+=" â€” ")}return t}return null}As_Short_String(){if(this.Count()>0){const e=this.At(0);return e.Items().Has_Selected()?e.Items().Selected().Title():e.Title().Value()}return null}Select_Item_Internally({slot:e}){return __awaiter(this,void 0,void 0,(function*(){if(Utils.Assert(this.Has(e),"The slot does not belong to this selector."),e.Type()===Slot.Type.FILES){const e=Data.Singleton().File({book_name:this.Books().Items().Selected().Name(),language_name:this.Languages().Items().Selected().Name(),version_name:this.Versions().Items().Selected().Name(),file_name:this.Files().Items().Selected().Name()});yield this.Selector().Body().Browser().Body().Reader().Open_File(e)}else if(this.At(this.Count()-1)===e)yield this.Push(),yield this.Selector().Body().Browser().Body().Reader().Open_File(null);else{const t=this.Has_Books()&&this.Books().Items().Has_Selected()?this.Books().Items().Selected().Name():null,s=this.Has_Languages()&&this.Languages().Items().Has_Selected()?this.Languages().Items().Selected().Name():null,o=this.Has_Versions()&&this.Versions().Items().Has_Selected()?this.Versions().Items().Selected().Name():null,i=this.Has_Files()&&this.Files().Items().Has_Selected()?this.Files().Items().Selected().Name():null;for(;this.Count()>e.Index()+1;)this.Pop();for(yield this.Push();this.Count()<Instance.Max_Count();){const e=this.At(this.Count()-1);let i=null;if(e.Type()===Slot.Type.BOOKS&&null!=t?i=e.Items().Maybe_From(t):e.Type()===Slot.Type.LANGUAGES&&null!=s?i=e.Items().Maybe_From(s):e.Type()===Slot.Type.VERSIONS&&null!=o&&(i=e.Items().Maybe_From(o)),null==i)return;yield i.Select()}const l=this.At(this.Count()-1);if(l.Type()===Slot.Type.FILES&&null!=i){const e=l.Items().Maybe_From(i);if(null==e)return;yield e.Select()}}}))}Select(e){return __awaiter(this,void 0,void 0,(function*(){const t=this.Types();for(let s=0,o=Instance.Max_Count();s<o;s+=1){s===this.Count()&&(yield this.Push());const o=t[s];o===Slot.Type.BOOKS?yield this.Books().Items().From(e.Book()).Select():o===Slot.Type.LANGUAGES?yield this.Languages().Items().From(e.Language()).Select():o===Slot.Type.VERSIONS?yield this.Versions().Items().From(e.Version()).Select():o===Slot.Type.FILES&&(yield this.Files().Items().From(e.File()).Select())}}))}Select_At(e){return __awaiter(this,void 0,void 0,(function*(){const t=this.Types();for(let s=0,o=Instance.Max_Count();s<o;s+=1){s===this.Count()&&(yield this.Push());const o=t[s];o===Slot.Type.BOOKS?yield this.Books().Items().At(e.Book()).Select():o===Slot.Type.LANGUAGES?yield this.Languages().Items().At(e.Language()).Select():o===Slot.Type.VERSIONS?yield this.Versions().Items().At(e.Version()).Select():o===Slot.Type.FILES&&(yield this.Files().Items().At(e.File()).Select())}}))}After_Dependencies_Are_Ready(){return __awaiter(this,void 0,void 0,(function*(){this.first_selection instanceof Selection.Name?yield this.Select(this.first_selection):this.first_selection instanceof Selection.Index?yield this.Select_At(this.first_selection):yield this.Push()}))}}Instance.MAX_SLOT_COUNT=4;