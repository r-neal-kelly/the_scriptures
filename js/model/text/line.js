import*as Utils from"../../utils.js";import*as Unicode from"../../unicode.js";import*as Language from"../language.js";import*as Dictionary from"./dictionary.js";import*as Part from"./part.js";import*as Path from"./path.js";export class Instance{constructor({text:t,index:a,value:e}){this.text=t,this.index=a,this.paths={},this.has_errorless_path=!1,this.Set_Value(e)}Text(){return this.text}Index(){return this.index}Value(t){return this.paths.hasOwnProperty(t)||(t=Path.Type.DEFAULT),this.paths[t].Value()}Set_Value(t){ this.paths={},this.has_errorless_path=!1,this.Set_Path(Path.Type.DEFAULT,t),this.has_errorless_path&&this.Set_Path(Path.Type.ERRORLESS,Part.Command.Resolve_Errors(t,!1))}Is_Centered(t){return this.paths.hasOwnProperty(t)||(t=Path.Type.DEFAULT),this.paths[t].Is_Centered()}Is_Padded(t){return this.paths.hasOwnProperty(t)||(t=Path.Type.DEFAULT),this.paths[t].Is_Padded()}Padding_Count(t){return this.paths.hasOwnProperty(t)||(t=Path.Type.DEFAULT),this.paths[t].Padding_Count()}Set_Path(t,a){let e;!function(t){t[t.WORD=0]="WORD",t[t.BREAK=1]="BREAK",t[t.POINT=2]="POINT"}(e||(e={}));const n=this.Text().Dictionary();this.paths[t]=new Path.Instance({type:t,value:a});let s=Part.Style._NONE_,r=[],o=e.POINT,_=new Unicode.Iterator({text:this.paths[t].Value()});const h=Part.Command.First_Non_Command_Index(this.paths[t].Value()),i=Part.Command.Last_Non_Command_Index(this.paths[t].Value());class l{constructor({parameter:t,argument:a,from_text:e,from_text_index:n}){this.first_non_command_index=Part.Command.First_Non_Command_Index(a),null!=this.first_non_command_index&&(this.first_non_command_index=n+Part.Command.Symbol.FIRST.length+t.length+Part.Command.Symbol.DIVIDER.length+this.first_non_command_index),this.last_non_command_index=Part.Command.Last_Non_Command_Index(a),null!=this.last_non_command_index&&(this.last_non_command_index=n+Part.Command.Symbol.FIRST.length+t.length+Part.Command.Symbol.DIVIDER.length+this.last_non_command_index),this.closing_command_index=Part.Command.Closing_Command_Index_From_Opening_Command(e)||-1,-1!==this.closing_command_index?this.closing_command_index=n+this.closing_command_index:this.closing_command_index=n+e.length}First_Non_Command_Index(){return this.first_non_command_index}Last_Non_Command_Index(){return this.last_non_command_index}Closing_Command_Index(){return this.closing_command_index}}const m=[];function d(t,a){if(m.length>0){const e=m[m.length-1];return t.Index()===e.First_Non_Command_Index()&&(null==h||a.Index()<h)?Dictionary.Boundary.START:a.Index()===e.Last_Non_Command_Index()&&(null==i||e.Closing_Command_Index()>i)?Dictionary.Boundary.END:Dictionary.Boundary.MIDDLE}return t.Index()===h?Dictionary.Boundary.START:a.Index()===i?Dictionary.Boundary.END:Dictionary.Boundary.MIDDLE}for(let a=_;!a.Is_At_End();){const h=Part.Command.Maybe_Valid_Value_From(a.Points());if(null!=h){let e=new Part.Command.Instance({index:this.paths[t].Micro_Part_Count(),value:h,language:r.length>0?r[r.length-1]:null}),n=new Part.Command.Instance({index:this.paths[t].Macro_Part_Count(),value:h,language:r.length>0?r[r.length-1]:null});if(n.Is_Open_Italic())s|=Part.Style.ITALIC;else if(n.Is_Close_Italic())s&=~Part.Style.ITALIC;else if(n.Is_Open_Bold())s|=Part.Style.BOLD;else if(n.Is_Close_Bold())s&=~Part.Style.BOLD;else if(n.Is_Open_Underline())s|=Part.Style.UNDERLINE;else if(n.Is_Close_Underline())s&=~Part.Style.UNDERLINE;else if(n.Is_Open_Small_Caps())s|=Part.Style.SMALL_CAPS;else if(n.Is_Close_Small_Caps())s&=~Part.Style.SMALL_CAPS;else if(n.Is_Open_Error())if(this.has_errorless_path=!0,n.Has_Argument()){const o=Part.Command.Symbol.FIRST+n.Some_Parameter()+Part.Command.Symbol.DIVIDER;m.push(new l({parameter:n.Some_Parameter(),argument:n.Some_Argument(),from_text:a.Points(),from_text_index:a.Index()})),e=new Part.Command.Instance({index:this.paths[t].Micro_Part_Count(),value:o,language:r.length>0?r[r.length-1]:null}),n=new Part.Command.Instance({index:this.paths[t].Macro_Part_Count(),value:o,language:r.length>0?r[r.length-1]:null}),e.Set_Status(Part.Status.GOOD),n.Set_Status(Part.Status.GOOD),s|=Part.Style.ARGUMENT}else s|=Part.Style.ERROR;else n.Is_Close_Error()?s&=~Part.Style.ERROR:n.Is_Open_Hebrew()?r.push(Language.Name.HEBREW):n.Is_Open_Greek()?r.push(Language.Name.GREEK):n.Is_Open_Latin()?r.push(Language.Name.LATIN):n.Is_Open_Aramaic()?r.push(Language.Name.ARAMAIC):n.Is_Open_Arabic()?r.push(Language.Name.ARABIC):n.Is_Open_German()?r.push(Language.Name.GERMAN):n.Is_Open_French()?r.push(Language.Name.FRENCH):n.Is_Open_Italian()?r.push(Language.Name.ITALIAN):n.Is_Open_Dutch()?r.push(Language.Name.DUTCH):n.Is_Open_English()?r.push(Language.Name.ENGLISH):n.Is_Close_Language()&&r.length>0&&r.pop();this.paths[t].Update_Micro(e),this.paths[t].Update_Macro(n),a=new Unicode.Iterator({text:a.Text(),index:a.Index()+n.Value().length}),_=a}else if(m.length>0&&a.Point()===Part.Command.Symbol.LAST){m.pop(),0===m.length&&(s&=~Part.Style.ARGUMENT);const e=new Part.Command.Instance({index:this.paths[t].Micro_Part_Count(),value:Part.Command.Symbol.LAST,language:r.length>0?r[r.length-1]:null}),n=new Part.Command.Instance({index:this.paths[t].Macro_Part_Count(),value:Part.Command.Symbol.LAST,language:r.length>0?r[r.length-1]:null});e.Set_Status(Part.Status.GOOD),n.Set_Status(Part.Status.GOOD),s|=Part.Style.ERROR,this.paths[t].Update_Micro(e),this.paths[t].Update_Macro(n),a=a.Next(),_=a}else{const h=a.Point(),i=a.Look_Forward_Point(),l=Part.Command.Maybe_Valid_Value_From(a.Look_Forward_Points()||"");if(n.Has_Letter(h)){const a=new Part.Letter.Instance({index:this.paths[t].Micro_Part_Count(),value:h,style:s,language:r.length>0?r[r.length-1]:null});this.paths[t].Update_Micro(a),o=e.WORD}else if(n.Has_Marker(h)){const a=new Part.Marker.Instance({index:this.paths[t].Micro_Part_Count(),value:h,style:s,language:r.length>0?r[r.length-1]:null});this.paths[t].Update_Micro(a),o=e.BREAK}else{const n=new Part.Point.Instance({index:this.paths[t].Micro_Part_Count(),value:h,style:s,language:r.length>0?r[r.length-1]:null}),i=new Part.Point.Instance({index:this.paths[t].Macro_Part_Count(),value:h,style:s,language:r.length>0?r[r.length-1]:null});this.paths[t].Update_Micro(n),o=e.POINT,this.paths[t].Update_Macro(i),_=a.Next()}if(o===e.WORD){if(null==i||null!=l||!n.Has_Letter(i)){const e=a.Text().slice(_.Index(),a.Look_Forward_Index()),o=n.Has_Word(e)?Part.Status.GOOD:n.Has_Word_Error(e)?Part.Status.ERROR:Part.Status.UNKNOWN,h=new Part.Word.Instance({index:this.paths[t].Macro_Part_Count(),value:e,status:o,style:s,language:r.length>0?r[r.length-1]:null});this.paths[t].Update_Macro(h),_=a.Next()}}else if(o===e.BREAK&&(null==i||null!=l||!n.Has_Marker(i))){const e=a.Text().slice(_.Index(),a.Look_Forward_Index()),o=d(_,a),h=n.Has_Break(e,o)?Part.Status.GOOD:n.Has_Break_Error(e,o)?Part.Status.ERROR:Part.Status.UNKNOWN,i=new Part.Break.Instance({index:this.paths[t].Macro_Part_Count(),value:e,status:h,style:s,language:r.length>0?r[r.length-1]:null,boundary:o});this.paths[t].Update_Macro(i),_=a.Next()}a=a.Next()}}this.paths[t].Finalize()}Has_Micro_Part(t,a){return this.paths.hasOwnProperty(a)||(a=Path.Type.DEFAULT),this.paths[a].Has_Micro_Part(t)}Micro_Part_Count(t){return this.paths.hasOwnProperty(t)||(t=Path.Type.DEFAULT),this.paths[t].Micro_Part_Count()}Micro_Part(t,a){return this.paths.hasOwnProperty(a)||(a=Path.Type.DEFAULT),this.paths[a].Micro_Part(t)}Has_Macro_Part(t,a){return this.paths.hasOwnProperty(a)||(a=Path.Type.DEFAULT),this.paths[a].Has_Macro_Part(t)}Macro_Part_Count(t){return this.paths.hasOwnProperty(t)||(t=Path.Type.DEFAULT),this.paths[t].Macro_Part_Count()}Macro_Part(t,a){return this.paths.hasOwnProperty(a)||(a=Path.Type.DEFAULT),this.paths[a].Macro_Part(t)}Micro_Segment_Count(t){return this.paths.hasOwnProperty(t)||(t=Path.Type.DEFAULT),this.paths[t].Micro_Segment_Count()}Micro_Segment(t,a){return this.paths.hasOwnProperty(a)||(a=Path.Type.DEFAULT),this.paths[a].Micro_Segment(t)}Micro_Part_Segment_Item_Indices(t,a){return this.paths.hasOwnProperty(a)||(a=Path.Type.DEFAULT),this.paths[a].Micro_Part_Segment_Item_Indices(t)}Macro_Segment_Count(t){return this.paths.hasOwnProperty(t)||(t=Path.Type.DEFAULT),this.paths[t].Macro_Segment_Count()}Macro_Segment(t,a){return this.paths.hasOwnProperty(a)||(a=Path.Type.DEFAULT),this.paths[a].Macro_Segment(t)}Macro_Part_Segment_Item_Indices(t,a){return this.paths.hasOwnProperty(a)||(a=Path.Type.DEFAULT),this.paths[a].Macro_Part_Segment_Item_Indices(t)}}