import*as Utils from"../../utils.js";import*as Unicode from"../../unicode.js";import*as Languages from"../languages.js";import*as Dictionary from"./dictionary.js";import*as Part from"./part.js";import*as Split from"./split.js";import*as Segment from"./segment.js";export var Path_Type;!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.ERRORLESS=1]="ERRORLESS"}(Path_Type||(Path_Type={}));class Path{constructor(){this.micro_parts=[],this.macro_parts=[],this.micro_segments=[],this.macro_segments=[],this.micro_part_index_to_segment_item_indices={},this.macro_part_index_to_segment_item_indices={},this.working_micro_segment=new Segment.Instance({segment_type:Segment.Type.MICRO,index:this.micro_segments.length}),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO,index:this.macro_segments.length})}Update_Micro(t){this.micro_parts.push(t),this.Update_Micro_Segments(t)}Update_Macro(t){if(this.macro_parts.push(t),t.Is_Command())this.Update_Macro_Segments_With_Command(t);else if(t.Is_Break()){const e=Split.From(t);for(const t of e)this.Update_Macro_Segments(t)}else this.Update_Macro_Segments(t)}Update_Micro_Segments(t){this.working_micro_segment.Try_Add_Item(t)||(this.micro_segments.push(this.working_micro_segment),this.working_micro_segment=new Segment.Instance({segment_type:Segment.Type.MICRO,index:this.micro_segments.length}),this.working_micro_segment.Add_Item(t));const e=t.Part_Index(),s={segment_index:this.working_micro_segment.Index(),item_index:this.working_micro_segment.Item_Count()-1};Object.freeze(s),null==this.micro_part_index_to_segment_item_indices[e]&&(this.micro_part_index_to_segment_item_indices[e]=[]),this.micro_part_index_to_segment_item_indices[e].push(s)}Update_Macro_Segments(t){this.working_macro_segment.Try_Add_Item(t)||(this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO,index:this.macro_segments.length}),this.working_macro_segment.Add_Item(t));const e=t.Part_Index(),s={segment_index:this.working_macro_segment.Index(),item_index:this.working_macro_segment.Item_Count()-1};Object.freeze(s),null==this.macro_part_index_to_segment_item_indices[e]&&(this.macro_part_index_to_segment_item_indices[e]=[]),this.macro_part_index_to_segment_item_indices[e].push(s)}Update_Macro_Segments_With_Command(t){t.Value()===Part.Command.Known_Value.OPEN_LEFT_TO_RIGHT?(this.Update_Macro_Segments(t),this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO_LEFT_TO_RIGHT,index:this.macro_segments.length})):t.Value()===Part.Command.Known_Value.OPEN_RIGHT_TO_LEFT?(this.Update_Macro_Segments(t),this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO_RIGHT_TO_LEFT,index:this.macro_segments.length})):t.Value()===Part.Command.Known_Value.CLOSE_LEFT_TO_RIGHT||t.Value()===Part.Command.Known_Value.CLOSE_RIGHT_TO_LEFT?(this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO,index:this.macro_segments.length}),this.Update_Macro_Segments(t)):this.Update_Macro_Segments(t)}Finalize(){this.working_micro_segment.Item_Count()>0&&(this.micro_segments.push(this.working_micro_segment),this.working_micro_segment=new Segment.Instance({segment_type:Segment.Type.MICRO,index:0})),Object.freeze(this.micro_parts),Object.freeze(this.micro_segments),Object.freeze(this.micro_part_index_to_segment_item_indices),Object.freeze(this.working_micro_segment),this.working_macro_segment.Item_Count()>0&&(this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO,index:0})),Object.freeze(this.macro_parts),Object.freeze(this.macro_segments),Object.freeze(this.macro_part_index_to_segment_item_indices),Object.freeze(this.working_macro_segment)}Has_Micro_Part(t){return Utils.Assert(t>-1,"micro_part_index must be greater than -1."),t<this.Micro_Part_Count()}Micro_Part_Count(){return this.micro_parts.length}Micro_Part(t){return Utils.Assert(this.Has_Micro_Part(t),`Does not have micro_part at index ${t}.`),this.micro_parts[t]}Has_Macro_Part(t){return Utils.Assert(t>-1,"macro_part_index must be greater than -1."),t<this.Macro_Part_Count()}Macro_Part_Count(){return this.macro_parts.length}Macro_Part(t){return Utils.Assert(this.Has_Macro_Part(t),`Does not have macro_part at index ${t}.`),this.macro_parts[t]}Micro_Segment_Count(){return this.micro_segments.length}Micro_Segment(t){return Utils.Assert(t>-1,"micro_segment_index must be greater than -1."),Utils.Assert(t<this.Micro_Segment_Count(),"micro_segment_index must be less than micro_segment_count."),this.micro_segments[t]}Micro_Part_Segment_Item_Indices(t){Utils.Assert(this.micro_part_index_to_segment_item_indices.hasOwnProperty(t),`Invalid index: ${t}.`);const e=this.micro_part_index_to_segment_item_indices[t];return Object.isFrozen(e)||Object.freeze(e),e}Macro_Segment_Count(){return this.macro_segments.length}Macro_Segment(t){return Utils.Assert(t>-1,"macro_segment_index must be greater than -1."),Utils.Assert(t<this.Macro_Segment_Count(),"macro_segment_index must be less than macro_segment_count."),this.macro_segments[t]}Macro_Part_Segment_Item_Indices(t){Utils.Assert(this.macro_part_index_to_segment_item_indices.hasOwnProperty(t),`Invalid index: ${t}.`);const e=this.macro_part_index_to_segment_item_indices[t];return Object.isFrozen(e)||Object.freeze(e),e}}export class Instance{constructor({text:t,index:e,value:s}){this.text=t,this.index=e,this.value="",this.is_centered=!1,this.is_indented=!1,this.has_errorless_path=!1,this.paths={},this.Set_Value(s)}Text(){return this.text}Index(){return this.index}Value(){return this.value}Set_Value(t){Utils.Assert(!/\r?\n/.test(t),"A line cannot have any line-breaks."),this.value=t,this.is_centered=this.value.slice(0,Part.Command.Known_Value.CENTER.length)===Part.Command.Known_Value.CENTER,this.is_indented=this.value.slice(0,Part.Command.Known_Value.INDENT.length)===Part.Command.Known_Value.INDENT,this.has_errorless_path=!1,this.paths={},this.Set_Path(Path_Type.DEFAULT),this.has_errorless_path&&this.Set_Path(Path_Type.ERRORLESS)}Is_Centered(){return this.is_centered}Is_Indented(){return this.is_indented}Set_Path(t){let e;!function(t){t[t.WORD=0]="WORD",t[t.BREAK=1]="BREAK",t[t.POINT=2]="POINT"}(e||(e={}));const s=this.Text().Dictionary();this.paths[t]=new Path;let n=Part.Style._NONE_,r=[],a=e.POINT,_=new Unicode.Iterator({text:this.value}),i=null;const o=Part.Command.Last_Non_Value_Index(this.value);for(let h=_;!h.Is_At_End();){const m=Part.Command.Maybe_Valid_Value_From(h.Points());if(null!=m){const e=new Part.Command.Instance({index:this.paths[t].Micro_Part_Count(),value:m}),s=new Part.Command.Instance({index:this.paths[t].Macro_Part_Count(),value:m});s.Is_Open_Italic()?n|=Part.Style.ITALIC:s.Is_Close_Italic()?n&=~Part.Style.ITALIC:s.Is_Open_Bold()?n|=Part.Style.BOLD:s.Is_Close_Bold()?n&=~Part.Style.BOLD:s.Is_Open_Underline()?n|=Part.Style.UNDERLINE:s.Is_Close_Underline()?n&=~Part.Style.UNDERLINE:s.Is_Open_Small_Caps()?n|=Part.Style.SMALL_CAPS:s.Is_Close_Small_Caps()?n&=~Part.Style.SMALL_CAPS:s.Is_Open_Error()?(n|=Part.Style.ERROR,t===Path_Type.DEFAULT&&s.Has_Argument()?this.has_errorless_path=!0:t===Path_Type.ERRORLESS&&s.Has_Argument()):s.Is_Close_Error()?n&=~Part.Style.ERROR:s.Is_Open_English()?r.push(Languages.Name.ENGLISH):s.Is_Open_Hebrew()?r.push(Languages.Name.HEBREW):s.Is_Open_Greek()?r.push(Languages.Name.GREEK):s.Is_Open_Latin()?r.push(Languages.Name.LATIN):s.Is_Close_Language()&&r.length>0&&r.pop(),this.paths[t].Update_Micro(e),this.paths[t].Update_Macro(s),h=new Unicode.Iterator({text:h.Text(),index:h.Index()+m.length}),_=h}else{const m=h.Point(),c=h.Look_Forward_Point(),g=Part.Command.Maybe_Valid_Value_From(h.Look_Forward_Points()||"");if(s.Has_Letter(m)){const s=new Part.Letter.Instance({index:this.paths[t].Micro_Part_Count(),value:m,style:n,language:r.length>0?r[r.length-1]:null});this.paths[t].Update_Micro(s),a=e.WORD}else if(s.Has_Marker(m)){const s=new Part.Marker.Instance({index:this.paths[t].Micro_Part_Count(),value:m,style:n,language:r.length>0?r[r.length-1]:null});this.paths[t].Update_Micro(s),a=e.BREAK}else{const s=new Part.Point.Instance({index:this.paths[t].Micro_Part_Count(),value:m,style:n,language:r.length>0?r[r.length-1]:null}),o=new Part.Point.Instance({index:this.paths[t].Macro_Part_Count(),value:m,style:n,language:r.length>0?r[r.length-1]:null});this.paths[t].Update_Micro(s),a=e.POINT,null==i&&(i=h.Index()),this.paths[t].Update_Macro(o),_=h.Next()}if(a===e.WORD){if(null==c||null!=g||!s.Has_Letter(c)){null==i&&(i=h.Index());const e=h.Text().slice(_.Index(),h.Look_Forward_Index()),a=s.Has_Word(e)?Part.Status.GOOD:s.Has_Word_Error(e)?Part.Status.ERROR:Part.Status.UNKNOWN,o=new Part.Word.Instance({index:this.paths[t].Macro_Part_Count(),value:e,status:a,style:n,language:r.length>0?r[r.length-1]:null});this.paths[t].Update_Macro(o),_=h.Next()}}else if(a===e.BREAK&&(null==c||null!=g||!s.Has_Marker(c))){null==i&&(i=h.Index());const e=h.Text().slice(_.Index(),h.Look_Forward_Index()),a=h.Index()===i?Dictionary.Boundary.START:h.Index()===o?Dictionary.Boundary.END:Dictionary.Boundary.MIDDLE,m=s.Has_Break(e,a)?Part.Status.GOOD:s.Has_Break_Error(e,a)?Part.Status.ERROR:Part.Status.UNKNOWN,c=new Part.Break.Instance({index:this.paths[t].Macro_Part_Count(),value:e,status:m,style:n,language:r.length>0?r[r.length-1]:null});this.paths[t].Update_Macro(c),_=h.Next()}h=h.Next()}}this.paths[t].Finalize()}Has_Micro_Part(t,e=Path_Type.DEFAULT){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Has_Micro_Part(t)}Micro_Part_Count(t=Path_Type.DEFAULT){return this.paths.hasOwnProperty(t)||(t=Path_Type.DEFAULT),this.paths[t].Micro_Part_Count()}Micro_Part(t,e=Path_Type.DEFAULT){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Micro_Part(t)}Has_Macro_Part(t,e=Path_Type.DEFAULT){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Has_Macro_Part(t)}Macro_Part_Count(t=Path_Type.DEFAULT){return this.paths.hasOwnProperty(t)||(t=Path_Type.DEFAULT),this.paths[t].Macro_Part_Count()}Macro_Part(t,e=Path_Type.DEFAULT){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Macro_Part(t)}Micro_Segment_Count(t=Path_Type.DEFAULT){return this.paths.hasOwnProperty(t)||(t=Path_Type.DEFAULT),this.paths[t].Micro_Segment_Count()}Micro_Segment(t,e=Path_Type.DEFAULT){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Micro_Segment(t)}Micro_Part_Segment_Item_Indices(t,e=Path_Type.DEFAULT){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Micro_Part_Segment_Item_Indices(t)}Macro_Segment_Count(t=Path_Type.DEFAULT){return this.paths.hasOwnProperty(t)||(t=Path_Type.DEFAULT),this.paths[t].Macro_Segment_Count()}Macro_Segment(t,e=Path_Type.DEFAULT){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Macro_Segment(t)}Macro_Part_Segment_Item_Indices(t,e=Path_Type.DEFAULT){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Macro_Part_Segment_Item_Indices(t)}}