import*as Utils from"../../utils.js";import*as Unicode from"../../unicode.js";import*as Languages from"../languages.js";import*as Dictionary from"./dictionary.js";import*as Part from"./part.js";import*as Split from"./split.js";import*as Segment from"./segment.js";export var Path_Type;!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.ERRORLESS=1]="ERRORLESS"}(Path_Type||(Path_Type={}));class Path{constructor(t){this.value=t,this.is_centered=this.value.slice(0,Part.Command.Known_Value.CENTER.length)===Part.Command.Known_Value.CENTER,this.is_indented=this.value.slice(0,Part.Command.Known_Value.INDENT.length)===Part.Command.Known_Value.INDENT,this.micro_parts=[],this.macro_parts=[],this.micro_segments=[],this.macro_segments=[],this.micro_part_index_to_segment_item_indices={},this.macro_part_index_to_segment_item_indices={},this.working_micro_segment=new Segment.Instance({segment_type:Segment.Type.MICRO,index:this.micro_segments.length}),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO,index:this.macro_segments.length})}Update_Micro(t){this.micro_parts.push(t),this.Update_Micro_Segments(t)}Update_Macro(t){if(this.macro_parts.push(t),t.Is_Command())this.Update_Macro_Segments_With_Command(t);else if(t.Is_Break()){const e=Split.From(t);for(const t of e)this.Update_Macro_Segments(t)}else this.Update_Macro_Segments(t)}Update_Micro_Segments(t){this.working_micro_segment.Try_Add_Item(t)||(this.micro_segments.push(this.working_micro_segment),this.working_micro_segment=new Segment.Instance({segment_type:Segment.Type.MICRO,index:this.micro_segments.length}),this.working_micro_segment.Add_Item(t));const e=t.Part_Index(),s={segment_index:this.working_micro_segment.Index(),item_index:this.working_micro_segment.Item_Count()-1};Object.freeze(s),null==this.micro_part_index_to_segment_item_indices[e]&&(this.micro_part_index_to_segment_item_indices[e]=[]),this.micro_part_index_to_segment_item_indices[e].push(s)}Update_Macro_Segments(t){this.working_macro_segment.Try_Add_Item(t)||(this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO,index:this.macro_segments.length}),this.working_macro_segment.Add_Item(t));const e=t.Part_Index(),s={segment_index:this.working_macro_segment.Index(),item_index:this.working_macro_segment.Item_Count()-1};Object.freeze(s),null==this.macro_part_index_to_segment_item_indices[e]&&(this.macro_part_index_to_segment_item_indices[e]=[]),this.macro_part_index_to_segment_item_indices[e].push(s)}Update_Macro_Segments_With_Command(t){t.Value()===Part.Command.Known_Value.OPEN_LEFT_TO_RIGHT?(this.Update_Macro_Segments(t),this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO_LEFT_TO_RIGHT,index:this.macro_segments.length})):t.Value()===Part.Command.Known_Value.OPEN_RIGHT_TO_LEFT?(this.Update_Macro_Segments(t),this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO_RIGHT_TO_LEFT,index:this.macro_segments.length})):t.Value()===Part.Command.Known_Value.CLOSE_LEFT_TO_RIGHT||t.Value()===Part.Command.Known_Value.CLOSE_RIGHT_TO_LEFT?(this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO,index:this.macro_segments.length}),this.Update_Macro_Segments(t)):this.Update_Macro_Segments(t)}Finalize(){this.working_micro_segment.Item_Count()>0&&(this.micro_segments.push(this.working_micro_segment),this.working_micro_segment=new Segment.Instance({segment_type:Segment.Type.MICRO,index:0})),Object.freeze(this.micro_parts),Object.freeze(this.micro_segments),Object.freeze(this.micro_part_index_to_segment_item_indices),Object.freeze(this.working_micro_segment),this.working_macro_segment.Item_Count()>0&&(this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO,index:0})),Object.freeze(this.macro_parts),Object.freeze(this.macro_segments),Object.freeze(this.macro_part_index_to_segment_item_indices),Object.freeze(this.working_macro_segment)}Value(){return this.value}Is_Centered(){return this.is_centered}Is_Indented(){return this.is_indented}Has_Micro_Part(t){return Utils.Assert(t>-1,"micro_part_index must be greater than -1."),t<this.Micro_Part_Count()}Micro_Part_Count(){return this.micro_parts.length}Micro_Part(t){return Utils.Assert(this.Has_Micro_Part(t),`Does not have micro_part at index ${t}.`),this.micro_parts[t]}Has_Macro_Part(t){return Utils.Assert(t>-1,"macro_part_index must be greater than -1."),t<this.Macro_Part_Count()}Macro_Part_Count(){return this.macro_parts.length}Macro_Part(t){return Utils.Assert(this.Has_Macro_Part(t),`Does not have macro_part at index ${t}.`),this.macro_parts[t]}Micro_Segment_Count(){return this.micro_segments.length}Micro_Segment(t){return Utils.Assert(t>-1,"micro_segment_index must be greater than -1."),Utils.Assert(t<this.Micro_Segment_Count(),"micro_segment_index must be less than micro_segment_count."),this.micro_segments[t]}Micro_Part_Segment_Item_Indices(t){Utils.Assert(this.micro_part_index_to_segment_item_indices.hasOwnProperty(t),`Invalid index: ${t}.`);const e=this.micro_part_index_to_segment_item_indices[t];return Object.isFrozen(e)||Object.freeze(e),e}Macro_Segment_Count(){return this.macro_segments.length}Macro_Segment(t){return Utils.Assert(t>-1,"macro_segment_index must be greater than -1."),Utils.Assert(t<this.Macro_Segment_Count(),"macro_segment_index must be less than macro_segment_count."),this.macro_segments[t]}Macro_Part_Segment_Item_Indices(t){Utils.Assert(this.macro_part_index_to_segment_item_indices.hasOwnProperty(t),`Invalid index: ${t}.`);const e=this.macro_part_index_to_segment_item_indices[t];return Object.isFrozen(e)||Object.freeze(e),e}}export class Instance{constructor({text:t,index:e,value:s}){this.text=t,this.index=e,this.paths={},this.has_errorless_path=!1,this.Set_Value(s)}Text(){return this.text}Index(){return this.index}Value(t=Path_Type.DEFAULT){return this.paths[t].Value()}Set_Value(t){Utils.Assert(!/\r?\n/.test(t),"A line cannot have any line-breaks."),this.paths={},this.has_errorless_path=!1,this.Set_Path(Path_Type.DEFAULT,t),this.has_errorless_path&&this.Set_Path(Path_Type.ERRORLESS,t)}Is_Centered(t=Path_Type.DEFAULT){return this.paths[t].Is_Centered()}Is_Indented(t=Path_Type.DEFAULT){return this.paths[t].Is_Indented()}Set_Path(t,e){let s;!function(t){t[t.WORD=0]="WORD",t[t.BREAK=1]="BREAK",t[t.POINT=2]="POINT"}(s||(s={}));const n=this.Text().Dictionary();this.paths[t]=new Path(e);let a=Part.Style._NONE_,r=[],_=s.POINT,i=new Unicode.Iterator({text:this.paths[t].Value()});const o=Part.Command.First_Non_Value_Index(this.paths[t].Value()),m=Part.Command.Last_Non_Value_Index(this.paths[t].Value());let h=!1,c=null,g=null;for(let e=i;!e.Is_At_End();){const d=Part.Command.Maybe_Valid_Value_From(e.Points());if(null!=d){let s=new Part.Command.Instance({index:this.paths[t].Micro_Part_Count(),value:d}),n=new Part.Command.Instance({index:this.paths[t].Macro_Part_Count(),value:d});if(n.Is_Open_Italic())a|=Part.Style.ITALIC;else if(n.Is_Close_Italic())a&=~Part.Style.ITALIC;else if(n.Is_Open_Bold())a|=Part.Style.BOLD;else if(n.Is_Close_Bold())a&=~Part.Style.BOLD;else if(n.Is_Open_Underline())a|=Part.Style.UNDERLINE;else if(n.Is_Close_Underline())a&=~Part.Style.UNDERLINE;else if(n.Is_Open_Small_Caps())a|=Part.Style.SMALL_CAPS;else if(n.Is_Close_Small_Caps())a&=~Part.Style.SMALL_CAPS;else if(n.Is_Open_Error())if(this.has_errorless_path=!0,t===Path_Type.DEFAULT&&n.Has_Argument()){h=!0,c=null,g=e.Index()+n.Value().length-Part.Command.Symbol.LAST.length;const a=Part.Command.Symbol.FIRST+n.Some_Parameter()+Part.Command.Symbol.DIVIDER;Utils.Assert(e.Points().slice(0,a.length)===a,"bad error command construction"),s=new Part.Command.Instance({index:this.paths[t].Micro_Part_Count(),value:a}),n=new Part.Command.Instance({index:this.paths[t].Macro_Part_Count(),value:a}),s.Set_Status(Part.Status.GOOD),n.Set_Status(Part.Status.GOOD)}else a|=Part.Style.ERROR;else n.Is_Close_Error()?a&=~Part.Style.ERROR:n.Is_Open_English()?r.push(Languages.Name.ENGLISH):n.Is_Open_Hebrew()?r.push(Languages.Name.HEBREW):n.Is_Open_Greek()?r.push(Languages.Name.GREEK):n.Is_Open_Latin()?r.push(Languages.Name.LATIN):n.Is_Close_Language()&&r.length>0&&r.pop();this.paths[t].Update_Micro(s),this.paths[t].Update_Macro(n),e=new Unicode.Iterator({text:e.Text(),index:e.Index()+n.Value().length}),i=e}else if(h&&e.Point()===Part.Command.Symbol.LAST){h=!1;const s=new Part.Command.Instance({index:this.paths[t].Micro_Part_Count(),value:Part.Command.Symbol.LAST}),n=new Part.Command.Instance({index:this.paths[t].Macro_Part_Count(),value:Part.Command.Symbol.LAST});s.Set_Status(Part.Status.GOOD),n.Set_Status(Part.Status.GOOD),a|=Part.Style.ERROR,this.paths[t].Update_Micro(s),this.paths[t].Update_Macro(n),e=e.Next(),i=e}else{const g=e.Point(),d=e.Look_Forward_Point(),u=Part.Command.Maybe_Valid_Value_From(e.Look_Forward_Points()||"");if(n.Has_Letter(g)){const e=new Part.Letter.Instance({index:this.paths[t].Micro_Part_Count(),value:g,style:a,language:r.length>0?r[r.length-1]:null});this.paths[t].Update_Micro(e),_=s.WORD}else if(n.Has_Marker(g)){const e=new Part.Marker.Instance({index:this.paths[t].Micro_Part_Count(),value:g,style:a,language:r.length>0?r[r.length-1]:null});this.paths[t].Update_Micro(e),_=s.BREAK}else{const n=new Part.Point.Instance({index:this.paths[t].Micro_Part_Count(),value:g,style:a,language:r.length>0?r[r.length-1]:null}),o=new Part.Point.Instance({index:this.paths[t].Macro_Part_Count(),value:g,style:a,language:r.length>0?r[r.length-1]:null});this.paths[t].Update_Micro(n),_=s.POINT,h&&null==c&&(c=i.Index()),this.paths[t].Update_Macro(o),i=e.Next()}if(_===s.WORD){if(null==d||null!=u||!n.Has_Letter(d)){h&&null==c&&(c=i.Index());const s=e.Text().slice(i.Index(),e.Look_Forward_Index()),_=n.Has_Word(s)?Part.Status.GOOD:n.Has_Word_Error(s)?Part.Status.ERROR:Part.Status.UNKNOWN,o=new Part.Word.Instance({index:this.paths[t].Macro_Part_Count(),value:s,status:_,style:a,language:r.length>0?r[r.length-1]:null});this.paths[t].Update_Macro(o),i=e.Next()}}else if(_===s.BREAK&&(null==d||null!=u||!n.Has_Marker(d))){h&&null==c&&(c=i.Index());const s=e.Text().slice(i.Index(),e.Look_Forward_Index()),_=(l=i,p=e,h?l.Index()===c&&(null==o||p.Index()<o)?Dictionary.Boundary.START:Dictionary.Boundary.MIDDLE:l.Index()===o?Dictionary.Boundary.START:p.Index()===m?Dictionary.Boundary.END:Dictionary.Boundary.MIDDLE),g=n.Has_Break(s,_)?Part.Status.GOOD:n.Has_Break_Error(s,_)?Part.Status.ERROR:Part.Status.UNKNOWN,d=new Part.Break.Instance({index:this.paths[t].Macro_Part_Count(),value:s,status:g,style:a,language:r.length>0?r[r.length-1]:null});this.paths[t].Update_Macro(d),i=e.Next()}e=e.Next()}}var l,p;this.paths[t].Finalize()}Has_Micro_Part(t,e=Path_Type.DEFAULT){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Has_Micro_Part(t)}Micro_Part_Count(t=Path_Type.DEFAULT){return this.paths.hasOwnProperty(t)||(t=Path_Type.DEFAULT),this.paths[t].Micro_Part_Count()}Micro_Part(t,e=Path_Type.DEFAULT){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Micro_Part(t)}Has_Macro_Part(t,e=Path_Type.DEFAULT){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Has_Macro_Part(t)}Macro_Part_Count(t=Path_Type.DEFAULT){return this.paths.hasOwnProperty(t)||(t=Path_Type.DEFAULT),this.paths[t].Macro_Part_Count()}Macro_Part(t,e=Path_Type.DEFAULT){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Macro_Part(t)}Micro_Segment_Count(t=Path_Type.DEFAULT){return this.paths.hasOwnProperty(t)||(t=Path_Type.DEFAULT),this.paths[t].Micro_Segment_Count()}Micro_Segment(t,e=Path_Type.DEFAULT){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Micro_Segment(t)}Micro_Part_Segment_Item_Indices(t,e=Path_Type.DEFAULT){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Micro_Part_Segment_Item_Indices(t)}Macro_Segment_Count(t=Path_Type.DEFAULT){return this.paths.hasOwnProperty(t)||(t=Path_Type.DEFAULT),this.paths[t].Macro_Segment_Count()}Macro_Segment(t,e=Path_Type.DEFAULT){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Macro_Segment(t)}Macro_Part_Segment_Item_Indices(t,e=Path_Type.DEFAULT){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Macro_Part_Segment_Item_Indices(t)}}