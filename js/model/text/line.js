import*as Utils from"../../utils.js";import*as Unicode from"../../unicode.js";import*as Languages from"../languages.js";import*as Dictionary from"./dictionary.js";import*as Part from"./part.js";import*as Split from"./split.js";import*as Segment from"./segment.js";export var Path_Type;!function(t){t[t.DEFAULT=0]="DEFAULT",t[t.ERRORLESS=1]="ERRORLESS"}(Path_Type||(Path_Type={}));class Path{constructor(t){this.value=t,this.is_centered=this.value.slice(0,Part.Command.Known_Value.CENTER.length)===Part.Command.Known_Value.CENTER,this.is_indented=this.value.slice(0,Part.Command.Known_Value.INDENT.length)===Part.Command.Known_Value.INDENT,this.micro_parts=[],this.macro_parts=[],this.micro_segments=[],this.macro_segments=[],this.micro_part_index_to_segment_item_indices={},this.macro_part_index_to_segment_item_indices={},this.working_micro_segment=new Segment.Instance({segment_type:Segment.Type.MICRO,index:this.micro_segments.length}),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO,index:this.macro_segments.length})}Update_Micro(t){this.micro_parts.push(t),this.Update_Micro_Segments(t)}Update_Macro(t){if(this.macro_parts.push(t),t.Is_Command())this.Update_Macro_Segments_With_Command(t);else if(t.Is_Break()){const e=Split.From(t);for(const t of e)this.Update_Macro_Segments(t)}else this.Update_Macro_Segments(t)}Update_Micro_Segments(t){this.working_micro_segment.Try_Add_Item(t)||(this.micro_segments.push(this.working_micro_segment),this.working_micro_segment=new Segment.Instance({segment_type:Segment.Type.MICRO,index:this.micro_segments.length}),this.working_micro_segment.Add_Item(t));const e=t.Part_Index(),n={segment_index:this.working_micro_segment.Index(),item_index:this.working_micro_segment.Item_Count()-1};Object.freeze(n),null==this.micro_part_index_to_segment_item_indices[e]&&(this.micro_part_index_to_segment_item_indices[e]=[]),this.micro_part_index_to_segment_item_indices[e].push(n)}Update_Macro_Segments(t){this.working_macro_segment.Try_Add_Item(t)||(this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO,index:this.macro_segments.length}),this.working_macro_segment.Add_Item(t));const e=t.Part_Index(),n={segment_index:this.working_macro_segment.Index(),item_index:this.working_macro_segment.Item_Count()-1};Object.freeze(n),null==this.macro_part_index_to_segment_item_indices[e]&&(this.macro_part_index_to_segment_item_indices[e]=[]),this.macro_part_index_to_segment_item_indices[e].push(n)}Update_Macro_Segments_With_Command(t){t.Value()===Part.Command.Known_Value.OPEN_LEFT_TO_RIGHT?(this.Update_Macro_Segments(t),this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO_LEFT_TO_RIGHT,index:this.macro_segments.length})):t.Value()===Part.Command.Known_Value.OPEN_RIGHT_TO_LEFT?(this.Update_Macro_Segments(t),this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO_RIGHT_TO_LEFT,index:this.macro_segments.length})):t.Value()===Part.Command.Known_Value.CLOSE_LEFT_TO_RIGHT||t.Value()===Part.Command.Known_Value.CLOSE_RIGHT_TO_LEFT?(this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO,index:this.macro_segments.length}),this.Update_Macro_Segments(t)):this.Update_Macro_Segments(t)}Finalize(){this.working_micro_segment.Item_Count()>0&&(this.micro_segments.push(this.working_micro_segment),this.working_micro_segment=new Segment.Instance({segment_type:Segment.Type.MICRO,index:0})),Object.freeze(this.micro_parts),Object.freeze(this.micro_segments),Object.freeze(this.micro_part_index_to_segment_item_indices),Object.freeze(this.working_micro_segment),this.working_macro_segment.Item_Count()>0&&(this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO,index:0})),Object.freeze(this.macro_parts),Object.freeze(this.macro_segments),Object.freeze(this.macro_part_index_to_segment_item_indices),Object.freeze(this.working_macro_segment)}Value(){return this.value}Is_Centered(){return this.is_centered}Is_Indented(){return this.is_indented}Has_Micro_Part(t){return Utils.Assert(t>-1,"micro_part_index must be greater than -1."),t<this.Micro_Part_Count()}Micro_Part_Count(){return this.micro_parts.length}Micro_Part(t){return Utils.Assert(this.Has_Micro_Part(t),`Does not have micro_part at index ${t}.`),this.micro_parts[t]}Has_Macro_Part(t){return Utils.Assert(t>-1,"macro_part_index must be greater than -1."),t<this.Macro_Part_Count()}Macro_Part_Count(){return this.macro_parts.length}Macro_Part(t){return Utils.Assert(this.Has_Macro_Part(t),`Does not have macro_part at index ${t}.`),this.macro_parts[t]}Micro_Segment_Count(){return this.micro_segments.length}Micro_Segment(t){return Utils.Assert(t>-1,"micro_segment_index must be greater than -1."),Utils.Assert(t<this.Micro_Segment_Count(),"micro_segment_index must be less than micro_segment_count."),this.micro_segments[t]}Micro_Part_Segment_Item_Indices(t){Utils.Assert(this.micro_part_index_to_segment_item_indices.hasOwnProperty(t),`Invalid index: ${t}.`);const e=this.micro_part_index_to_segment_item_indices[t];return Object.isFrozen(e)||Object.freeze(e),e}Macro_Segment_Count(){return this.macro_segments.length}Macro_Segment(t){return Utils.Assert(t>-1,"macro_segment_index must be greater than -1."),Utils.Assert(t<this.Macro_Segment_Count(),"macro_segment_index must be less than macro_segment_count."),this.macro_segments[t]}Macro_Part_Segment_Item_Indices(t){Utils.Assert(this.macro_part_index_to_segment_item_indices.hasOwnProperty(t),`Invalid index: ${t}.`);const e=this.macro_part_index_to_segment_item_indices[t];return Object.isFrozen(e)||Object.freeze(e),e}}export class Instance{constructor({text:t,index:e,value:n}){this.text=t,this.index=e,this.paths={},this.has_errorless_path=!1,this.Set_Value(n)}Text(){return this.text}Index(){return this.index}Value(t){return this.paths.hasOwnProperty(t)||(t=Path_Type.DEFAULT),this.paths[t].Value()}Set_Value(t){Utils.Assert(!/\r?\n/.test(t),"A line cannot have any line-breaks."),this.paths={},this.has_errorless_path=!1,this.Set_Path(Path_Type.DEFAULT,t),this.has_errorless_path&&this.Set_Path(Path_Type.ERRORLESS,Part.Command.Resolve_Errors(t,!1))}Is_Centered(t){return this.paths.hasOwnProperty(t)||(t=Path_Type.DEFAULT),this.paths[t].Is_Centered()}Is_Indented(t){return this.paths.hasOwnProperty(t)||(t=Path_Type.DEFAULT),this.paths[t].Is_Indented()}Set_Path(t,e){let n;!function(t){t[t.WORD=0]="WORD",t[t.BREAK=1]="BREAK",t[t.POINT=2]="POINT"}(n||(n={}));const s=this.Text().Dictionary();this.paths[t]=new Path(e);let a=Part.Style._NONE_,r=[],_=n.POINT,i=new Unicode.Iterator({text:this.paths[t].Value()});const o=Part.Command.First_Non_Command_Index(this.paths[t].Value()),m=Part.Command.Last_Non_Command_Index(this.paths[t].Value());class h{constructor({parameter:t,argument:e,from_text:n,from_text_index:s}){this.first_non_command_index=Part.Command.First_Non_Command_Index(e),null!=this.first_non_command_index&&(this.first_non_command_index=s+Part.Command.Symbol.FIRST.length+t.length+Part.Command.Symbol.DIVIDER.length+this.first_non_command_index),this.last_non_command_index=Part.Command.Last_Non_Command_Index(e),null!=this.last_non_command_index&&(this.last_non_command_index=s+Part.Command.Symbol.FIRST.length+t.length+Part.Command.Symbol.DIVIDER.length+this.last_non_command_index),this.closing_command_index=Part.Command.Closing_Command_Index_From_Opening_Command(n)||-1,-1!==this.closing_command_index?this.closing_command_index=s+this.closing_command_index:this.closing_command_index=s+n.length}First_Non_Command_Index(){return this.first_non_command_index}Last_Non_Command_Index(){return this.last_non_command_index}Closing_Command_Index(){return this.closing_command_index}}const c=[];function d(t,e){if(c.length>0){const n=c[c.length-1];return t.Index()===n.First_Non_Command_Index()&&(null==o||e.Index()<o)?Dictionary.Boundary.START:e.Index()===n.Last_Non_Command_Index()&&(null==m||n.Closing_Command_Index()>m)?Dictionary.Boundary.END:Dictionary.Boundary.MIDDLE}return t.Index()===o?Dictionary.Boundary.START:e.Index()===m?Dictionary.Boundary.END:Dictionary.Boundary.MIDDLE}for(let e=i;!e.Is_At_End();){const o=Part.Command.Maybe_Valid_Value_From(e.Points());if(null!=o){let n=new Part.Command.Instance({index:this.paths[t].Micro_Part_Count(),value:o}),s=new Part.Command.Instance({index:this.paths[t].Macro_Part_Count(),value:o});if(s.Is_Open_Italic())a|=Part.Style.ITALIC;else if(s.Is_Close_Italic())a&=~Part.Style.ITALIC;else if(s.Is_Open_Bold())a|=Part.Style.BOLD;else if(s.Is_Close_Bold())a&=~Part.Style.BOLD;else if(s.Is_Open_Underline())a|=Part.Style.UNDERLINE;else if(s.Is_Close_Underline())a&=~Part.Style.UNDERLINE;else if(s.Is_Open_Small_Caps())a|=Part.Style.SMALL_CAPS;else if(s.Is_Close_Small_Caps())a&=~Part.Style.SMALL_CAPS;else if(s.Is_Open_Error())if(this.has_errorless_path=!0,s.Has_Argument()){const r=Part.Command.Symbol.FIRST+s.Some_Parameter()+Part.Command.Symbol.DIVIDER;c.push(new h({parameter:s.Some_Parameter(),argument:s.Some_Argument(),from_text:e.Points(),from_text_index:e.Index()})),n=new Part.Command.Instance({index:this.paths[t].Micro_Part_Count(),value:r}),s=new Part.Command.Instance({index:this.paths[t].Macro_Part_Count(),value:r}),n.Set_Status(Part.Status.GOOD),s.Set_Status(Part.Status.GOOD),a|=Part.Style.ARGUMENT}else a|=Part.Style.ERROR;else s.Is_Close_Error()?a&=~Part.Style.ERROR:s.Is_Open_English()?r.push(Languages.Name.ENGLISH):s.Is_Open_Hebrew()?r.push(Languages.Name.HEBREW):s.Is_Open_Greek()?r.push(Languages.Name.GREEK):s.Is_Open_Latin()?r.push(Languages.Name.LATIN):s.Is_Close_Language()&&r.length>0&&r.pop();this.paths[t].Update_Micro(n),this.paths[t].Update_Macro(s),e=new Unicode.Iterator({text:e.Text(),index:e.Index()+s.Value().length}),i=e}else if(c.length>0&&e.Point()===Part.Command.Symbol.LAST){c.pop(),0===c.length&&(a&=~Part.Style.ARGUMENT);const n=new Part.Command.Instance({index:this.paths[t].Micro_Part_Count(),value:Part.Command.Symbol.LAST}),s=new Part.Command.Instance({index:this.paths[t].Macro_Part_Count(),value:Part.Command.Symbol.LAST});n.Set_Status(Part.Status.GOOD),s.Set_Status(Part.Status.GOOD),a|=Part.Style.ERROR,this.paths[t].Update_Micro(n),this.paths[t].Update_Macro(s),e=e.Next(),i=e}else{const o=e.Point(),m=e.Look_Forward_Point(),h=Part.Command.Maybe_Valid_Value_From(e.Look_Forward_Points()||"");if(s.Has_Letter(o)){const e=new Part.Letter.Instance({index:this.paths[t].Micro_Part_Count(),value:o,style:a,language:r.length>0?r[r.length-1]:null});this.paths[t].Update_Micro(e),_=n.WORD}else if(s.Has_Marker(o)){const e=new Part.Marker.Instance({index:this.paths[t].Micro_Part_Count(),value:o,style:a,language:r.length>0?r[r.length-1]:null});this.paths[t].Update_Micro(e),_=n.BREAK}else{const s=new Part.Point.Instance({index:this.paths[t].Micro_Part_Count(),value:o,style:a,language:r.length>0?r[r.length-1]:null}),m=new Part.Point.Instance({index:this.paths[t].Macro_Part_Count(),value:o,style:a,language:r.length>0?r[r.length-1]:null});this.paths[t].Update_Micro(s),_=n.POINT,this.paths[t].Update_Macro(m),i=e.Next()}if(_===n.WORD){if(null==m||null!=h||!s.Has_Letter(m)){const n=e.Text().slice(i.Index(),e.Look_Forward_Index()),_=s.Has_Word(n)?Part.Status.GOOD:s.Has_Word_Error(n)?Part.Status.ERROR:Part.Status.UNKNOWN,o=new Part.Word.Instance({index:this.paths[t].Macro_Part_Count(),value:n,status:_,style:a,language:r.length>0?r[r.length-1]:null});this.paths[t].Update_Macro(o),i=e.Next()}}else if(_===n.BREAK&&(null==m||null!=h||!s.Has_Marker(m))){const n=e.Text().slice(i.Index(),e.Look_Forward_Index()),_=d(i,e),o=s.Has_Break(n,_)?Part.Status.GOOD:s.Has_Break_Error(n,_)?Part.Status.ERROR:Part.Status.UNKNOWN,m=new Part.Break.Instance({index:this.paths[t].Macro_Part_Count(),value:n,status:o,style:a,language:r.length>0?r[r.length-1]:null,boundary:_});this.paths[t].Update_Macro(m),i=e.Next()}e=e.Next()}}this.paths[t].Finalize()}Has_Micro_Part(t,e){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Has_Micro_Part(t)}Micro_Part_Count(t){return this.paths.hasOwnProperty(t)||(t=Path_Type.DEFAULT),this.paths[t].Micro_Part_Count()}Micro_Part(t,e){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Micro_Part(t)}Has_Macro_Part(t,e){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Has_Macro_Part(t)}Macro_Part_Count(t){return this.paths.hasOwnProperty(t)||(t=Path_Type.DEFAULT),this.paths[t].Macro_Part_Count()}Macro_Part(t,e){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Macro_Part(t)}Micro_Segment_Count(t){return this.paths.hasOwnProperty(t)||(t=Path_Type.DEFAULT),this.paths[t].Micro_Segment_Count()}Micro_Segment(t,e){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Micro_Segment(t)}Micro_Part_Segment_Item_Indices(t,e){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Micro_Part_Segment_Item_Indices(t)}Macro_Segment_Count(t){return this.paths.hasOwnProperty(t)||(t=Path_Type.DEFAULT),this.paths[t].Macro_Segment_Count()}Macro_Segment(t,e){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Macro_Segment(t)}Macro_Part_Segment_Item_Indices(t,e){return this.paths.hasOwnProperty(e)||(e=Path_Type.DEFAULT),this.paths[e].Macro_Part_Segment_Item_Indices(t)}}