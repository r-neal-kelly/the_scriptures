import*as Utils from"../../../utils.js";import*as Part from"../part.js";import*as Split from"../split.js";import*as Segment from"../segment.js";export class Instance{constructor({type:e,value:t}){this.type=e,this.value=t,this.is_centered=Part.Command.Is_Centered(this.value),this.padding_count=Part.Command.Padding_Count(this.value),this.micro_parts=[],this.macro_parts=[],this.micro_segments=[],this.macro_segments=[],this.micro_part_index_to_segment_item_indices={},this.macro_part_index_to_segment_item_indices={},this.working_micro_segment=new Segment.Instance({segment_type:Segment.Type.MICRO,index:this.micro_segments.length}),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO,index:this.macro_segments.length})}Update_Micro(e){this.micro_parts.push(e),this.Update_Micro_Segments(e)}Update_Macro(e){if(this.macro_parts.push(e),e.Is_Command()){const t=e;t.Is_Open_Left_To_Right()?(this.Update_Macro_Segments(t),this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO_LEFT_TO_RIGHT,index:this.macro_segments.length})):t.Is_Open_Right_To_Left()?(this.Update_Macro_Segments(t),this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO_RIGHT_TO_LEFT,index:this.macro_segments.length})):t.Is_Close_Left_To_Right()||t.Is_Close_Right_To_Left()?(this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO,index:this.macro_segments.length}),this.Update_Macro_Segments(t)):this.Update_Macro_Segments(t)}else if(e.Is_Break()){const t=Split.From(e);for(const e of t)this.Update_Macro_Segments(e)}else this.Update_Macro_Segments(e)}Update_Micro_Segments(e){this.working_micro_segment.Try_Add_Item(e)||(this.micro_segments.push(this.working_micro_segment),this.working_micro_segment=new Segment.Instance({segment_type:Segment.Type.MICRO,index:this.micro_segments.length}),this.working_micro_segment.Add_Item(e));const t=e.Part_Index(),s={segment_index:this.working_micro_segment.Index(),item_index:this.working_micro_segment.Item_Count()-1};Object.freeze(s),null==this.micro_part_index_to_segment_item_indices[t]&&(this.micro_part_index_to_segment_item_indices[t]=[]),this.micro_part_index_to_segment_item_indices[t].push(s)}Update_Macro_Segments(e){this.working_macro_segment.Try_Add_Item(e)||(this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO,index:this.macro_segments.length}),this.working_macro_segment.Add_Item(e));const t=e.Part_Index(),s={segment_index:this.working_macro_segment.Index(),item_index:this.working_macro_segment.Item_Count()-1};Object.freeze(s),null==this.macro_part_index_to_segment_item_indices[t]&&(this.macro_part_index_to_segment_item_indices[t]=[]),this.macro_part_index_to_segment_item_indices[t].push(s)}Finalize(){this.working_micro_segment.Item_Count()>0&&(this.micro_segments.push(this.working_micro_segment),this.working_micro_segment=new Segment.Instance({segment_type:Segment.Type.MICRO,index:0})),Object.freeze(this.micro_parts),Object.freeze(this.micro_segments),Object.freeze(this.micro_part_index_to_segment_item_indices),Object.freeze(this.working_micro_segment),this.working_macro_segment.Item_Count()>0&&(this.macro_segments.push(this.working_macro_segment),this.working_macro_segment=new Segment.Instance({segment_type:Segment.Type.MACRO,index:0})),Object.freeze(this.macro_parts),Object.freeze(this.macro_segments),Object.freeze(this.macro_part_index_to_segment_item_indices),Object.freeze(this.working_macro_segment)}Type(){return this.type}Value(){return this.value}Is_Centered(){return this.is_centered}Is_Padded(){return this.padding_count>0}Padding_Count(){return this.padding_count}Has_Micro_Part(e){return 0,e<this.Micro_Part_Count()}Micro_Part_Count(){return this.micro_parts.length}Micro_Part(e){return 0,this.micro_parts[e]}Has_Macro_Part(e){return 0,e<this.Macro_Part_Count()}Macro_Part_Count(){return this.macro_parts.length}Macro_Part(e){return 0,this.macro_parts[e]}Micro_Segment_Count(){return this.micro_segments.length}Micro_Segment(e){return 0,0,this.micro_segments[e]}Micro_Part_Segment_Item_Indices(e){0;const t=this.micro_part_index_to_segment_item_indices[e];return Object.isFrozen(t)||Object.freeze(t),t}Macro_Segment_Count(){return this.macro_segments.length}Macro_Segment(e){return 0,0,this.macro_segments[e]}Macro_Part_Segment_Item_Indices(e){0;const t=this.macro_part_index_to_segment_item_indices[e];return Object.isFrozen(t)||Object.freeze(t),t}}