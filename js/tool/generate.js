var __awaiter=this&&this.__awaiter||function(t,e,o,n){return new(o||(o=Promise))((function(i,s){function r(t){try{l(n.next(t))}catch(t){s(t)}}function a(t){try{l(n.throw(t))}catch(t){s(t)}}function l(t){var e;t.done?i(t.value):(e=t.value,e instanceof o?e:new o((function(t){t(e)}))).then(r,a)}l((n=n.apply(t,e||[])).next())}))};import*as fs from"fs";import*as Utils from"../utils.js";import*as Unicode from"../unicode.js";import*as Language from"../model/language.js";import*as Data from"../model/data.js";import*as Text from"../model/text.js";const LINE_PATH_TYPE=Text.Line.Path_Type.DEFAULT;function Read_Directory(t){return __awaiter(this,void 0,void 0,(function*(){return new Promise((function(e,o){fs.readdir(t,{withFileTypes:!0},(function(t,n){null!=t?o(t):e(n)}))}))}))}function Has_File(t){return fs.existsSync(t)}function Read_File(t,e="utf8"){return __awaiter(this,void 0,void 0,(function*(){return new Promise((function(o,n){fs.readFile(t,e,(function(t,e){null!=t?n(t):o(e)}))}))}))}function Write_File(t,e,o="utf8"){return __awaiter(this,void 0,void 0,(function*(){return new Promise((function(n,i){fs.writeFile(t,e,o,(function(t){null!=t?i(t):n()}))}))}))}function Folder_Names(t){return __awaiter(this,void 0,void 0,(function*(){const e=[],o=yield Read_Directory(t);for(let t of o)t.isDirectory()&&e.push(t.name);return e}))}function File_Names(t){return __awaiter(this,void 0,void 0,(function*(){const e=[],o=yield Read_Directory(t);for(let t of o)t.isFile()&&e.push(t.name);return e}))}class Unique_Names{constructor(){this.books=new Set,this.languages=new Set,this.versions=new Set}Add_Book(t){this.books.add(t)}Add_Language(t){this.languages.add(t)}Add_Version(t){this.versions.add(t)}Books(){return Array.from(this.books).sort()}Languages(){return Array.from(this.languages).sort()}Versions(){return Array.from(this.versions).sort()}}class Unique_Parts{constructor(){this.parts={}}Add(t){this.parts.hasOwnProperty(t)?(Utils.Assert(this.parts[t]<Number.MAX_SAFE_INTEGER,"Cannot add more of this unique part!"),this.parts[t]+=1):this.parts[t]=1}Values(){return Object.keys(this.parts).sort(function(t,e){return this.parts[e]-this.parts[t]}.bind(this))}Count(t){return Utils.Assert(this.parts.hasOwnProperty(t),"Does not have part."),this.parts[t]}}function Filter_File_Names(t){return/\.txt$/.test(t)&&!/COPY\.txt$/.test(t)}function Sorted_File_Names(t){return __awaiter(this,void 0,void 0,(function*(){return Has_File(`${t}/Order.json`)?JSON.parse(yield Read_File(`${t}/Order.json`)):(yield File_Names(t)).filter(Filter_File_Names).sort()}))}function Assert_Greek_Normalization(t,e){Utils.Assert(Language.Greek.Normalize_With_Combined_Points(Language.Greek.Normalize_With_Baked_Points(e))===e,`\n            failed to reproduce original file_text after Greek normalization\n            ${t}\n        `)}function Generate(){return __awaiter(this,void 0,void 0,(function*(){const t={tree:{books:[]},unique_book_names:[],unique_language_names:[],unique_version_names:[],unique_part_values:{},total_unit_count:0,total_point_count:0,total_letter_count:0,total_marker_count:0,total_word_count:0,total_break_count:0,total_command_count:0,total_part_count:0,total_line_count:0,total_file_count:0,total_book_count:0},e=new Unique_Names,o={};function n(t,e){const o=e.Part_Type(),n=e.Value(),i=n.length,s=Unicode.Point_Count(n);if(Utils.Assert(t.total_unit_count+i<=Number.MAX_SAFE_INTEGER),t.total_unit_count+=i,Utils.Assert(t.total_point_count+s<=Number.MAX_SAFE_INTEGER),t.total_point_count+=s,o===Text.Part.Type.LETTER)Utils.Assert(t.total_letter_count+1<=Number.MAX_SAFE_INTEGER),t.total_letter_count+=1;else if(o===Text.Part.Type.MARKER)Utils.Assert(t.total_marker_count+1<=Number.MAX_SAFE_INTEGER),t.total_marker_count+=1;else if(o===Text.Part.Type.WORD)Utils.Assert(t.total_letter_count+s<=Number.MAX_SAFE_INTEGER),t.total_letter_count+=s,Utils.Assert(t.total_word_count+1<=Number.MAX_SAFE_INTEGER),t.total_word_count+=1;else if(o===Text.Part.Type.BREAK)Utils.Assert(t.total_marker_count+s<=Number.MAX_SAFE_INTEGER),t.total_marker_count+=s,Utils.Assert(t.total_break_count+1<=Number.MAX_SAFE_INTEGER),t.total_break_count+=1;else if(o===Text.Part.Type.COMMAND){Utils.Assert(t.total_letter_count+s<=Number.MAX_SAFE_INTEGER),t.total_letter_count+=s;e.Is_Last_Of_Split()||(Utils.Assert(t.total_command_count+1<=Number.MAX_SAFE_INTEGER),t.total_command_count+=1)}Utils.Assert(t.total_part_count+1<=Number.MAX_SAFE_INTEGER),t.total_part_count+=1}const i="./data",s=`${i}/Books`;for(const i of(yield Folder_Names(s)).sort()){const r=`${s}/${i}`,a={name:i,languages:[]};t.tree.books.push(a),e.Add_Book(i);for(const i of(yield Folder_Names(r)).sort()){const s=`${r}/${i}`,l={name:i,versions:[]};a.languages.push(l),e.Add_Language(i),null==o[i]&&(o[i]=new Unique_Parts);for(const r of(yield Folder_Names(s)).sort()){const a=`${s}/${r}`,_={name:r,files:[]},u=new Text.Dictionary.Instance({json:yield Read_File(`${a}/Dictionary.json`)}),c=yield Sorted_File_Names(a);l.versions.push(_),e.Add_Version(r),u.Validate(),t.total_book_count+=1,t.total_file_count+=c.length;for(const e of c){const s=`${a}/${e}`,r=Utils.Remove_File_Extension(e),l=new Text.Instance({dictionary:u,value:yield Read_File(s)});_.files.push(r),t.total_line_count+=l.Line_Count();for(let e=0,s=l.Line_Count();e<s;e+=1){const s=l.Line(e);for(let e=0,r=s.Macro_Part_Count(LINE_PATH_TYPE);e<r;e+=1){const r=s.Macro_Part(e,LINE_PATH_TYPE);o[i].Add(r.Value()),n(t,r)}}}}}}t.unique_book_names=e.Books(),t.unique_language_names=e.Languages(),t.unique_version_names=e.Versions();for(const e of Object.keys(o))t.unique_part_values[e]=o[e].Values();yield Write_File(`${i}/Info.json`,JSON.stringify(t));for(const e of(yield Folder_Names(s)).sort()){const o=`${s}/${e}`;for(const e of(yield Folder_Names(o)).sort()){const n=`${o}/${e}`,i=new Data.Compressor.Instance({unique_parts:t.unique_part_values[e]});for(const t of(yield Folder_Names(n)).sort()){const e=`${n}/${t}`,o=yield Sorted_File_Names(e),s=[],r=yield Read_File(`${e}/Dictionary.json`),a=new Text.Dictionary.Instance({json:r}),l=i.Compress_Dictionary(r),_=i.Decompress_Dictionary(l);Utils.Assert(_===r,"Invalid dictionary decompression!"),yield Write_File(`${e}/${Data.Version.Dictionary.Symbol.NAME}.${Data.Version.Dictionary.Symbol.EXTENSION}`,l);for(const t of o){const o=`${e}/${t}`,n=yield Read_File(o);s.push(n),Assert_Greek_Normalization(o,n);const r=i.Compress({value:n,dictionary:a}),l=i.Decompress({value:r,dictionary:a});Utils.Assert(l===n,"Invalid decompression!"),yield Write_File(`${e}/${t.replace(/\.[^.]*$/,`.${Data.Version.Dictionary.Symbol.EXTENSION}`)}`,r)}const u=s.join(Data.Version.Symbol.FILE_BREAK),c=i.Compress({value:u,dictionary:a}),d=i.Decompress({value:c,dictionary:a});Utils.Assert(d===u,"Invalid decompression!"),yield Write_File(`${e}/${Data.Version.Text.Symbol.NAME}.${Data.Version.Text.Symbol.EXTENSION}`,c)}}}yield function(t){return __awaiter(this,void 0,void 0,(function*(){let e=yield Read_File("./README.md");const o="## Stats";let n=null,i=null;for(let t=0,s=e.length;t<s;t+=1){const s=e.slice(t);null===n?s.slice(0,o.length)===o&&(n=t):null===i&&"##"===s.slice(0,"##".length)&&(i=t)}null!==n&&(null===i&&(i=e.length),e=e.slice(0,n)+"## Stats\n\n"+`Unique Languages: ${t.unique_language_names.length}\n\n`+`Unique Versions: ${t.unique_version_names.length}\n\n`+`Unique Books: ${t.unique_book_names.length}\n\n`+`Total Books: ${t.total_book_count}\n\n`+`Total Files: ${t.total_file_count}\n\n`+`Total Lines: ${t.total_line_count}\n\n`+`Total Parts (Words, Commands, Breaks): ${t.total_part_count}\n\n`+`Total Words: ${t.total_word_count}\n\n`+`Total Commands (Meta-Words): ${t.total_command_count}\n\n`+`Total Breaks (Non-Words): ${t.total_break_count}\n\n`+`Total Letters (Word-Points, Command-Points): ${t.total_letter_count}\n\n`+`Total Markers (Break-Points): ${t.total_marker_count}\n\n`+`Total Unicode Points: ${t.total_point_count}\n\n`+`Total UTF16 Codes: ${t.total_unit_count}\n\n`+e.slice(i,e.length)),yield Write_File("./README.md",e)}))}(t)}))}!function(){__awaiter(this,void 0,void 0,(function*(){yield Generate()}))}();