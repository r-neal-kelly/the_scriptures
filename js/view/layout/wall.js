var __awaiter=this&&this.__awaiter||function(e,t,i,n){return new(i||(i=Promise))((function(o,s){function r(e){try{d(n.next(e))}catch(e){s(e)}}function l(e){try{d(n.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,l)}d((n=n.apply(e,t||[])).next())}))};import*as Utils from"../../utils.js";import*as Event from"../../event.js";import*as Model from"../../model/layout/wall.js";import*as Events from"../events.js";import*as Entity from"../entity.js";import*as Window from"./window.js";export class Instance extends Entity.Instance{constructor({model:e,layout:t}){super({element:"div",parent:t,event_grid:t.Event_Grid()}),this.model=e,this.kill_index=null,this.Live()}On_Life(){return[new Event.Listener_Info({event_name:new Event.Name(Event.Prefix.AFTER,Events.WINDOW_TOGGLE_MAXIMIZATION,this.ID()),event_handler:this.After_Window_Toggle_Maximization,event_priority:0}),new Event.Listener_Info({event_name:new Event.Name(Event.Prefix.AFTER,Events.WINDOW_CLOSE,this.Layout().ID()),event_handler:this.After_Window_Close,event_priority:10})]}On_Refresh(){if(null==this.kill_index){const e=this.Model().Window_Count(),t=this.Child_Count(),i=e-t;if(i<0)for(let e=t,n=t+i;e>n;)e-=1,this.Abort_Child(this.Child(e));else if(i>0)for(let e=t,n=t+i;e<n;e+=1)new Window.Instance({model:()=>this.Model().Window_At(e),wall:this})}else{this.Abort_Child(this.Child(this.kill_index)),this.Skip_Children();for(let e=this.kill_index,t=this.Child_Count();e<t;e+=1){this.Child(e).__Set_Model__((()=>this.Model().Window_At(e)))}}}On_Reclass(){return["Wall"]}On_Restyle(){const e=this.Model(),t=e.Render_Type(),i=e.Render_Limit(),n=e.Window_Count(),o=e.Maximized_Window_Count(),s="grid-template-columns",r="grid-template-rows",l=t===Model.Render_Type.LANDSCAPE?s:r,d=l===s?r:s;return`\n            ${l}: repeat(${i}, calc(${100/i}% - ${Math.round(2*(i-1)/i)}px));\n            ${d}: repeat(${Math.ceil(n/i)+o}, 100%);\n            grid-column-gap: 2px;\n            grid-row-gap: 2px;\n        `}After_Window_Toggle_Maximization(){return __awaiter(this,void 0,void 0,(function*(){this.Reclass()}))}After_Window_Close({window_index:e}){return __awaiter(this,void 0,void 0,(function*(){this.kill_index=e,this.Refresh(),this.kill_index=null,0===e||e%this.Model().Render_Limit()==0?this.Move_Window_Into_View(e):this.Move_Window_Into_View(e-1)}))}Model(){return this.model()}Layout(){return this.Parent()}Window(e){return 0,this.Child(e)}Move_Window_Into_View(e){0;const t=this.Model();for(e=Math.min(e+1,t.Window_Count());e>0;)if(e-=1,t.Window_At(e).Is_Visible())return void this.Window(e).Move_Into_View();t.Render_Type()===Model.Render_Type.LANDSCAPE?this.Element().scrollTop=0:this.Element().scrollLeft=0}}