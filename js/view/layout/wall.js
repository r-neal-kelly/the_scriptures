var __awaiter=this&&this.__awaiter||function(e,t,n,i){return new(n||(n=Promise))((function(o,s){function r(e){try{d(i.next(e))}catch(e){s(e)}}function _(e){try{d(i.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?o(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,_)}d((i=i.apply(e,t||[])).next())}))};import*as Utils from"../../utils.js";import*as Event from"../../event.js";import*as Model from"../../model/layout/wall.js";import*as Model_Window from"../../model/layout/window.js";import*as Browser_Model from"../../model/browser.js";import*as Browser_View from"./../browser.js";import*as Finder_Model from"../../model/finder.js";import*as Finder_View from"./../finder.js";import*as Events from"../events.js";import*as Entity from"../entity.js";import*as Window from"./window.js";export class Instance extends Entity.Instance{constructor({model:e,desktop:t}){super({element:"div",parent:t,event_grid:t.Event_Grid()}),this.model=e,this.kill_index=null,this.Live()}On_Life(){return[new Event.Listener_Info({event_name:new Event.Name(Event.Prefix.AFTER,Events.WINDOW_TOGGLE_MAXIMIZATION,this.ID()),event_handler:this.After_Window_Toggle_Maximization,event_priority:0}),new Event.Listener_Info({event_name:new Event.Name(Event.Prefix.AFTER,Events.WINDOW_CLOSE,this.Desktop().Layout().ID()),event_handler:this.After_Window_Close,event_priority:10}),new Event.Listener_Info({event_name:new Event.Name(Event.Prefix.ON,Events.OPEN_BROWSER,this.Desktop().Layout().ID()),event_handler:this.On_Open_Browser,event_priority:0}),new Event.Listener_Info({event_name:new Event.Name(Event.Prefix.AFTER,Events.OPEN_BROWSER,this.Desktop().Layout().ID()),event_handler:this.After_Open_Browser,event_priority:0}),new Event.Listener_Info({event_name:new Event.Name(Event.Prefix.ON,Events.OPEN_FINDER,this.Desktop().Layout().ID()),event_handler:this.On_Open_Finder,event_priority:0}),new Event.Listener_Info({event_name:new Event.Name(Event.Prefix.AFTER,Events.OPEN_FINDER,this.Desktop().Layout().ID()),event_handler:this.After_Open_Finder,event_priority:0})]}On_Refresh(){if(null==this.kill_index){const e=this.Model().Window_Count(),t=this.Child_Count(),n=e-t;if(n<0)for(let e=t,i=t+n;e>i;)e-=1,this.Abort_Child(this.Child(e));else if(n>0)for(let e=t,i=t+n;e<i;e+=1)new Window.Instance({model:()=>this.Model().Window_At(e),wall:this})}else{this.Abort_Child(this.Child(this.kill_index)),this.Skip_Children();for(let e=this.kill_index,t=this.Child_Count();e<t;e+=1){this.Child(e).__Set_Model__((()=>this.Model().Window_At(e)))}}}On_Reclass(){return["Wall"]}On_Restyle(){const e=this.Model(),t=e.Render_Type(),n=e.Render_Limit(),i=e.Window_Count(),o=e.Maximized_Window_Count(),s="grid-template-columns",r="grid-template-rows",_=t===Model.Render_Type.LANDSCAPE?s:r,d=_===s?r:s;return`\n            grid-auto-flow: ${t===Model.Render_Type.LANDSCAPE?"row":"column"};\n            ${_}: repeat(${n}, ${100/n}%);\n            ${d}: repeat(${Math.ceil(i/n)+o}, 100%);\n        `}On_Resize(e){const t=this.Model();t.Render_Type()===Model.Render_Type.LANDSCAPE?Utils.Is_Portrait()&&(t.Set_Render_Type(Model.Render_Type.PORTRAIT),this.Restyle()):Utils.Is_Landscape()&&(t.Set_Render_Type(Model.Render_Type.LANDSCAPE),this.Restyle()),t.Has_Active_Window()?this.Move_Window_Into_View(t.Active_Window().Index()):t.Window_Count()>0&&this.Move_Window_Into_View(0)}After_Window_Toggle_Maximization(){return __awaiter(this,void 0,void 0,(function*(){this.Reclass()}))}After_Window_Close(e){return __awaiter(this,arguments,void 0,(function*({window_index:e}){this.kill_index=e,this.Refresh(),this.kill_index=null,0===e||e%this.Model().Render_Limit()==0?this.Move_Window_Into_View(e):this.Move_Window_Into_View(e-1)}))}On_Open_Browser(){return __awaiter(this,void 0,void 0,(function*(){this.Model().Add_Program(new Model_Window.Program.Instance({model_class:Browser_Model.Instance,model_data:{},view_class:Browser_View.Instance,is_window_active:!0}))}))}After_Open_Browser(){return __awaiter(this,void 0,void 0,(function*(){this.Desktop().Layout().Refresh(),this.Move_Window_Into_View(this.Model().Window_Count()-1)}))}On_Open_Finder(){return __awaiter(this,void 0,void 0,(function*(){this.Model().Add_Program(new Model_Window.Program.Instance({model_class:Finder_Model.Instance,model_data:void 0,view_class:Finder_View.Instance,is_window_active:!0}))}))}After_Open_Finder(){return __awaiter(this,void 0,void 0,(function*(){this.Desktop().Layout().Refresh(),this.Move_Window_Into_View(this.Model().Window_Count()-1)}))}Model(){return this.model()}Desktop(){return this.Parent()}Window(e){return 0,this.Child(e)}Move_Window_Into_View(e){0;const t=this.Model();for(e=Math.min(e+1,t.Window_Count());e>0;)if(e-=1,t.Window_At(e).Is_Visible())return void this.Window(e).Move_Into_View();t.Render_Type()===Model.Render_Type.LANDSCAPE?this.Element().scrollTop=0:this.Element().scrollLeft=0}}