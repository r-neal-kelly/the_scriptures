var Life_Cycle_State,Life_Cycle_Listener,Life_Cycle_Skip,__awaiter=this&&this.__awaiter||function(e,t,i,s){return new(i||(i=Promise))((function(n,l){function _(e){try{c(s.next(e))}catch(e){l(e)}}function r(e){try{c(s.throw(e))}catch(e){l(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(_,r)}c((s=s.apply(e,t||[])).next())}))};import*as Utils from"../utils.js";import*as Unique_ID from"../unique_id.js";export class Animation_Frame{constructor({now:e,start:t,elapsed:i}){this.now=e,this.start=t,this.elapsed=i,Object.freeze(this)}Now(){return this.now}Start(){return this.start}Elapsed(){return this.elapsed}}!function(e){e[e.UNBORN=0]="UNBORN",e[e.ALIVE=1]="ALIVE",e[e.DEAD=2]="DEAD"}(Life_Cycle_State||(Life_Cycle_State={})),function(e){e[e._NONE_=0]="_NONE_",e[e.ON_LIFE=1]="ON_LIFE",e[e.ON_REFRESH=2]="ON_REFRESH",e[e.ON_RECLASS=3]="ON_RECLASS",e[e.ON_RESTYLE=4]="ON_RESTYLE",e[e.ON_RESIZE=5]="ON_RESIZE",e[e.BEFORE_DEATH=6]="BEFORE_DEATH"}(Life_Cycle_Listener||(Life_Cycle_Listener={})),function(e){e[e._NONE_=0]="_NONE_",e[e.CHILDREN=1]="CHILDREN",e[e.REMAINING_SIBLINGS=2]="REMAINING_SIBLINGS"}(Life_Cycle_Skip||(Life_Cycle_Skip={}));class Resizable_Entity{constructor(e){const t=e.Element().getBoundingClientRect();this.entity=e,this.current_width=t.width,this.current_height=t.height,this.resize_observer=new ResizeObserver(this.On_Resize.bind(this)),this.resize_observer.observe(e.Element())}Destroy(){this.resize_observer.disconnect()}On_Resize(){if(this.entity.Is_Alive()){const e=this.entity.Element();if(null!=e.parentElement){const t=e.getBoundingClientRect();this.current_width===t.width&&this.current_height===t.height||(this.current_width=t.width,this.current_height=t.height,this.entity.Resize(e.parentElement.getBoundingClientRect()))}}}}class Resizable_Entities{constructor(){this.cache=Object.create(null)}Has(e){return null!=this.cache[e.ID()]}Add(e){0,this.cache[e.ID()]=new Resizable_Entity(e)}Remove(e){0,this.cache[e.ID()].Destroy(),delete this.cache[e.ID()]}}export class Instance{constructor({element:e,parent:t,event_grid:i}){this.id=Unique_ID.New(),this.element=e instanceof HTMLElement?e:document.createElement(e),this.event_grid=i,this.css=null,this.css_to_add=null,this.parent=t,this.children=new Map,this.life_cycle_state=Life_Cycle_State.UNBORN,this.life_cycle_listener=Life_Cycle_Listener._NONE_,this.life_cycle_skip=Life_Cycle_Skip._NONE_}Live(){if(this.Is_Unborn())if(this.life_cycle_state=Life_Cycle_State.ALIVE,this.element.setAttribute("id",this.HTML_ID()),null!=this.parent){const e=this.parent;this.parent=null,e.Adopt_Child(this),this.Life_This()}else this.Life_This(),this.Refresh()}Life_This(){this.Is_Alive()&&Object.getPrototypeOf(this).On_Life!==Instance.prototype.On_Life&&(this.life_cycle_listener=Life_Cycle_Listener.ON_LIFE,this.css_to_add="",this.Event_Grid().Add_Many_Listeners(this,this.On_Life()),""!==this.css_to_add&&(this.css=Utils.Create_Style_Element(this.css_to_add)),this.css_to_add=null,this.life_cycle_listener=Life_Cycle_Listener._NONE_)}Refresh(){if(this.Is_Alive()){if(this.life_cycle_skip&=~Life_Cycle_Skip.CHILDREN,this.Refresh_This(),this.Reclass_This(),this.Restyle_This(),this.life_cycle_skip&Life_Cycle_Skip.CHILDREN)return;for(const e of this.children.values())if(e.life_cycle_skip&=~Life_Cycle_Skip.REMAINING_SIBLINGS,e.Refresh(),e.life_cycle_skip&Life_Cycle_Skip.REMAINING_SIBLINGS)return}}Refresh_This(){this.Is_Alive()&&Object.getPrototypeOf(this).On_Refresh!==Instance.prototype.On_Refresh&&(this.life_cycle_listener=Life_Cycle_Listener.ON_REFRESH,this.On_Refresh(),this.life_cycle_listener=Life_Cycle_Listener._NONE_)}Reclass(){if(this.Is_Alive()){if(this.life_cycle_skip&=~Life_Cycle_Skip.CHILDREN,this.Reclass_This(),this.Restyle_This(),this.life_cycle_skip&Life_Cycle_Skip.CHILDREN)return;for(const e of this.children.values())if(e.life_cycle_skip&=~Life_Cycle_Skip.REMAINING_SIBLINGS,e.Reclass(),e.life_cycle_skip&Life_Cycle_Skip.REMAINING_SIBLINGS)return}}Reclass_This(){if(this.Is_Alive()&&Object.getPrototypeOf(this).On_Reclass!==Instance.prototype.On_Reclass){this.life_cycle_listener=Life_Cycle_Listener.ON_RECLASS;const e=this.On_Reclass().join(" ");this.life_cycle_listener=Life_Cycle_Listener._NONE_;const t=this.Element(),i=t.getAttribute("class");null!=i&&i===e||t.setAttribute("class",e)}}Restyle(){if(this.Is_Alive()){if(this.life_cycle_skip&=~Life_Cycle_Skip.CHILDREN,this.Restyle_This(),this.life_cycle_skip&Life_Cycle_Skip.CHILDREN)return;for(const e of this.children.values())if(e.life_cycle_skip&=~Life_Cycle_Skip.REMAINING_SIBLINGS,e.Restyle(),e.life_cycle_skip&Life_Cycle_Skip.REMAINING_SIBLINGS)return}}Restyle_This(){if(this.Is_Alive()&&Object.getPrototypeOf(this).On_Restyle!==Instance.prototype.On_Restyle){this.life_cycle_listener=Life_Cycle_Listener.ON_RESTYLE;const e=this.On_Restyle();if(this.life_cycle_listener=Life_Cycle_Listener._NONE_,e instanceof Object){const t=this.Element();for(const i of Object.entries(e))t.style[i[0]]=i[1]}else this.Element().setAttribute("style",e)}}Resize(e){if(this.Is_Alive()){if(this.life_cycle_skip&=~Life_Cycle_Skip.CHILDREN,this.Resize_This(e),this.life_cycle_skip&Life_Cycle_Skip.CHILDREN)return;e=this.Element().getBoundingClientRect();for(const t of this.children.values())if(t.life_cycle_skip&=~Life_Cycle_Skip.REMAINING_SIBLINGS,t.Resize(e),t.life_cycle_skip&Life_Cycle_Skip.REMAINING_SIBLINGS)return}}Resize_This(e){this.Is_Alive()&&Object.getPrototypeOf(this).On_Resize!==Instance.prototype.On_Resize&&(this.life_cycle_listener=Life_Cycle_Listener.ON_RESIZE,this.On_Resize(e),this.life_cycle_listener=Life_Cycle_Listener._NONE_)}Die(){if(this.Is_Alive()){Object.getPrototypeOf(this).Before_Death!==Instance.prototype.Before_Death&&(this.life_cycle_listener=Life_Cycle_Listener.BEFORE_DEATH,this.Before_Death(),this.life_cycle_listener=Life_Cycle_Listener._NONE_);for(const e of this.children.values())e.Die();if(this.Has_Parent()){const e=this.Parent(),t=e.Element(),i=this.Element();i.parentElement===t&&t.removeChild(i),this.parent=null,e.children.delete(i)}Instance.resizable_entities.Has(this)&&Instance.resizable_entities.Remove(this),null!=this.css&&Utils.Destroy_Style_Element(this.css),this.Event_Grid().Remove(this),this.element=document.body,this.life_cycle_state=Life_Cycle_State.DEAD}}On_Life(){return 0,[]}On_Refresh(){0}On_Reclass(){return 0,[]}On_Restyle(){return 0,""}On_Resize(e){0}Before_Death(){0}Is_Unborn(){return this.life_cycle_state===Life_Cycle_State.UNBORN}Is_Alive(){return this.life_cycle_state===Life_Cycle_State.ALIVE}Is_Dead(){return this.life_cycle_state===Life_Cycle_State.DEAD}ID(){return 0,this.id}HTML_ID(){return 0,`Entity_${Instance.class_id}_${this.ID()}`}Add_CSS(e){0,0;const t=this.HTML_ID();this.css_to_add+=`\n            /* CSS for ${t} and its Children: */\n        `,this.css_to_add+=e.replace(/(}\s*|^\s*)([^@{]+)({)/g,(function(e,i,s,n){let l="";const _=s.trim().split(/\s*,\s*/g);for(let e=0,i=_.length;e<i;e+=1){const s=_[e];l+=`${s.replace(/^([^\s>~+|]*)/,`$1#${t}`)}, `,l+=e!==i-1?`#${t} ${s}, `:`#${t} ${s} `}return`${i}${l}${n}`}))}Add_This_CSS(e){0,0;const t=this.HTML_ID();this.css_to_add+=`\n            /* CSS for ${t}: */\n        `,this.css_to_add+=e.replace(/(}\s*|^\s*)([^@{]+)({)/g,(function(e,i,s,n){let l="";const _=s.trim().split(/\s*,\s*/g);for(let e=0,i=_.length;e<i;e+=1){const s=_[e];l+=e!==i-1?`${s.replace(/^([^\s>~+|]*)/,`$1#${t}`)}, `:`${s.replace(/^([^\s>~+|]*)/,`$1#${t}`)} `}return`${i}${l}${n}`}))}Add_Children_CSS(e){0,0;const t=this.HTML_ID();this.css_to_add+=`\n            /* CSS for ${t}'s Children: */\n        `,this.css_to_add+=e.replace(/(}\s*|^\s*)([^@{]+)({)/g,(function(e,i,s,n){let l="";const _=s.trim().split(/\s*,\s*/g);for(let e=0,i=_.length;e<i;e+=1){const s=_[e];l+=e!==i-1?`#${t} ${s}, `:`#${t} ${s} `}return`${i}${l}${n}`}))}Automatically_Resize(){0,0,0,Instance.resizable_entities.Add(this)}Element(){return 0,this.element}Replace_Element(e){0;const t=e instanceof HTMLElement?e:document.createElement(e);this.Element().replaceWith(t),this.element=t}Has_Parent(){return 0,null!=this.parent}Parent(){return 0,0,this.parent}Maybe_Parent(){return 0,this.parent}Child_Count(){return 0,this.children.size}Has_Child(e){return 0,0,e<this.Child_Count()}Child(e){return 0,0,0,this.children.get(this.Element().children[e])}Maybe_Child(e){return this.Has_Child(e)?this.Child(e):null}Children(){return 0,Array.from(this.Element().children).map(function(e){return this.children.get(e)}.bind(this))}Adopt_Child(e){0,0,0,0,0,this.children.set(e.Element(),e),e.parent=this,this.Element().appendChild(e.Element())}Abort_Child(e){0,0,0,0,e.Die()}Abort_All_Children(){for(const e of Array.from(this.children.values()))this.Abort_Child(e)}Skip_Children(){0,this.life_cycle_skip|=Life_Cycle_Skip.CHILDREN}Skip_Remaining_Siblings(){0,this.life_cycle_skip|=Life_Cycle_Skip.REMAINING_SIBLINGS}Event_Grid(){return 0,this.event_grid}Add_Listeners(e){this.Event_Grid().Add_Many_Listeners(this,e)}Remove_Listeners(){this.Event_Grid().Remove_All_Listeners(this)}Set_Listeners(e){this.Remove_Listeners(),this.Add_Listeners(e)}Send(e){return __awaiter(this,void 0,void 0,(function*(){return this.Event_Grid().Send(e)}))}Animate(e,t){return __awaiter(this,void 0,void 0,(function*(){0,0,0,0,0,void 0===t.direction&&(t.direction="normal"),void 0===t.fill&&(t.fill="none");const i="both"===t.fill;if(t.fill="none",this.Is_Alive()){const s=this.Element();let n,l;if("normal"===t.direction?(n=e[0],l=e[e.length-1]):(n=e[e.length-1],l=e[0]),i)for(const[e,t]of Object.entries(n))"offset"!==e&&null!=t&&(s.style[e]=t.toString());if(yield new Promise((function(i){const n=new Animation(new KeyframeEffect(s,e,t));n.onfinish=function(e){i()},n.play()})),i)for(const[e,t]of Object.entries(l))"offset"!==e&&null!=t&&(s.style[e]=t.toString())}}))}Animate_By_Frame(e,t){return __awaiter(this,void 0,void 0,(function*(){return new Promise(function(i){let s=null,n=-1;window.requestAnimationFrame(function l(_){return __awaiter(this,void 0,void 0,(function*(){this.Is_Alive()?(null==s&&(s=_),n!==_?(n=_,(yield e(new Animation_Frame({now:_,start:s,elapsed:_-s}),t))?window.requestAnimationFrame(l.bind(this)):i()):window.requestAnimationFrame(l.bind(this))):i()}))}.bind(this))}.bind(this))}))}}Instance.class_id=`${(new Date).getTime()}${Math.random().toString().replace(/\./g,"")}`,Instance.resizable_entities=new Resizable_Entities;