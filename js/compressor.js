import*as Utils from"./utils.js";import*as Unicode from"./unicode.js";export const LZSS_FIRST_BAD_INDEX=Unicode.LEADING_SURROGATE.FIRST;export const LZSS_LAST_BAD_INDEX=Unicode.TRAILING_SURROGATE.LAST;export const LZSS_MAX_LENGTH=1114112;export class LZSS_Control_Tokens{constructor({GOOD:t=0,BAD_A:e=1,BAD_B:n=2,BAD_AB:o=3}={}){0,0,0,0,0,0,0,0,this.good=String.fromCodePoint(t),this.bad_a=String.fromCodePoint(e),this.bad_b=String.fromCodePoint(n),this.bad_ab=String.fromCodePoint(o);const s=this.GOOD()+this.BAD_A()+this.BAD_B()+this.BAD_AB();this.has_token_regex=new RegExp(`[${s}]`),Object.freeze(this)}GOOD(){return this.good}BAD_A(){return this.bad_a}BAD_B(){return this.bad_b}BAD_AB(){return this.bad_ab}Has_Token(t){return this.has_token_regex.test(t)}}export function LZSS_Compress(t,e=1024,n=!0,o=new LZSS_Control_Tokens){0,0,0;const s=new class{constructor({text:t,max_memory_length:e}){this.text=t,this.text_index=0,this.memory="",this.max_memory_length=e}Initial_Matches(t){0;const e=[];let n=new Unicode.Iterator({text:this.memory});for(;!n.Is_At_End();n=n.Next())if(n.Point()===t){const o=n.Index();e.push([o,o+t.length])}return e}Matches(t,e,n){0;for(const[o,s]of t){const t=s-o,i=t+Unicode.First_Point(this.memory.slice(s)).length,r=o+i;i>t&&n.length>=i&&n.slice(0,i)===this.memory.slice(o,r)&&e.push([o,r])}}Move_Memory(t){for(;this.memory.length+t>this.max_memory_length;){const t=Unicode.First_Point(this.memory);this.text_index+=t.length,this.memory=this.memory.slice(t.length)}this.memory=this.text.slice(this.text_index,this.text_index+this.memory.length+t)}Create_Token(t,e){const n=t>=LZSS_FIRST_BAD_INDEX&&t<=LZSS_LAST_BAD_INDEX,s=e>=LZSS_FIRST_BAD_INDEX&&e<=LZSS_LAST_BAD_INDEX;return n&&s?o.BAD_AB()+String.fromCodePoint(t-LZSS_FIRST_BAD_INDEX)+String.fromCodePoint(e-LZSS_FIRST_BAD_INDEX):n?o.BAD_A()+String.fromCodePoint(t-LZSS_FIRST_BAD_INDEX)+String.fromCodePoint(e):s?o.BAD_B()+String.fromCodePoint(t)+String.fromCodePoint(e-LZSS_FIRST_BAD_INDEX):o.GOOD()+String.fromCodePoint(t)+String.fromCodePoint(e)}Can_Use_Token(t,e){return n?Unicode.Expected_UTF_8_Unit_Count(t)<Unicode.Expected_UTF_8_Unit_Count(e):t.length<e.length}Token(t){0;const e=t.Point(),n=this.Initial_Matches(e);if(n.length>0){const o=t.Points();let s=[],i=n,r=s;for(;i.length>0;)r=s,s=i,i=r,i.splice(0,i.length),this.Matches(s,i,o);const _=s[s.length-1],S=_[1]-_[0],c=this.text_index+_[0],A=this.text_index+_[1],h=this.Create_Token(c,A);return this.Can_Use_Token(h,o.slice(0,S))?(this.Move_Memory(S),[h,new Unicode.Iterator({text:t.Text(),index:t.Index()+S})]):(this.Move_Memory(e.length),[e,new Unicode.Iterator({text:t.Text(),index:t.Index()+e.length})])}return this.Move_Memory(e.length),[e,new Unicode.Iterator({text:t.Text(),index:t.Index()+e.length})]}}({text:t,max_memory_length:e});let i="",r=new Unicode.Iterator({text:t});for(;!r.Is_At_End();){const[t,e]=s.Token(r);i+=t,r=e}return i}export function LZSS_Decompress(t,e=new LZSS_Control_Tokens){let n="",o=new Unicode.Iterator({text:t});for(;!o.Is_At_End();)if(o.Point()===e.GOOD()){o=o.Next();const t=o.Point().codePointAt(0);o=o.Next();const e=o.Point().codePointAt(0);n+=n.slice(t,e),o=o.Next()}else if(o.Point()===e.BAD_A()){o=o.Next();const t=o.Point().codePointAt(0)+LZSS_FIRST_BAD_INDEX;o=o.Next();const e=o.Point().codePointAt(0);n+=n.slice(t,e),o=o.Next()}else if(o.Point()===e.BAD_B()){o=o.Next();const t=o.Point().codePointAt(0);o=o.Next();const e=o.Point().codePointAt(0)+LZSS_FIRST_BAD_INDEX;n+=n.slice(t,e),o=o.Next()}else if(o.Point()===e.BAD_AB()){o=o.Next();const t=o.Point().codePointAt(0)+LZSS_FIRST_BAD_INDEX;o=o.Next();const e=o.Point().codePointAt(0)+LZSS_FIRST_BAD_INDEX;n+=n.slice(t,e),o=o.Next()}else n+=o.Point(),o=o.Next();return n}export function JSON_String_Array_Compress(t){return 0,t.replace(/","/g,"\0")}export function JSON_String_Array_Decompress(t){return t.replace(/\x00/g,'","')}