var __awaiter=this&&this.__awaiter||function(t,e,n,s){return new(n||(n=Promise))((function(i,o){function r(t){try{d(s.next(t))}catch(t){o(t)}}function a(t){try{d(s.throw(t))}catch(t){o(t)}}function d(t){var e;t.done?i(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(r,a)}d((s=s.apply(t,e||[])).next())}))};import*as Utils from"../utils.js";import*as Held_Keys from"./held_keys.js";export class Instance{constructor(){this.divs_to_hooks=new Map,this.held_keys=new Held_Keys.Instance}Has_Div(t){return this.divs_to_hooks.has(t)}Add_Div(t,e){0,0,t.addEventListener("keydown",this.On_Keydown.bind(this)),t.addEventListener("keyup",this.On_Keyup.bind(this)),t.addEventListener("beforeinput",this.Before_Input.bind(this)),this.divs_to_hooks.set(t,e)}Remove_Div(t){0,t.removeEventListener("keydown",this.On_Keydown.bind(this)),t.removeEventListener("keyup",this.On_Keyup.bind(this)),t.removeEventListener("beforeinput",this.Before_Input.bind(this)),this.divs_to_hooks.delete(t)}On_Keydown(t){return __awaiter(this,void 0,void 0,(function*(){t.stopPropagation(),t.repeat||this.held_keys.Add(t.code)}))}On_Keyup(t){return __awaiter(this,void 0,void 0,(function*(){t.stopPropagation(),this.held_keys.Remove(t.code)}))}Before_Input(t){return __awaiter(this,void 0,void 0,(function*(){const e=t.target,n=this.divs_to_hooks.get(e);if(0,0,0,t.stopPropagation(),"insertText"===t.inputType){t.data;const s=t.getTargetRanges();0,t.preventDefault(),yield n.On_Insert({div:e,data:t.data||"",target_range:s[0]}),yield n.After_Insert_Or_Paste_Or_Delete(t)}else"insertFromPaste"===t.inputType?(yield n.On_Paste(t),yield n.After_Insert_Or_Paste_Or_Delete(t)):"deleteContentBackward"===t.inputType&&(yield n.On_Delete(t),yield n.After_Insert_Or_Paste_Or_Delete(t))}))}}let singleton=null;export function Singleton(){return null==singleton&&(singleton=new Instance),singleton}