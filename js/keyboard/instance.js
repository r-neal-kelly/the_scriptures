var __awaiter=this&&this.__awaiter||function(e,t,s,n){return new(s||(s=Promise))((function(i,o){function r(e){try{_(n.next(e))}catch(e){o(e)}}function a(e){try{_(n.throw(e))}catch(e){o(e)}}function _(e){var t;e.done?i(e.value):(t=e.value,t instanceof s?t:new s((function(e){e(t)}))).then(r,a)}_((n=n.apply(e,t||[])).next())}))};import*as Utils from"../utils.js";import{Key}from"./key.js";import*as Held_Keys from"./held_keys.js";import*as Layout from"./layout.js";export class Instance{constructor(){const e=new Layout.Latin.Instance;this.divs_to_hooks=new Map,this.held_keys=new Held_Keys.Instance,this.layouts=Object.create(null),this.current_layout=e,this.has_spaced=!1,this.layouts[e.Name()]=e}Has_Div(e){return this.divs_to_hooks.has(e)}Add_Div(e,t){0,0,e.addEventListener("keydown",this.On_Keydown.bind(this)),e.addEventListener("keyup",this.On_Keyup.bind(this)),e.addEventListener("beforeinput",this.Before_Input.bind(this)),this.divs_to_hooks.set(e,t)}Remove_Div(e){0,e.removeEventListener("keydown",this.On_Keydown.bind(this)),e.removeEventListener("keyup",this.On_Keyup.bind(this)),e.removeEventListener("beforeinput",this.Before_Input.bind(this)),this.divs_to_hooks.delete(e)}Held_Keys(){return this.held_keys}Layout(e){return 0,this.layouts[e]}Current_Layout(){return this.current_layout}Has_Spaced(){return this.has_spaced}Send_Input_To_Selection(e,t,s){return __awaiter(this,void 0,void 0,(function*(){const n=document.getSelection();0,0;const i=n.getRangeAt(0);yield t.On_Insert({div:e,data:s.replace(/ /g," "),range:i}),yield t.After_Insert_Or_Paste_Or_Delete()}))}On_Keydown(e){return __awaiter(this,void 0,void 0,(function*(){e.stopPropagation();const t=e.target,s=this.divs_to_hooks.get(t);if(!e.repeat){const t=e.code;t!=Key.SHIFT_LEFT&&t!=Key.SHIFT_RIGHT&&t!=Key.CONTROL_LEFT&&t!=Key.CONTROL_RIGHT&&t!=Key.ALT_LEFT&&t!=Key.ALT_RIGHT&&this.held_keys.Add(e.code)}if(yield s.On_Key_Down(e),e.repeat)if(this.has_spaced)e.preventDefault();else{const n=this.Current_Layout().Maybe_Output(this.held_keys,e.shiftKey,e.getModifierState(Key.CAPS_LOCK));Utils.Is.String(n)?(e.preventDefault(),yield this.Send_Input_To_Selection(t,s,n)):n&&e.preventDefault()}else if(this.has_spaced)e.preventDefault();else{const n=this.Current_Layout().Maybe_Space(this.held_keys);if(n instanceof Layout.Space.Instance)e.preventDefault(),this.has_spaced=!0;else if(n)e.preventDefault();else{const n=this.Current_Layout().Maybe_Output(this.held_keys,e.shiftKey,e.getModifierState(Key.CAPS_LOCK));Utils.Is.String(n)?(e.preventDefault(),yield this.Send_Input_To_Selection(t,s,n)):n&&e.preventDefault()}}}))}On_Keyup(e){return __awaiter(this,void 0,void 0,(function*(){e.stopPropagation();const t=e.target,s=this.divs_to_hooks.get(t);yield s.On_Key_Up(e),this.held_keys.Remove(e.code),0===this.held_keys.Count()&&(this.has_spaced=!1)}))}Before_Input(e){return __awaiter(this,void 0,void 0,(function*(){e.stopPropagation();const t=e.target,s=this.divs_to_hooks.get(t);if(0,0,0,"insertText"===e.inputType){e.preventDefault();const n=(e.data||"").replace(/ /g," "),i=e.getTargetRanges();0;const o=document.createRange();o.setStart(i[0].startContainer,i[0].startOffset),o.setEnd(i[0].endContainer,i[0].endOffset),yield s.On_Insert({div:t,data:n,range:o}),yield s.After_Insert_Or_Paste_Or_Delete()}else"insertFromPaste"===e.inputType?(yield s.On_Paste(e),yield s.After_Insert_Or_Paste_Or_Delete()):"deleteContentBackward"===e.inputType&&(yield s.On_Delete(e),yield s.After_Insert_Or_Paste_Or_Delete())}))}}let singleton=null;export function Singleton(){return null==singleton&&(singleton=new Instance),singleton}