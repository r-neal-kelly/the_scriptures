var __awaiter=this&&this.__awaiter||function(e,t,n,s){return new(n||(n=Promise))((function(i,o){function r(e){try{l(s.next(e))}catch(e){o(e)}}function a(e){try{l(s.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,a)}l((s=s.apply(e,t||[])).next())}))};import*as Utils from"../utils.js";import{Key}from"./key.js";import*as Held_Keys from"./held_keys.js";import*as Layout from"./layout.js";export class Instance{constructor(){const e=new Layout.Latin.Instance;this.divs_to_hooks=new Map,this.held_keys=new Held_Keys.Instance,this.layouts=Object.create(null),this.current_layout=e,this.layouts[e.Name()]=e}Has_Div(e){return this.divs_to_hooks.has(e)}Add_Div(e,t){0,0,e.addEventListener("keydown",this.On_Keydown.bind(this)),e.addEventListener("keyup",this.On_Keyup.bind(this)),e.addEventListener("beforeinput",this.Before_Input.bind(this)),this.divs_to_hooks.set(e,t)}Remove_Div(e){0,e.removeEventListener("keydown",this.On_Keydown.bind(this)),e.removeEventListener("keyup",this.On_Keyup.bind(this)),e.removeEventListener("beforeinput",this.Before_Input.bind(this)),this.divs_to_hooks.delete(e)}Held_Keys(){return this.held_keys}Layout(e){return 0,this.layouts[e]}Current_Layout(){return this.current_layout}Send_Input_To_Selection(e,t,n){return __awaiter(this,void 0,void 0,(function*(){const s=document.getSelection();0,0;const i=s.getRangeAt(0);yield t.On_Insert({div:e,data:n.replace(/ /g," "),range:i}),yield t.After_Insert_Or_Paste_Or_Delete()}))}On_Keydown(e){return __awaiter(this,void 0,void 0,(function*(){e.stopPropagation();const t=e.target,n=this.divs_to_hooks.get(t);if(!e.repeat){const t=e.code;t!=Key.SHIFT_LEFT&&t!=Key.SHIFT_RIGHT&&t!=Key.CONTROL_LEFT&&t!=Key.CONTROL_RIGHT&&t!=Key.ALT_LEFT&&t!=Key.ALT_RIGHT&&this.held_keys.Add(e.code)}if(yield n.On_Key_Down(e),e.repeat){const s=this.Current_Layout().Maybe_Output(this.held_keys,e.shiftKey,e.getModifierState(Key.CAPS_LOCK));Utils.Is.String(s)?(e.preventDefault(),yield this.Send_Input_To_Selection(t,n,s)):s&&e.preventDefault()}else{const s=this.Current_Layout().Maybe_Space(this.held_keys);if(s instanceof Layout.Space.Instance)e.preventDefault(),this.held_keys.Clear();else if(s)e.preventDefault();else{const s=this.Current_Layout().Maybe_Output(this.held_keys,e.shiftKey,e.getModifierState(Key.CAPS_LOCK));Utils.Is.String(s)?(e.preventDefault(),yield this.Send_Input_To_Selection(t,n,s)):s&&e.preventDefault()}}}))}On_Keyup(e){return __awaiter(this,void 0,void 0,(function*(){e.stopPropagation();const t=e.target,n=this.divs_to_hooks.get(t);yield n.On_Key_Up(e),this.held_keys.Remove(e.code)}))}Before_Input(e){return __awaiter(this,void 0,void 0,(function*(){e.stopPropagation();const t=e.target,n=this.divs_to_hooks.get(t);if(0,0,0,"insertText"===e.inputType){e.preventDefault();const s=(e.data||"").replace(/ /g," "),i=e.getTargetRanges();0;const o=document.createRange();o.setStart(i[0].startContainer,i[0].startOffset),o.setEnd(i[0].endContainer,i[0].endOffset),yield n.On_Insert({div:t,data:s,range:o}),yield n.After_Insert_Or_Paste_Or_Delete()}else"insertFromPaste"===e.inputType?(yield n.On_Paste(e),yield n.After_Insert_Or_Paste_Or_Delete()):"deleteContentBackward"===e.inputType&&(yield n.On_Delete(e),yield n.After_Insert_Or_Paste_Or_Delete())}))}}let singleton=null;export function Singleton(){return null==singleton&&(singleton=new Instance),singleton}